{% extends "base.html" %}

{% block title %}Enhanced YouTube Shorts Creator{% endblock %}

{% block content %}
<div class="form-container enhanced-creator">
    <div class="section-header">
        <h3>Create Enhanced YouTube Shorts</h3>
        <span class="badge premium">AI-Powered</span>
    </div>
    
    {% if error_message %}
    <div class="feedback-message error">
        <i class="fas fa-exclamation-circle"></i>
        {{ error_message }}
    </div>
    {% endif %}
    
    {% if success_message %}
    <div class="feedback-message success">
        <i class="fas fa-check-circle"></i>
        {{ success_message }}
    </div>
    {% endif %}
    
    {% if dev_mode %}
    <div class="feedback-message info">
        <i class="fas fa-info-circle"></i>
        Running in Development Mode: Video processing and uploads will be simulated.
    </div>
    {% endif %}
    
    {% if not authenticated %}
    <div class="auth-required">
        <p>You need to authenticate with YouTube before creating Shorts.</p>
        <a href="/auth" class="btn primary">
            <i class="fab fa-youtube"></i> Authenticate with YouTube
        </a>
    </div>
    {% else %}
    
    <div class="enhanced-explanation">
        <p><strong>AI-Powered Shorts Creation</strong> - Transform your images into cinematic videos with
        AI-powered motion effects, synchronized perfectly to your music's beat. Select from various
        video styles or let our AI suggest the best style based on your content.</p>
    </div>
    
    <form action="/proxy/videos/enhanced" method="post" enctype="multipart/form-data" id="enhancedForm">
        <div class="form-group">
            <label for="music_track">Music Track</label>
            <select id="music_track" name="music_track" class="form-control" required>
                <option value="">Select a music track...</option>
                {% for track in tracks %}
                {% if track is string %}
                <option value="{{ track }}">{{ track }}</option>
                {% else %}
                <option value="{{ track.name }}" data-image="{{ track.image_url }}">{{ track.name }}</option>
                {% endif %}
                {% endfor %}
            </select>
            <div class="help-text">Select a music track for your enhanced Short</div>
            
            <div class="music-preview" id="musicPreview" style="display: none;">
                <div class="music-waveform">
                    <div class="waveform-placeholder" id="waveformPlaceholder"></div>
                </div>
                <div class="music-controls">
                    <button type="button" class="music-play-btn" id="playMusicBtn">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="music-info">
                        <div class="music-title" id="musicTitle"></div>
                        <div class="music-duration" id="musicDuration"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="imageUpload">Upload Images</label>
            <div class="upload-zone" id="uploadZone">
                <div class="upload-zone-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-zone-text">Drag and drop image files here</div>
                <div class="upload-zone-subtext">or click to browse files</div>
                <input type="file" name="images" id="imageUpload" multiple accept="image/*" required style="display: none;">
            </div>
            <div class="help-text">Upload images to create your Short (3-10 images recommended)</div>
            
            <div class="file-preview" id="filePreview"></div>
        </div>
        
        <div class="form-group style-selection">
            <label>Video Style</label>
            <div class="style-grid" id="styleGrid">
                <div class="style-loading">Loading styles...</div>
            </div>
            <input type="hidden" name="style" id="selectedStyle" value="">
            <div class="help-text">Select a style or <a href="#" id="suggestStyleBtn">let AI suggest one</a> based on your content</div>
        </div>
        
        <div class="form-group">
            <label for="description">Additional Description (Optional)</label>
            <textarea id="description" name="description" class="form-control" rows="2" placeholder="Describe any additional details you want in your video..."></textarea>
            <div class="help-text">Provide additional context to guide the AI video generation</div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-container">
                <input type="checkbox" name="use_runway" id="useRunway" value="true" checked>
                <span class="checkmark"></span>
                Use Runway ML for AI-powered enhancement
            </label>
            <div class="help-text">Enables advanced motion effects and transitions</div>
        </div>
        
        <div class="form-actions">
            <button type="button" class="btn secondary" id="previewBtn">
                <i class="fas fa-eye"></i> Preview Style
            </button>
            <button type="submit" class="btn primary" id="submitBtn">
                <i class="fas fa-magic"></i> Create Enhanced Short
            </button>
        </div>
    </form>
    {% endif %}
</div>

<div class="processing-dialog" id="processingDialog" style="display: none;">
    <div class="processing-content">
        <h4>Creating Your Enhanced Short</h4>
        <div class="loader"></div>
        <p id="processingMessage">AI is working on your video...</p>
        <div class="processing-steps">
            <div class="step active" id="step1">Analyzing music beats</div>
            <div class="step" id="step2">Applying style transformations</div>
            <div class="step" id="step3">Synchronizing with music</div>
            <div class="step" id="step4">Finalizing video</div>
        </div>
    </div>
</div>

<div class="style-preview-dialog" id="stylePreviewDialog" style="display: none;">
    <div class="style-preview-content">
        <h4>Style Preview</h4>
        <div class="style-preview-container" id="stylePreviewContainer">
            <img id="stylePreviewImage" src="" alt="Style Preview">
        </div>
        <p id="stylePreviewDescription"></p>
        <div class="dialog-actions">
            <button type="button" class="btn secondary" id="closePreviewBtn">Close</button>
            <button type="button" class="btn primary" id="useStyleBtn">Use This Style</button>
        </div>
    </div>
</div>

<div class="suggestion-dialog" id="suggestionDialog" style="display: none;">
    <div class="suggestion-content">
        <h4>AI Style Suggestion</h4>
        <div class="loader" id="suggestionLoader"></div>
        <div class="suggestion-result" id="suggestionResult" style="display: none;">
            <div class="suggestion-style-name" id="suggestedStyleName"></div>
            <p>Based on your music (tempo: <span id="suggestedTempo"></span> BPM) and images, we recommend this style.</p>
            <div class="music-analysis">
                <div class="analysis-item">
                    <div class="analysis-label">Beat Count</div>
                    <div class="analysis-value" id="beatCount"></div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Recommended Duration</div>
                    <div class="analysis-value" id="recommendedDuration"></div>
                </div>
                <div class="analysis-item">
                    <div class="analysis-label">Recommended Transition</div>
                    <div class="analysis-value" id="recommendedTransition"></div>
                </div>
            </div>
        </div>
        <div class="dialog-actions">
            <button type="button" class="btn secondary" id="cancelSuggestionBtn">Cancel</button>
            <button type="button" class="btn primary" id="applySuggestionBtn">Apply Suggestion</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .enhanced-creator {
        max-width: 800px;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .badge.premium {
        background-color: #0071e3;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        margin-left: 10px;
        font-size: 12px;
        font-weight: bold;
    }
    
    /* Add fallback styles in case the CSS variables aren't defined */
    :root {
        --accent-color: #0071e3;
        --primary-color: #0071e3;
        --primary-color-rgb: 0, 113, 227;
        --background-color: #f5f5f7;
        --text-color-light: #86868b;
        --border-color: #d2d2d7;
    }
    
    .enhanced-explanation {
        background-color: rgba(var(--primary-color-rgb), 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .style-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 10px;
    }
    
    .style-card {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
    }
    
    .style-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .style-card.selected {
        border: 2px solid var(--primary-color);
    }
    
    .style-image {
        width: 100%;
        height: 100px;
        object-fit: cover;
        background-color: var(--background-color);
    }
    
    .style-name {
        padding: 8px;
        text-align: center;
        font-weight: 500;
        background-color: white;
    }
    
    .processing-steps {
        margin-top: 20px;
        text-align: left;
    }
    
    .step {
        padding: 8px 0;
        color: var(--text-color-light);
        position: relative;
        padding-left: 25px;
    }
    
    .step:before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: var(--background-color);
        border: 2px solid var(--text-color-light);
    }
    
    .step.active {
        color: var(--primary-color);
        font-weight: 500;
    }
    
    .step.active:before {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .step.completed:before {
        background-color: var(--success-color);
        border-color: var(--success-color);
    }
    
    .style-preview-dialog,
    .suggestion-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .style-preview-content,
    .suggestion-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 500px;
        width: 90%;
    }
    
    .style-preview-container {
        margin: 20px 0;
        border-radius: 8px;
        overflow: hidden;
        max-height: 300px;
    }
    
    #stylePreviewImage {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
    }
    
    .dialog-actions {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
    }
    
    .suggestion-result {
        margin: 15px 0;
    }
    
    .suggestion-style-name {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 10px;
    }
    
    .music-analysis {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        text-align: left;
        flex-wrap: wrap;
    }
    
    .analysis-item {
        flex: 1;
        min-width: 100px;
        background-color: rgba(var(--primary-color-rgb), 0.1);
        padding: 10px;
        border-radius: 8px;
        margin: 5px;
    }
    
    .analysis-label {
        font-size: 12px;
        color: var(--text-color-light);
    }
    
    .analysis-value {
        font-weight: 600;
        margin-top: 5px;
    }
    
    /* Error Toast Styles */
    .error-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #ffebee;
        color: #f44336;
        border-radius: 4px;
        padding: 12px 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        max-width: 400px;
        animation: slide-in 0.3s ease-out;
    }
    
    @keyframes slide-in {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .toast-icon {
        font-size: 18px;
    }
    
    .toast-message {
        flex: 1;
        font-size: 14px;
    }
    
    .toast-close {
        background: none;
        border: none;
        color: #f44336;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    
    .toast-close:hover {
        opacity: 1;
    }
    
    .error-note {
        color: #f44336;
        background-color: #ffebee;
        padding: 8px 12px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize variables
    let selectedFiles = [];
    let audioPlayer = new Audio();
    let availableStyles = {};
    let currentStyle = null;
    let processingStepInterval;
    
    // Define default styles in case API call fails
    const defaultStyles = {
        "cinematic": {
            "name": "cinematic",
            "prompt_template": "Create a cinematic shot with subtle camera movement",
            "duration": 5,
            "transition": "fade"
        },
        "vlog": {
            "name": "vlog",
            "prompt_template": "Create a handheld vlog style shot with natural movement",
            "duration": 5, 
            "transition": "zoom"
        },
        "music_video": {
            "name": "music_video",
            "prompt_template": "Create a music video style shot with rhythmic movement",
            "duration": 5,
            "transition": "flash"
        }
    };
    
    // Fetch available styles when page loads
    fetch('/proxy/styles')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                throw new Error(`Invalid content type: ${contentType}`);
            }
        })
        .then(data => {
            if (data && data.styles) {
                availableStyles = data.styles;
                renderStyleGrid(availableStyles);
            } else {
                console.error('Received data has no styles property:', data);
                const styleGrid = document.getElementById('styleGrid');
                if (styleGrid) {
                    styleGrid.innerHTML = '<div class="error-message">Error loading styles: Invalid data format</div>';
                }
                // Fall back to default styles
                renderStyleGrid(defaultStyles);
            }
        })
        .catch(error => {
            console.error('Error fetching styles:', error);
            const styleGrid = document.getElementById('styleGrid');
            if (styleGrid) {
                styleGrid.innerHTML = `<div class="error-message">Error loading styles: ${error.message}</div>`;
            }
            // Fall back to default styles
            renderStyleGrid(defaultStyles);
        });
    
    // Render the style grid
    function renderStyleGrid(styles) {
        const styleGrid = document.getElementById('styleGrid');
        if (!styleGrid) {
            console.error('Style grid element not found');
            return;
        }
        
        styleGrid.innerHTML = '';
        
        if (!styles || Object.keys(styles).length === 0) {
            styleGrid.innerHTML = '<div class="error-message">No styles available</div>';
            return;
        }
        
        Object.keys(styles).forEach(styleKey => {
            const style = styles[styleKey];
            const card = document.createElement('div');
            card.className = 'style-card';
            card.dataset.style = styleKey;
            
            // Create a mock style image based on style name
            card.innerHTML = `
                <div class="style-image" 
                     style="background: linear-gradient(to bottom right, 
                           hsl(${styleKey.length * 20}, 70%, 60%), 
                           hsl(${styleKey.length * 30}, 70%, 40%)">
                </div>
                <div class="style-name">${styleKey}</div>
            `;
            
            card.addEventListener('click', () => selectStyle(styleKey));
            styleGrid.appendChild(card);
        });
    }
    
    // Select a style
    function selectStyle(styleKey) {
        if (!styleKey) {
            console.error('No style key provided');
            return;
        }
        
        // Update UI
        const styleCards = document.querySelectorAll('.style-card');
        if (styleCards.length > 0) {
            styleCards.forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.style === styleKey) {
                    card.classList.add('selected');
                }
            });
        }
        
        // Update selected style variables for consistency
        selectedStyle = styleKey;
        currentStyle = styleKey;
        
        // Update hidden input if it exists
        const selectedStyleInput = document.getElementById('selectedStyle');
        if (selectedStyleInput) {
            selectedStyleInput.value = styleKey;
        }
        
        // Update style details display
        const styleDetails = document.getElementById('styleDetails');
        if (styleDetails) {
            styleDetails.style.display = 'block';
            
            // Get style data
            const style = availableStyles[styleKey] || defaultStyles[styleKey] || {
                name: styleKey,
                prompt_template: 'Default prompt template',
                duration: 5,
                transition: 'fade'
            };
            
            // Update style details
            const styleName = document.getElementById('styleName');
            if (styleName && style && style.name) {
                styleName.textContent = style.name;
            }
            
            const stylePrompt = document.getElementById('stylePrompt');
            if (stylePrompt && style && style.prompt_template) {
                stylePrompt.textContent = style.prompt_template;
            }
            
            const styleDuration = document.getElementById('styleDuration');
            if (styleDuration && style && style.duration) {
                styleDuration.textContent = `${style.duration}s`;
            }
            
            const styleTransition = document.getElementById('styleTransition');
            if (styleTransition && style && style.transition) {
                styleTransition.textContent = style.transition;
            }
        }
    }
    
    // Preview style button
    document.getElementById('previewBtn').addEventListener('click', function() {
        const selectedStyle = document.getElementById('selectedStyle').value;
        if (!selectedStyle) {
            alert('Please select a style first');
            return;
        }
        
        const style = availableStyles[selectedStyle];
        if (!style) {
            showErrorToast('Style information not available. Please try again.');
            return;
        }
        
        const dialog = document.getElementById('stylePreviewDialog');
        const image = document.getElementById('stylePreviewImage');
        const description = document.getElementById('stylePreviewDescription');
        
        if (!dialog || !image || !description) {
            console.error('Preview elements not found in the DOM');
            return;
        }
        
        // Use the first uploaded image as preview if available
        if (selectedFiles.length > 0) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if (image && e.target) {
                    image.src = e.target.result;
                }
            };
            reader.readAsDataURL(selectedFiles[0]);
        } else {
            // Use a default image
            if (image) {
                image.src = `/static/img/style_${selectedStyle}.jpg`;
            }
        }
        
        // Show style description
        if (description && style.prompt_template) {
            description.textContent = style.prompt_template
                .replace('{description}', '')
                .trim();
        } else if (description) {
            description.textContent = 'Style description not available';
        }
        
        dialog.style.display = 'flex';
    });
    
    // Close preview dialog
    document.getElementById('closePreviewBtn').addEventListener('click', function() {
        document.getElementById('stylePreviewDialog').style.display = 'none';
    });
    
    // Use this style button
    document.getElementById('useStyleBtn').addEventListener('click', function() {
        document.getElementById('stylePreviewDialog').style.display = 'none';
    });
    
    // Suggest style button
    document.getElementById('suggestStyleBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        const musicTrack = document.getElementById('music_track').value;
        if (!musicTrack) {
            alert('Please select a music track first');
            return;
        }
        
        if (selectedFiles.length === 0) {
            alert('Please upload at least one image');
            return;
        }
        
        // Show suggestion dialog with loading state
        document.getElementById('suggestionDialog').style.display = 'flex';
        document.getElementById('suggestionLoader').style.display = 'block';
        document.getElementById('suggestionResult').style.display = 'none';
        
        // Create form data with selected files and music track
        const formData = new FormData();
        formData.append('music_track', musicTrack);
        selectedFiles.forEach(file => {
            formData.append('images', file);
        });
        
        // Send API request for style suggestion
        fetch('/proxy/suggest', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                throw new Error(`Invalid content type: ${contentType}`);
            }
        })
        .then(data => {
            // Hide loader and show results
            document.getElementById('suggestionLoader').style.display = 'none';
            document.getElementById('suggestionResult').style.display = 'block';
            
            // Update suggestion display
            document.getElementById('suggestedStyleName').textContent = data.suggested_style || 'cinematic';
            document.getElementById('suggestedTempo').textContent = data.tempo ? data.tempo.toFixed(1) : '120.0';
            document.getElementById('beatCount').textContent = data.beat_count || '32';
            document.getElementById('recommendedDuration').textContent = `${data.recommended_clip_duration || '5'}s`;
            document.getElementById('recommendedTransition').textContent = data.recommended_transition || 'fade';
        })
        .catch(error => {
            console.error('Error getting style suggestion:', error);
            document.getElementById('suggestionLoader').style.display = 'none';
            
            // Show fallback suggestion
            document.getElementById('suggestionResult').style.display = 'block';
            document.getElementById('suggestedStyleName').textContent = 'cinematic';
            document.getElementById('suggestedTempo').textContent = '120.0';
            document.getElementById('beatCount').textContent = '32';
            document.getElementById('recommendedDuration').textContent = '5s';
            document.getElementById('recommendedTransition').textContent = 'fade';
            
            // Add error message
            const errorNote = document.createElement('p');
            errorNote.className = 'error-note';
            errorNote.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error getting suggestion: ${error.message}. Using default style.`;
            document.getElementById('suggestionResult').appendChild(errorNote);
        });
    });
    
    // Apply suggestion button
    const applySuggestionBtn = document.getElementById('applySuggestionBtn');
    if (applySuggestionBtn) {
        applySuggestionBtn.addEventListener('click', function() {
            const suggestedStyle = document.getElementById('suggestedStyleName')?.textContent || 'cinematic';
            selectStyle(suggestedStyle);
            const suggestionDialog = document.getElementById('suggestionDialog');
            if (suggestionDialog) {
                suggestionDialog.style.display = 'none';
            }
        });
    }
    
    // Cancel suggestion button
    const cancelSuggestionBtn = document.getElementById('cancelSuggestionBtn');
    if (cancelSuggestionBtn) {
        cancelSuggestionBtn.addEventListener('click', function() {
            const suggestionDialog = document.getElementById('suggestionDialog');
            if (suggestionDialog) {
                suggestionDialog.style.display = 'none';
            }
        });
    }
    
    // Handle music track selection
    const musicTrackSelect = document.getElementById('music_track');
    if (musicTrackSelect) {
        musicTrackSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const selectedTrack = this.value;
            const imageUrl = selectedOption ? selectedOption.getAttribute('data-image') : null;
            const musicPreview = document.getElementById('musicPreview');
            
            if (selectedTrack) {
                const musicTitle = document.getElementById('musicTitle');
                if (musicTitle) musicTitle.textContent = selectedTrack;
                
                const musicDuration = document.getElementById('musicDuration');
                if (musicDuration) musicDuration.textContent = '~60 seconds';
                
                // In a real app, you'd load the actual audio file
                audioPlayer.src = `/mock-media/${selectedTrack}`;
                
                // If we have an image for this track, show it
                if (imageUrl) {
                    const waveformPlaceholder = document.getElementById('waveformPlaceholder');
                    if (waveformPlaceholder) {
                        // Clear existing content
                        waveformPlaceholder.innerHTML = '';
                        
                        // Add the album art if it exists
                        const albumArt = document.createElement('img');
                        albumArt.src = imageUrl;
                        albumArt.className = 'album-art';
                        albumArt.style.width = '100%';
                        albumArt.style.height = 'auto';
                        albumArt.style.maxHeight = '100px';
                        waveformPlaceholder.appendChild(albumArt);
                    }
                }
                
                // Show the music preview container
                if (musicPreview) musicPreview.style.display = 'block';
            } else if (musicPreview) {
                // Hide music preview if no track selected
                musicPreview.style.display = 'none';
            }
        });
    } else {
        console.error('Music track select element not found');
    }
    
    // Generate random bars for waveform visualization
    function generateWaveform() {
        const waveformPlaceholder = document.getElementById('waveformPlaceholder');
        waveformPlaceholder.innerHTML = '';
        
        const barCount = 50;
        for (let i = 0; i < barCount; i++) {
            const height = Math.floor(Math.random() * 40) + 10;
            const bar = document.createElement('div');
            bar.className = 'waveform-bar';
            bar.style.height = height + 'px';
            waveformPlaceholder.appendChild(bar);
        }
    }
    
    // Play/pause music preview
    document.getElementById('playMusicBtn').addEventListener('click', function() {
        const icon = this.querySelector('i');
        
        if (audioPlayer.paused) {
            audioPlayer.play().catch(e => {
                console.error('Error playing audio:', e);
                // In development mode, we don't have real audio files
                alert('Audio preview is simulated in development mode');
            });
            icon.className = 'fas fa-pause';
        } else {
            audioPlayer.pause();
            icon.className = 'fas fa-play';
        }
    });
    
    // Handle file upload zone
    const uploadZone = document.getElementById('uploadZone');
    const imageUpload = document.getElementById('imageUpload');
    const filePreview = document.getElementById('filePreview');
    
    uploadZone.addEventListener('click', function() {
        imageUpload.click();
    });
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        uploadZone.classList.add('active');
    }
    
    function unhighlight() {
        uploadZone.classList.remove('active');
    }
    
    uploadZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
    
    imageUpload.addEventListener('change', function() {
        handleFiles(this.files);
    });
    
    function handleFiles(files) {
        selectedFiles = [...files];
        updateFilePreview();
    }
    
    function updateFilePreview() {
        filePreview.innerHTML = '';
        
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.className = 'file-preview-item';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'file-preview-image';
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'file-preview-remove';
                removeBtn.innerHTML = '×';
                removeBtn.addEventListener('click', function() {
                    selectedFiles = selectedFiles.filter((_, i) => i !== index);
                    updateFilePreview();
                });
                
                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                filePreview.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        });
    }
    
    // Simulate processing steps
    function simulateProcessingSteps() {
        const steps = ['step1', 'step2', 'step3', 'step4'];
        let currentStep = 0;
        
        // Reset steps
        steps.forEach(step => {
            document.getElementById(step).classList.remove('active', 'completed');
        });
        document.getElementById(steps[0]).classList.add('active');
        
        // Start interval
        processingStepInterval = setInterval(() => {
            // Mark current step as completed
            document.getElementById(steps[currentStep]).classList.remove('active');
            document.getElementById(steps[currentStep]).classList.add('completed');
            
            // Move to next step
            currentStep++;
            if (currentStep < steps.length) {
                document.getElementById(steps[currentStep]).classList.add('active');
            } else {
                clearInterval(processingStepInterval);
            }
        }, 3000); // Move to next step every 3 seconds
    }
    
    // Form submission
    document.getElementById('enhancedForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const musicTrack = document.getElementById('music_track').value;
        const styleSelected = document.getElementById('selectedStyle').value;
        
        if (!musicTrack) {
            alert('Please select a music track');
            return;
        }
        
        if (selectedFiles.length === 0) {
            alert('Please upload at least one image');
            return;
        }
        
        if (!styleSelected) {
            alert('Please select a video style');
            return;
        }
        
        // Show processing dialog and start simulating steps
        document.getElementById('processingDialog').style.display = 'flex';
        document.getElementById('processingMessage').textContent = 
            `Creating your ${styleSelected} style video...`;
        simulateProcessingSteps();
        
        // Create FormData
        const formData = new FormData();
        formData.append('music_track', musicTrack);
        formData.append('style', styleSelected);
        formData.append('description', document.getElementById('description').value);
        formData.append('use_runway', document.getElementById('useRunway').checked);
        
        // Add all selected files
        selectedFiles.forEach(file => {
            formData.append('images', file);
        });
        
        // Submit the form via fetch
        fetch('/proxy/videos/enhanced', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                throw new Error(`Invalid content type: ${contentType}`);
            }
        })
        .then(data => {
            // Let the step animation complete
            setTimeout(() => {
                // Clear the interval if it's still running
                clearInterval(processingStepInterval);
                
                // Hide processing dialog
                document.getElementById('processingDialog').style.display = 'none';
                
                if (data.video_id) {
                    // Redirect to status page
                    window.location.href = `/status/${data.video_id}`;
                } else {
                    // Show error message
                    const errorMessage = data.error || 'Unknown error creating video';
                    showErrorToast(errorMessage);
                }
            }, 2000);
        })
        .catch(error => {
            clearInterval(processingStepInterval);
            document.getElementById('processingDialog').style.display = 'none';
            showErrorToast(`Error creating video: ${error.message}`);
        });
    });

    // Function to show error toast
    function showErrorToast(message) {
        const toast = document.createElement('div');
        toast.className = 'error-toast';
        toast.innerHTML = `
            <div class="toast-icon"><i class="fas fa-exclamation-circle"></i></div>
            <div class="toast-message">${message}</div>
            <button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
        `;
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }
</script>
{% endblock %} 