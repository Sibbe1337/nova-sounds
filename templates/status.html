{% extends "base.html" %}

{% block title %}Video Status{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/progress.css">
<link rel="stylesheet" href="/static/css/worker-status.css">
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-9">
            <div class="status-panel glass-panel">
                <div class="panel-header">
                    <h2>Video Status</h2>
                    {% if dev_mode %}
                    <span class="dev-badge">Dev Mode</span>
                    {% endif %}
                </div>
                
                <div class="panel-content py-4">
                    <div class="row">
                        <div class="col-md-6 status-col info-col">
                            <h3 class="status-title">{{ video.title }}</h3>
                            
                            <div class="status-info">
                                <div class="status-row">
                                    <div class="status-label">ID:</div>
                                    <div class="status-value">{{ video.id }}</div>
                                </div>
                                <div class="status-row">
                                    <div class="status-label">Upload Date:</div>
                                    <div class="status-value">{{ video.created_at }}</div>
                                </div>
                                <div class="status-row">
                                    <div class="status-label">Status:</div>
                                    <div class="status-value status-badge {{ video.status }}">
                                        {{ video.status|replace("_", " ")|title }}
                                    </div>
                                </div>
                                <div class="status-row">
                                    <div class="status-label">Music Track:</div>
                                    <div class="status-value">{{ video.music_track }}</div>
                                </div>
                                {% if video.youtube_id %}
                                <div class="status-row">
                                    <div class="status-label">YouTube ID:</div>
                                    <div class="status-value">
                                        <a href="https://www.youtube.com/watch?v={{ video.youtube_id }}" target="_blank" class="youtube-link">
                                            {{ video.youtube_id }}
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="status-actions mt-4">
                                {% if video.status == "uploaded" or video.status == "ready_for_upload" %}
                                <a href="/youtube/details/{{ video.id }}" class="btn btn-primary">
                                    <i class="fab fa-youtube"></i> View on YouTube
                                </a>
                                {% endif %}
                                
                                {% if video.status == "ready_for_upload" %}
                                <button class="btn btn-outline-primary" id="uploadToYouTubeBtn">
                                    <i class="fas fa-upload"></i> Upload to YouTube
                                </button>
                                {% endif %}
                                
                                {% if video.status == "failed" %}
                                <button class="btn btn-warning" id="retryProcessingBtn">
                                    <i class="fas fa-redo"></i> Retry Processing
                                </button>
                                {% endif %}
                                
                                <a href="/gallery" class="btn btn-outline-secondary">
                                    <i class="fas fa-images"></i> Gallery
                                </a>
                            </div>
                        </div>
                        
                        <div class="col-md-6 status-col preview-col">
                            {% if video.video_url %}
                            <div class="video-preview">
                                <video controls poster="/static/img/video-poster.svg">
                                    <source src="{{ video.video_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            {% elif video.status == "processing" %}
                            <div class="processing-container">
                                <div class="processing-animation">
                                    <div class="spinner-container">
                                        <div class="spinner"></div>
                                    </div>
                                    <div class="processing-text">Processing your video</div>
                                </div>
                            </div>
                            {% else %}
                            <div class="placeholder-preview">
                                <i class="fas fa-film placeholder-icon"></i>
                                <p>Video preview not available</p>
                                {% if video.error_message %}
                                <div class="error-message">
                                    <p><i class="fas fa-exclamation-triangle"></i> {{ video.error_message }}</p>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            {% if video.status == "processing" %}
            <div class="progress-tracker glass-panel mt-4">
                <div class="panel-header">
                    <h2>Processing Progress</h2>
                </div>
                
                <div class="panel-content py-4">
                    <div class="progress-container">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="processingProgressBar" style="width: 0%;"></div>
                        </div>
                        <div class="progress-status">
                            <span id="processingStatus">Starting video processing...</span>
                            <span id="processingPercentage">0%</span>
                        </div>
                    </div>
                    
                    <div class="progress-steps">
                        <div class="progress-step" data-step="prepare">
                            <div class="step-indicator">
                                <div class="step-icon">
                                    <i class="fas fa-file-import"></i>
                                </div>
                                <div class="step-line"></div>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Preparing</div>
                                <div class="step-desc">Setting up resources</div>
                            </div>
                        </div>
                        
                        <div class="progress-step" data-step="process">
                            <div class="step-indicator">
                                <div class="step-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div class="step-line"></div>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Processing</div>
                                <div class="step-desc">Creating video</div>
                            </div>
                        </div>
                        
                        <div class="progress-step" data-step="optimize">
                            <div class="step-indicator">
                                <div class="step-icon">
                                    <i class="fas fa-sliders-h"></i>
                                </div>
                                <div class="step-line"></div>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Optimizing</div>
                                <div class="step-desc">Enhancing quality</div>
                            </div>
                        </div>
                        
                        <div class="progress-step" data-step="finalize">
                            <div class="step-indicator">
                                <div class="step-icon">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            <div class="step-content">
                                <div class="step-title">Finalizing</div>
                                <div class="step-desc">Saving video</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if video.export_jobs %}
            <div class="export-status glass-panel mt-4">
                <div class="panel-header">
                    <h2>Export Status</h2>
                </div>
                
                <div class="panel-content py-4">
                    <div class="export-list">
                        {% for job_id, job in video.export_jobs.items() %}
                        <div class="export-item">
                            <div class="export-header">
                                <div class="export-title">
                                    Export #{{ loop.index }} - {{ job.started_at }}
                                </div>
                                <div class="export-status-badge {{ job.status }}">
                                    {{ job.status|title }}
                                </div>
                            </div>
                            <div class="export-platforms">
                                {% for platform in job.platforms %}
                                <span class="platform-badge">
                                    {% if platform == "youtube" %}
                                    <i class="fab fa-youtube"></i>
                                    {% elif platform == "tiktok" %}
                                    <i class="fab fa-tiktok"></i>
                                    {% elif platform == "instagram" %}
                                    <i class="fab fa-instagram"></i>
                                    {% elif platform == "facebook" %}
                                    <i class="fab fa-facebook"></i>
                                    {% else %}
                                    <i class="fas fa-share-alt"></i>
                                    {% endif %}
                                    {{ platform|title }}
                                </span>
                                {% endfor %}
                            </div>
                            
                            {% if job.platform_results %}
                            <div class="platform-results">
                                {% for platform, result in job.platform_results.items() %}
                                <div class="platform-result">
                                    <div class="platform-name">
                                        {% if platform == "youtube" %}
                                        <i class="fab fa-youtube"></i>
                                        {% elif platform == "tiktok" %}
                                        <i class="fab fa-tiktok"></i>
                                        {% elif platform == "instagram" %}
                                        <i class="fab fa-instagram"></i>
                                        {% elif platform == "facebook" %}
                                        <i class="fab fa-facebook"></i>
                                        {% else %}
                                        <i class="fas fa-share-alt"></i>
                                        {% endif %}
                                        {{ platform|title }}:
                                    </div>
                                    {% if result.status == "success" %}
                                    <div class="result-content success">
                                        <span class="result-badge success">Success</span>
                                        {% if result.url %}
                                        <a href="{{ result.url }}" target="_blank" class="result-link">
                                            View <i class="fas fa-external-link-alt"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <div class="result-content failure">
                                        <span class="result-badge failure">Failed</span>
                                        <span class="result-error">{{ result.error }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-lg-3">
            <div class="worker-status-section" id="worker-status-container">
                <!-- Worker status will be loaded here -->
            </div>
            
            <div class="share-card glass-panel">
                <div class="panel-header">
                    <h3>Share</h3>
                </div>
                <div class="panel-content">
                    <div class="share-buttons">
                        <button class="share-btn facebook">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button class="share-btn twitter">
                            <i class="fab fa-twitter"></i>
                        </button>
                        <button class="share-btn instagram">
                            <i class="fab fa-instagram"></i>
                        </button>
                        <button class="share-btn reddit">
                            <i class="fab fa-reddit-alien"></i>
                        </button>
                        <button class="share-btn copy" id="copyLinkBtn">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                    
                    <div class="copied-message" id="copiedMessage">Link copied to clipboard!</div>
                </div>
            </div>
            
            <div class="recommendations-card glass-panel mt-4">
                <div class="panel-header">
                    <h3>Recommendations</h3>
                </div>
                <div class="panel-content">
                    <h4 class="rec-title">Try These Enhancements</h4>
                    
                    <div class="rec-list">
                        <div class="rec-item">
                            <i class="fas fa-magic rec-icon"></i>
                            <div class="rec-content">
                                <div class="rec-name">Add Transitions</div>
                                <div class="rec-desc">Smooth transitions between scenes</div>
                            </div>
                        </div>
                        
                        <div class="rec-item">
                            <i class="fas fa-text-height rec-icon"></i>
                            <div class="rec-content">
                                <div class="rec-name">Add Text Overlays</div>
                                <div class="rec-desc">Overlay text for better engagement</div>
                            </div>
                        </div>
                        
                        <div class="rec-item">
                            <i class="fas fa-tools rec-icon"></i>
                            <div class="rec-content">
                                <div class="rec-name">Use AI Enhancements</div>
                                <div class="rec-desc">Try our advanced AI tools</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/progress.js"></script>
<script src="/static/js/worker-status.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize copy link button
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const copiedMessage = document.getElementById('copiedMessage');
        
        if (copyLinkBtn) {
            copyLinkBtn.addEventListener('click', function() {
                const tempInput = document.createElement('input');
                document.body.appendChild(tempInput);
                tempInput.value = window.location.href;
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                // Show copied message
                copiedMessage.style.display = 'block';
                setTimeout(function() {
                    copiedMessage.style.display = 'none';
                }, 2000);
            });
        }
        
        // Initialize worker status
        const workerStatus = new WorkerStatus({
            containerId: 'worker-status-container',
            apiUrl: '/api/worker-status',
            refreshInterval: 5000
        });
        
        // Initialize progress tracking for processing videos
        {% if video.status == "processing" %}
        const progressTracker = new ProgressTracker({
            videoId: '{{ video.id }}',
            pollingInterval: 2000,
            onStatusChange: function(status) {
                if (status === 'ready_for_upload' || status === 'uploaded') {
                    window.location.reload();
                }
            }
        });
        progressTracker.start();
        {% endif %}
        
        // Initialize retry processing button
        const retryBtn = document.getElementById('retryProcessingBtn');
        if (retryBtn) {
            retryBtn.addEventListener('click', function() {
                fetch('/api/videos/{{ video.id }}/retry', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error retrying: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error retrying processing');
                });
            });
        }
        
        // Initialize upload to YouTube button
        const uploadBtn = document.getElementById('uploadToYouTubeBtn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', function() {
                if (confirm('Upload this video to YouTube?')) {
                    fetch('/api/videos/{{ video.id }}/upload_to_youtube', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Error uploading: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error uploading to YouTube');
                    });
                }
            });
        }
    });
</script>
{% endblock %} 