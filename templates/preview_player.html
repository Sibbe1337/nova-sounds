{% extends "base.html" %}

{% block title %}Video Preview | Nova Sounds Shorts Machine{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="section-title mb-4">Preview Player</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            <!-- Video information card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 id="videoTitle">{{ video.title if video else 'Video Preview' }}</h5>
                    <div class="video-stats">
                        <span class="badge bg-secondary me-2">
                            <i class="fas fa-calendar me-1"></i> {{ video.created_at|date if video and video.created_at else 'New' }}
                        </span>
                        <span class="badge bg-primary">
                            <i class="fas fa-clock me-1"></i> {{ video.duration if video and video.duration else '0:00' }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Layout Toggle Buttons -->
                    <div class="layout-toggle-container mb-3 text-center">
                        <div class="btn-group" role="group" aria-label="Layout Options">
                            <button type="button" class="btn btn-outline-primary active" data-aspect-ratio="9:16" id="tiktokLayout">
                                <i class="fab fa-tiktok me-1"></i> TikTok/Shorts (9:16)
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-aspect-ratio="16:9" id="youtubeLayout">
                                <i class="fab fa-youtube me-1"></i> YouTube (16:9)
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-aspect-ratio="1:1" id="instagramLayout">
                                <i class="fab fa-instagram me-1"></i> Instagram (1:1)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Video Preview Container -->
                    <div class="video-preview-container ratio-9x16" id="videoPreviewContainer">
                        {% if video and video.url %}
                            <video id="videoPlayer" controls poster="{{ video.thumbnail_url if video.thumbnail_url else '' }}" preload="metadata">
                                <source src="{{ video.url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        {% else %}
                            <div class="no-video-placeholder">
                                <i class="fas fa-film fa-3x mb-3"></i>
                                <h5>No video selected</h5>
                                <p>Please select a video to preview or upload a new one</p>
                                <div class="mt-3">
                                    <a href="/videos" class="btn btn-primary me-2">
                                        <i class="fas fa-photo-video me-1"></i> View Your Videos
                                    </a>
                                    <a href="/enhanced" class="btn btn-outline-primary">
                                        <i class="fas fa-plus me-1"></i> Create New Video
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Video Controls and Info -->
                    {% if video and video.url %}
                    <div class="video-controls mt-3">
                        <div class="row align-items-center">
                            <div class="col-md-7">
                                <div class="video-playback-controls">
                                    <button class="btn btn-sm btn-outline-secondary me-2" id="playbackSpeedBtn">
                                        <i class="fas fa-tachometer-alt me-1"></i> 1x
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary me-2" id="muteBtn">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary me-2" id="fullscreenBtn">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                    <div class="dropdown d-inline-block">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="qualitySelector" data-bs-toggle="dropdown" aria-expanded="false">
                                            Quality
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="qualitySelector">
                                            <li><a class="dropdown-item quality-option" href="#" data-quality="1080p">1080p HD</a></li>
                                            <li><a class="dropdown-item quality-option" href="#" data-quality="720p">720p HD</a></li>
                                            <li><a class="dropdown-item quality-option" href="#" data-quality="480p">480p</a></li>
                                            <li><a class="dropdown-item quality-option" href="#" data-quality="360p">360p</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-5 text-md-end mt-3 mt-md-0">
                                <a href="{{ video.url }}" download class="btn btn-sm btn-outline-primary me-2">
                                    <i class="fas fa-download me-1"></i> Download
                                </a>
                                <a href="/export?video={{ video.id }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-share-alt me-1"></i> Share/Export
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Video Metadata panel -->
            {% if video %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Video Metadata</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl>
                                <dt>Title</dt>
                                <dd>{{ video.title }}</dd>
                                
                                <dt>Style</dt>
                                <dd>{{ video.style }}</dd>
                                
                                <dt>Music Track</dt>
                                <dd>{{ video.music_track }}</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl>
                                <dt>Resolution</dt>
                                <dd>{{ video.width }}x{{ video.height }} ({{ video.aspect_ratio }})</dd>
                                
                                <dt>Size</dt>
                                <dd>{{ video.file_size|filesizeformat }}</dd>
                                
                                <dt>Creation Date</dt>
                                <dd>{{ video.created_at|date }}</dd>
                            </dl>
                        </div>
                    </div>
                    {% if video.description %}
                    <h6 class="border-top pt-3 mt-3">Description</h6>
                    <p>{{ video.description }}</p>
                    {% endif %}
                    
                    {% if video.hashtags %}
                    <h6 class="border-top pt-3 mt-3">Hashtags</h6>
                    <p>{{ video.hashtags }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Related Videos -->
            {% if related_videos and related_videos|length > 0 %}
            <div class="card">
                <div class="card-header">
                    <h5>Related Videos</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for related in related_videos %}
                        <a href="/preview?video={{ related.id }}" class="list-group-item list-group-item-action d-flex align-items-center">
                            <div class="video-thumbnail me-3">
                                <img src="{{ related.thumbnail_url }}" alt="{{ related.title }}" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;">
                            </div>
                            <div class="video-info flex-grow-1">
                                <h6 class="mb-1">{{ related.title }}</h6>
                                <small class="text-muted">
                                    {{ related.duration }} • {{ related.created_at|date }}
                                </small>
                            </div>
                            <div class="video-style">
                                <span class="badge bg-secondary">{{ related.style }}</span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Playback Speed Modal -->
<div class="modal fade" id="playbackSpeedModal" tabindex="-1" aria-labelledby="playbackSpeedModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="playbackSpeedModalLabel">Playback Speed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <button type="button" class="list-group-item list-group-item-action speed-option" data-speed="0.25">0.25x</button>
                    <button type="button" class="list-group-item list-group-item-action speed-option" data-speed="0.5">0.5x</button>
                    <button type="button" class="list-group-item list-group-item-action speed-option" data-speed="0.75">0.75x</button>
                    <button type="button" class="list-group-item list-group-item-action speed-option active" data-speed="1">1x (Normal)</button>
                    <button type="button" class="list-group-item list-group-item-action speed-option" data-speed="1.25">1.25x</button>
                    <button type="button" class="list-group-item list-group-item-action speed-option" data-speed="1.5">1.5x</button>
                    <button type="button" class="list-group-item list-group-item-action speed-option" data-speed="2">2x</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Preview Player specific styles */
    .video-preview-container {
        position: relative;
        width: 100%;
        background-color: #000;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        margin: 0 auto;
    }
    
    /* Aspect ratio containers */
    .ratio-9x16 {
        padding-top: 177.78%; /* 9:16 aspect ratio */
        max-width: 405px; /* 9:16 with 720px height would be 405px wide */
    }
    
    .ratio-16x9 {
        padding-top: 56.25%; /* 16:9 aspect ratio */
        max-width: 720px; /* Standard 720p width */
    }
    
    .ratio-1x1 {
        padding-top: 100%; /* 1:1 aspect ratio */
        max-width: 500px; /* Square with reasonable size */
    }
    
    #videoPlayer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        background-color: #000;
    }
    
    .no-video-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        color: #6c757d;
        text-align: center;
        padding: 2rem;
    }
    
    .video-playback-controls .btn {
        padding: 0.375rem 0.75rem;
    }
    
    .dropdown-menu.show {
        min-width: 100px;
    }
    
    .quality-option.active::before,
    .speed-option.active::before {
        content: "✓ ";
    }
    
    /* Layout toggle buttons */
    .layout-toggle-container {
        margin-bottom: 1.5rem;
    }
    
    .layout-toggle-container .btn-group {
        width: 100%;
    }
    
    .layout-toggle-container .btn {
        flex: 1;
    }
    
    /* Mobile optimizations */
    @media (max-width: 576px) {
        .video-controls .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .layout-toggle-container .btn {
            padding: 0.375rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .layout-toggle-container .btn i {
            margin-right: 0 !important;
        }
        
        .video-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const videoPlayer = document.getElementById('videoPlayer');
    const videoPreviewContainer = document.getElementById('videoPreviewContainer');
    const layoutButtons = document.querySelectorAll('.layout-toggle-container button');
    const playbackSpeedBtn = document.getElementById('playbackSpeedBtn');
    const speedOptions = document.querySelectorAll('.speed-option');
    const qualityOptions = document.querySelectorAll('.quality-option');
    const muteBtn = document.getElementById('muteBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    
    // Playback Speed Modal
    const playbackSpeedModal = new bootstrap.Modal(document.getElementById('playbackSpeedModal'));
    
    // Current state
    let currentSpeed = 1;
    let currentAspectRatio = '9:16';
    
    // Initialize
    function init() {
        // Set up layout toggle buttons
        layoutButtons.forEach(button => {
            button.addEventListener('click', function() {
                const aspectRatio = this.dataset.aspectRatio;
                changeAspectRatio(aspectRatio);
                
                // Update active button
                layoutButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Set up playback speed button
        if (playbackSpeedBtn) {
            playbackSpeedBtn.addEventListener('click', function() {
                playbackSpeedModal.show();
            });
        }
        
        // Set up speed options
        speedOptions.forEach(option => {
            option.addEventListener('click', function() {
                const speed = parseFloat(this.dataset.speed);
                changePlaybackSpeed(speed);
                
                // Update active option
                speedOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                
                // Close modal
                playbackSpeedModal.hide();
            });
        });
        
        // Set up quality options
        qualityOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const quality = this.dataset.quality;
                
                // Update active option
                qualityOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                
                // Show quality change notification
                showToast(`Quality changed to ${quality}`);
            });
        });
        
        // Set up mute button
        if (muteBtn && videoPlayer) {
            muteBtn.addEventListener('click', toggleMute);
        }
        
        // Set up fullscreen button
        if (fullscreenBtn && videoPlayer) {
            fullscreenBtn.addEventListener('click', toggleFullscreen);
        }
        
        // Initialize video player if it exists
        if (videoPlayer) {
            videoPlayer.addEventListener('play', function() {
                console.log('Video playback started');
            });
            
            videoPlayer.addEventListener('pause', function() {
                console.log('Video playback paused');
            });
            
            videoPlayer.addEventListener('ended', function() {
                console.log('Video playback ended');
            });
        }
        
        // Restore saved aspect ratio if available
        const savedAspectRatio = sessionStorage.getItem('preferredAspectRatio');
        if (savedAspectRatio) {
            changeAspectRatio(savedAspectRatio);
            
            // Update active button
            layoutButtons.forEach(btn => {
                if (btn.dataset.aspectRatio === savedAspectRatio) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
    }
    
    // Function to change aspect ratio
    function changeAspectRatio(aspectRatio) {
        if (!videoPreviewContainer) return;
        
        // Remove current aspect ratio class
        videoPreviewContainer.classList.remove('ratio-9x16', 'ratio-16x9', 'ratio-1x1');
        
        // Add new aspect ratio class
        switch (aspectRatio) {
            case '16:9':
                videoPreviewContainer.classList.add('ratio-16x9');
                break;
            case '1:1':
                videoPreviewContainer.classList.add('ratio-1x1');
                break;
            default: // 9:16
                videoPreviewContainer.classList.add('ratio-9x16');
                aspectRatio = '9:16';
                break;
        }
        
        // Update current aspect ratio
        currentAspectRatio = aspectRatio;
        
        // Save preference
        sessionStorage.setItem('preferredAspectRatio', aspectRatio);
        
        // Show notification
        showToast(`Changed aspect ratio to ${aspectRatio}`);
    }
    
    // Function to change playback speed
    function changePlaybackSpeed(speed) {
        if (!videoPlayer) return;
        
        // Set playback rate
        videoPlayer.playbackRate = speed;
        
        // Update current speed
        currentSpeed = speed;
        
        // Update button text
        playbackSpeedBtn.innerHTML = `<i class="fas fa-tachometer-alt me-1"></i> ${speed}x`;
        
        // Show notification
        showToast(`Playback speed: ${speed}x`);
    }
    
    // Function to toggle mute
    function toggleMute() {
        if (!videoPlayer) return;
        
        videoPlayer.muted = !videoPlayer.muted;
        
        // Update button icon
        if (videoPlayer.muted) {
            muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
        } else {
            muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
        }
    }
    
    // Function to toggle fullscreen
    function toggleFullscreen() {
        if (!videoPlayer) return;
        
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            videoPlayer.requestFullscreen().catch(err => {
                console.error('Error attempting to enable fullscreen:', err);
            });
        }
    }
    
    // Function to show a toast notification
    function showToast(message, type = 'info') {
        // Create toast element if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Set toast class based on type
        let bgClass = 'bg-primary text-white';
        if (type === 'success') bgClass = 'bg-success text-white';
        if (type === 'warning') bgClass = 'bg-warning text-dark';
        if (type === 'error') bgClass = 'bg-danger text-white';
        
        // Create new toast
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast ${bgClass}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Initialize and show the toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 2000 });
        toast.show();
        
        // Remove toast after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    // Initialize the component
    init();
});
</script>
{% endblock %} 