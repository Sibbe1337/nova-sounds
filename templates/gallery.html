{% extends "base.html" %}

{% block title %}Video Gallery - YouTube Shorts Machine{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/video-player.css">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Your Video Gallery</h1>
    <p class="subtitle">View, manage, and publish your created videos</p>
</div>

<div class="gallery-actions">
    <div class="gallery-filters">
        <button class="btn secondary active" data-filter="all">All Videos</button>
        <button class="btn secondary" data-filter="processing">Processing</button>
        <button class="btn secondary" data-filter="ready">Ready to Upload</button>
        <button class="btn secondary" data-filter="uploaded">Uploaded</button>
    </div>
    <div class="gallery-sort">
        <label for="sort-select">Sort by:</label>
        <select id="sort-select" class="sort-select">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="popular">Most Popular</option>
        </select>
    </div>
</div>

<div class="gallery-grid">
    {% if videos %}
        {% for video in videos %}
        <div class="gallery-item" data-status="{{ video.status }}">
            <div class="gallery-item-media">
                {% if video.status == "processing" %}
                    <div class="gallery-placeholder processing">
                        <div class="placeholder-icon">
                            <i class="fas fa-cog fa-spin"></i>
                        </div>
                        <div class="placeholder-text">Processing...</div>
                    </div>
                {% elif video.status == "failed" %}
                    <div class="gallery-placeholder failed">
                        <div class="placeholder-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="placeholder-text">Processing Failed</div>
                    </div>
                {% else %}
                    <div class="video-container" id="video-{{ video.id }}">
                        <!-- Video player will be initialized here -->
                    </div>
                {% endif %}
            </div>
            <div class="gallery-content">
                <h3 class="gallery-title">{{ video.title or "Untitled Video" }}</h3>
                <div class="gallery-meta">
                    <span class="gallery-date">{{ video.created_at|format_date }}</span>
                    <span class="gallery-track">{{ video.music_track }}</span>
                </div>
                <div class="gallery-status">
                    <span class="status-badge {{ video.status }}">{{ video.status|title|replace('_', ' ') }}</span>
                </div>
                <div class="gallery-actions">
                    {% if video.status == "ready_for_upload" or video.status == "ready" %}
                        <a href="/youtube/upload?video_id={{ video.id }}" class="btn primary">
                            <i class="fab fa-youtube"></i> Upload to YouTube
                        </a>
                    {% elif video.status == "uploaded" %}
                        <a href="https://youtube.com/shorts/{{ video.youtube_id }}" target="_blank" class="btn primary">
                            <i class="fas fa-external-link-alt"></i> View on YouTube
                        </a>
                    {% elif video.status == "failed" %}
                        <a href="/status/{{ video.id }}" class="btn secondary">
                            <i class="fas fa-info-circle"></i> View Details
                        </a>
                    {% else %}
                        <a href="/status/{{ video.id }}" class="btn secondary">
                            <i class="fas fa-spinner fa-spin"></i> View Progress
                        </a>
                    {% endif %}
                    
                    <button class="btn secondary delete-btn" data-video-id="{{ video.id }}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-videos">
            <div class="no-videos-icon">
                <i class="fas fa-film"></i>
            </div>
            <h3>No Videos Yet</h3>
            <p>Create your first video to see it here</p>
            <a href="/" class="btn primary">Create a Video</a>
        </div>
    {% endif %}
</div>

<!-- Video Preview Modal -->
<div class="video-modal" id="videoModal">
    <div class="video-modal-content">
        <button class="video-modal-close" id="closeModal">
            <i class="fas fa-times"></i>
        </button>
        <div class="video-modal-player" id="modalPlayer"></div>
        <div class="video-modal-info">
            <h3 class="video-modal-title" id="modalTitle"></h3>
            <div class="video-modal-meta" id="modalMeta"></div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="confirm-modal" id="deleteModal">
    <div class="confirm-modal-content">
        <h3>Delete Video?</h3>
        <p>Are you sure you want to delete this video? This action cannot be undone.</p>
        <div class="confirm-modal-actions">
            <button class="btn secondary" id="cancelDelete">Cancel</button>
            <button class="btn danger" id="confirmDelete">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/video-player.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize video players
        const videoData = {% if videos %}{{ videos|tojson }}{% else %}[]{% endif %};
        let players = {};
        
        videoData.forEach(video => {
            // Only initialize players for completed videos
            if (video.status !== 'processing' && video.status !== 'failed') {
                const containerId = `video-${video.id}`;
                const container = document.getElementById(containerId);
                
                if (container) {
                    // Use video URL from the video object, or a fallback for development
                    const videoUrl = video.video_url || `/mock-media/videos/${video.id}.mp4`;
                    const posterUrl = video.thumbnail_url || `/mock-media/thumbnails/${video.id}.jpg`;
                    
                    // Initialize player
                    players[video.id] = new VideoPlayer({
                        containerId: containerId,
                        videoUrl: videoUrl,
                        posterUrl: posterUrl,
                        muted: true, // Start muted for better UX
                        onPlay: () => {
                            // Pause other videos when one starts playing
                            Object.entries(players).forEach(([id, player]) => {
                                if (id !== video.id && player) {
                                    player.pause();
                                }
                            });
                        }
                    });
                }
            }
        });
        
        // Filtering functionality
        const filterButtons = document.querySelectorAll('.gallery-filters button');
        const galleryItems = document.querySelectorAll('.gallery-item');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Update active button
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Get filter value
                const filter = button.getAttribute('data-filter');
                
                // Filter gallery items
                galleryItems.forEach(item => {
                    if (filter === 'all' || item.getAttribute('data-status') === filter) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });
        
        // Sorting functionality
        const sortSelect = document.getElementById('sort-select');
        const galleryGrid = document.querySelector('.gallery-grid');
        
        if (sortSelect && galleryGrid) {
            sortSelect.addEventListener('change', () => {
                const sortValue = sortSelect.value;
                const items = Array.from(galleryItems);
                
                items.sort((a, b) => {
                    const dateA = new Date(a.querySelector('.gallery-date').textContent);
                    const dateB = new Date(b.querySelector('.gallery-date').textContent);
                    
                    if (sortValue === 'newest') {
                        return dateB - dateA;
                    } else if (sortValue === 'oldest') {
                        return dateA - dateB;
                    }
                    // Additional sorting options could be implemented here
                    return 0;
                });
                
                // Reorder items in the DOM
                items.forEach(item => {
                    galleryGrid.appendChild(item);
                });
            });
        }
        
        // Video modal functionality
        const videoModal = document.getElementById('videoModal');
        const closeModal = document.getElementById('closeModal');
        const modalPlayer = document.getElementById('modalPlayer');
        const modalTitle = document.getElementById('modalTitle');
        const modalMeta = document.getElementById('modalMeta');
        let modalVideoPlayer = null;
        
        // Open modal when clicking on a video
        if (videoModal && closeModal && modalPlayer) {
            galleryItems.forEach(item => {
                const videoContainer = item.querySelector('.video-container');
                if (videoContainer) {
                    videoContainer.addEventListener('click', () => {
                        const videoId = videoContainer.id.replace('video-', '');
                        const video = videoData.find(v => v.id === videoId);
                        
                        if (video) {
                            // Set modal content
                            modalTitle.textContent = video.title || 'Untitled Video';
                            modalMeta.textContent = `${video.music_track} â€¢ ${new Date(video.created_at).toLocaleDateString()}`;
                            
                            // Initialize modal player
                            if (modalVideoPlayer) {
                                modalVideoPlayer = null;
                            }
                            
                            modalPlayer.innerHTML = '';
                            modalVideoPlayer = new VideoPlayer({
                                containerId: 'modalPlayer',
                                videoUrl: video.video_url || `/mock-media/videos/${video.id}.mp4`,
                                posterUrl: video.thumbnail_url || `/mock-media/thumbnails/${video.id}.jpg`,
                                autoplay: true
                            });
                            
                            // Show modal
                            videoModal.classList.add('active');
                            document.body.style.overflow = 'hidden';
                        }
                    });
                }
            });
            
            // Close modal
            closeModal.addEventListener('click', () => {
                videoModal.classList.remove('active');
                document.body.style.overflow = '';
                
                // Stop video playback
                if (modalVideoPlayer) {
                    modalVideoPlayer.pause();
                }
            });
            
            // Close modal on background click
            videoModal.addEventListener('click', (e) => {
                if (e.target === videoModal) {
                    closeModal.click();
                }
            });
        }
        
        // Escape key to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && videoModal && videoModal.classList.contains('active')) {
                closeModal.click();
            }
        });
        
        // Delete functionality
        const deleteButtons = document.querySelectorAll('.delete-btn');
        const deleteModal = document.getElementById('deleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');
        let currentVideoId = null;
        
        if (deleteModal && cancelDelete && confirmDelete) {
            deleteButtons.forEach(button => {
                button.addEventListener('click', () => {
                    currentVideoId = button.getAttribute('data-video-id');
                    deleteModal.classList.add('active');
                });
            });
            
            cancelDelete.addEventListener('click', () => {
                deleteModal.classList.remove('active');
                currentVideoId = null;
            });
            
            confirmDelete.addEventListener('click', async () => {
                if (currentVideoId) {
                    try {
                        // Call API to delete video
                        const response = await fetch(`/api/videos/${currentVideoId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            // Remove the video from the UI
                            const item = document.querySelector(`.gallery-item[data-video-id="${currentVideoId}"]`);
                            if (item) {
                                item.remove();
                            }
                            
                            // Check if there are no videos left
                            if (document.querySelectorAll('.gallery-item').length === 0) {
                                location.reload(); // Reload to show the "No Videos" message
                            }
                        } else {
                            console.error('Failed to delete video');
                        }
                    } catch (error) {
                        console.error('Error deleting video:', error);
                    }
                    
                    deleteModal.classList.remove('active');
                    currentVideoId = null;
                }
            });
            
            // Close delete modal on background click
            deleteModal.addEventListener('click', (e) => {
                if (e.target === deleteModal) {
                    cancelDelete.click();
                }
            });
            
            // Escape key to close delete modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && deleteModal.classList.contains('active')) {
                    cancelDelete.click();
                }
            });
        }
    });
</script>

<style>
    /* Gallery styles */
    .page-header {
        text-align: center;
        margin-bottom: var(--spacing-xl);
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        background: linear-gradient(90deg, var(--primary-color), #6366f1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .subtitle {
        font-size: 1.2rem;
        color: var(--text-light);
    }
    
    .gallery-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }
    
    .gallery-filters {
        display: flex;
        gap: var(--spacing-sm);
    }
    
    .gallery-filters button {
        padding: var(--spacing-sm) var(--spacing-md);
    }
    
    .gallery-filters button.active {
        background-color: var(--primary-color);
        color: white;
    }
    
    .gallery-sort {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .sort-select {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
        background-color: var(--card-bg);
        color: var(--text-color);
    }
    
    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xxl);
    }
    
    .gallery-item {
        background-color: var(--card-bg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        border: 1px solid var(--border-color);
    }
    
    .gallery-item:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .gallery-item-media {
        position: relative;
        aspect-ratio: 9/16;
        background-color: #000;
        cursor: pointer;
    }
    
    .gallery-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 0, 0.1);
        color: var(--text-light);
    }
    
    .gallery-placeholder.processing {
        background-color: rgba(var(--primary-color-rgb), 0.1);
    }
    
    .gallery-placeholder.failed {
        background-color: rgba(255, 59, 48, 0.1);
    }
    
    .placeholder-icon {
        font-size: 2rem;
        margin-bottom: var(--spacing-sm);
    }
    
    .gallery-placeholder.processing .placeholder-icon {
        color: var(--primary-color);
    }
    
    .gallery-placeholder.failed .placeholder-icon {
        color: var(--danger-color);
    }
    
    .video-container {
        width: 100%;
        height: 100%;
    }
    
    .gallery-content {
        padding: var(--spacing-md);
    }
    
    .gallery-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        color: var(--text-color);
    }
    
    .gallery-meta {
        display: flex;
        color: var(--text-light);
        font-size: 0.875rem;
        margin-bottom: var(--spacing-sm);
        gap: var(--spacing-md);
    }
    
    .gallery-status {
        margin-bottom: var(--spacing-sm);
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-pill);
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .status-badge.processing {
        background-color: rgba(var(--primary-color-rgb), 0.1);
        color: var(--primary-color);
    }
    
    .status-badge.ready, .status-badge.ready_for_upload {
        background-color: rgba(52, 199, 89, 0.1);
        color: var(--success-color);
    }
    
    .status-badge.uploaded {
        background-color: rgba(90, 200, 250, 0.1);
        color: var(--info-color);
    }
    
    .status-badge.failed {
        background-color: rgba(255, 59, 48, 0.1);
        color: var(--danger-color);
    }
    
    .gallery-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: var(--spacing-md);
    }
    
    .no-videos {
        grid-column: 1 / -1;
        text-align: center;
        padding: var(--spacing-xxl);
        background-color: var(--card-bg);
        border-radius: var(--radius-lg);
        border: 1px dashed var(--border-color);
    }
    
    .no-videos-icon {
        font-size: 3rem;
        color: var(--text-light);
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }
    
    .no-videos h3 {
        margin-bottom: var(--spacing-sm);
    }
    
    .no-videos p {
        margin-bottom: var(--spacing-lg);
        color: var(--text-light);
    }
    
    /* Video Modal */
    .video-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity var(--transition-normal);
    }
    
    .video-modal.active {
        opacity: 1;
        visibility: visible;
    }
    
    .video-modal-content {
        width: 90%;
        max-width: 800px;
        background-color: var(--card-bg);
        border-radius: var(--radius-lg);
        overflow: hidden;
        position: relative;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
    }
    
    .video-modal-close {
        position: absolute;
        top: var(--spacing-sm);
        right: var(--spacing-sm);
        width: 36px;
        height: 36px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: background-color var(--transition-fast);
    }
    
    .video-modal-close:hover {
        background-color: rgba(0, 0, 0, 0.7);
    }
    
    .video-modal-player {
        width: 100%;
        aspect-ratio: 9/16;
    }
    
    .video-modal-info {
        padding: var(--spacing-md);
    }
    
    .video-modal-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }
    
    .video-modal-meta {
        color: var(--text-light);
        font-size: 0.9rem;
    }
    
    /* Delete Confirmation Modal */
    .confirm-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity var(--transition-normal);
    }
    
    .confirm-modal.active {
        opacity: 1;
        visibility: visible;
    }
    
    .confirm-modal-content {
        width: 90%;
        max-width: 500px;
        background-color: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        text-align: center;
    }
    
    .confirm-modal-content h3 {
        margin-bottom: var(--spacing-md);
    }
    
    .confirm-modal-content p {
        margin-bottom: var(--spacing-lg);
        color: var(--text-light);
    }
    
    .confirm-modal-actions {
        display: flex;
        justify-content: center;
        gap: var(--spacing-md);
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
        .gallery-grid {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        .gallery-actions {
            flex-direction: column;
            align-items: stretch;
            gap: var(--spacing-md);
        }
        
        .gallery-filters {
            overflow-x: auto;
            padding-bottom: var(--spacing-xs);
            margin-bottom: 0;
        }
        
        .gallery-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
        
        .page-header h1 {
            font-size: 2rem;
        }
    }
    
    @media (max-width: 576px) {
        .gallery-grid {
            grid-template-columns: 1fr;
        }
        
        .gallery-filters button {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.9rem;
        }
    }
</style> 
{% endblock %} 