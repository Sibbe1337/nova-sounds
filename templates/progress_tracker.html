{% extends "base.html" %}

{% block title %}Progress Tracker | Nova Sounds Shorts Machine{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="section-title mb-4">Video Generation Progress</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            <div class="card" id="progressCard">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>
                        <span id="taskTitle">Processing Task</span>
                        <span class="badge bg-primary ms-2" id="taskStatusBadge">Initializing</span>
                    </h5>
                    <div class="task-timer" id="taskTimer">00:00</div>
                </div>
                <div class="card-body">
                    <!-- Main progress bar -->
                    <div class="progress-container mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Overall Progress</span>
                            <span id="overallProgressText">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="overallProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current step details -->
                    <div class="current-step-details mb-4">
                        <h6 class="mb-3">Current Step: <span id="currentStepName">Initializing</span></h6>
                        <div class="progress mb-2" style="height: 10px;">
                            <div id="stepProgressBar" class="progress-bar bg-info" 
                                role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                            </div>
                        </div>
                        <small id="stepDetail" class="text-muted">Preparing to process your video...</small>
                    </div>
                    
                    <!-- Steps timeline -->
                    <div class="steps-timeline mb-4">
                        <div class="timeline-step-container">
                            <div class="timeline-steps">
                                <div class="timeline-step" data-step="1">
                                    <div class="timeline-step-marker active">
                                        <i class="fas fa-file-import"></i>
                                    </div>
                                    <div class="timeline-step-content">
                                        <h6>Preparing Assets</h6>
                                        <p class="step-detail">Importing images and audio</p>
                                    </div>
                                </div>
                                
                                <div class="timeline-step" data-step="2">
                                    <div class="timeline-step-marker">
                                        <i class="fas fa-music"></i>
                                    </div>
                                    <div class="timeline-step-content">
                                        <h6>Audio Analysis</h6>
                                        <p class="step-detail">Detecting beats and segments</p>
                                    </div>
                                </div>
                                
                                <div class="timeline-step" data-step="3">
                                    <div class="timeline-step-marker">
                                        <i class="fas fa-photo-video"></i>
                                    </div>
                                    <div class="timeline-step-content">
                                        <h6>Style Application</h6>
                                        <p class="step-detail">Applying video effects</p>
                                    </div>
                                </div>
                                
                                <div class="timeline-step" data-step="4">
                                    <div class="timeline-step-marker">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    <div class="timeline-step-content">
                                        <h6>Video Rendering</h6>
                                        <p class="step-detail">Assembling final output</p>
                                    </div>
                                </div>
                                
                                <div class="timeline-step" data-step="5">
                                    <div class="timeline-step-marker">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="timeline-step-content">
                                        <h6>Completion</h6>
                                        <p class="step-detail">Finalizing video</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messages log -->
                    <div class="card message-log mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Processing Log</h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="messageLog" class="message-log-content">
                                <div class="log-message">
                                    <span class="log-time">00:00</span>
                                    <span class="log-text">Initializing video generation process</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="actions-container d-flex justify-content-between">
                        <button id="cancelBtn" class="btn btn-outline-danger">
                            <i class="fas fa-times-circle me-1"></i> Cancel
                        </button>
                        <div>
                            <button id="minimizeBtn" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-minus me-1"></i> Minimize
                            </button>
                            <a id="viewResultBtn" href="#" class="btn btn-primary disabled">
                                <i class="fas fa-eye me-1"></i> View Result
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Minimized view (hidden by default) -->
            <div id="minimizedProgress" class="minimized-progress-card" style="display: none;">
                <div class="minimized-content d-flex align-items-center">
                    <span class="minimized-title me-3">
                        <i class="fas fa-cog fa-spin me-2"></i>
                        Processing: <span id="minimizedTaskName">Video</span>
                    </span>
                    <div class="progress flex-grow-1 me-3">
                        <div id="minimizedProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                            <span id="minimizedProgressText">0%</span>
                        </div>
                    </div>
                    <button id="expandBtn" class="btn btn-sm btn-light">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Progress Tracker specific styles */
    .task-timer {
        font-size: 1.1rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        background-color: rgba(0,0,0,0.05);
        border-radius: 4px;
    }
    
    /* Timeline steps */
    .timeline-step-container {
        position: relative;
        overflow-x: auto;
    }
    
    .timeline-steps {
        display: flex;
        min-width: 650px;
    }
    
    .timeline-step {
        display: flex;
        flex: 1;
        position: relative;
        padding: 0.5rem 0.25rem;
    }
    
    .timeline-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 2rem;
        width: calc(100% - 4.5rem);
        left: 3rem;
        height: 2px;
        background-color: #dee2e6;
        z-index: 0;
    }
    
    .timeline-step-marker {
        z-index: 1;
        width: 3rem;
        height: 3rem;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
        color: #adb5bd;
        font-size: 1.25rem;
        transition: all 0.3s ease;
    }
    
    .timeline-step-marker.active {
        background-color: #e3f2fd;
        border-color: #0d6efd;
        color: #0d6efd;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
    }
    
    .timeline-step-marker.completed {
        background-color: #d1e7dd;
        border-color: #198754;
        color: #198754;
    }
    
    .timeline-step-content {
        width: 100%;
    }
    
    .timeline-step-content h6 {
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }
    
    .timeline-step-content p {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0;
    }
    
    /* Message log */
    .message-log {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        max-height: 200px;
    }
    
    .message-log-content {
        padding: 0.5rem;
        overflow-y: auto;
        max-height: 150px;
        font-family: monospace;
        font-size: 0.85rem;
    }
    
    .log-message {
        padding: 0.25rem 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .log-time {
        color: #6c757d;
        margin-right: 0.5rem;
    }
    
    /* Minimized progress view */
    .minimized-progress-card {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
        background-color: white;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        z-index: 1030;
        padding: 0.75rem;
        max-width: 700px;
        margin: 0 auto;
    }
    
    .minimized-title {
        white-space: nowrap;
        font-weight: 500;
    }
    
    #minimizedProgressBar {
        position: relative;
    }
    
    #minimizedProgressText {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-weight: 500;
        mix-blend-mode: difference;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const progressCard = document.getElementById('progressCard');
    const minimizedProgress = document.getElementById('minimizedProgress');
    const taskTitle = document.getElementById('taskTitle');
    const taskStatusBadge = document.getElementById('taskStatusBadge');
    const taskTimer = document.getElementById('taskTimer');
    const overallProgressBar = document.getElementById('overallProgressBar');
    const overallProgressText = document.getElementById('overallProgressText');
    const currentStepName = document.getElementById('currentStepName');
    const stepProgressBar = document.getElementById('stepProgressBar');
    const stepDetail = document.getElementById('stepDetail');
    const messageLog = document.getElementById('messageLog');
    const minimizeBtn = document.getElementById('minimizeBtn');
    const expandBtn = document.getElementById('expandBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const viewResultBtn = document.getElementById('viewResultBtn');
    const minimizedProgressBar = document.getElementById('minimizedProgressBar');
    const minimizedProgressText = document.getElementById('minimizedProgressText');
    const minimizedTaskName = document.getElementById('minimizedTaskName');
    
    // Variables
    let taskId = new URLSearchParams(window.location.search).get('task_id');
    let pollingInterval = null;
    let startTime = Date.now();
    let timerInterval = null;
    let currentStep = 1;
    
    // Initialize
    function init() {
        if (!taskId) {
            // If no taskId is provided, show an error or redirect
            showError("No task ID provided. Please start a video generation process.");
            return;
        }
        
        // Set up buttons
        minimizeBtn.addEventListener('click', minimizeProgress);
        expandBtn.addEventListener('click', expandProgress);
        cancelBtn.addEventListener('click', cancelTask);
        
        // Start polling for task status
        startPolling();
        
        // Start timer
        startTimer();
        
        // Add initial log message
        addLogMessage("Task initialized, connecting to server...");
    }
    
    // Function to start polling for task status
    function startPolling() {
        // Clear any existing interval
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
        
        // Initial status check
        checkTaskStatus();
        
        // Set up polling interval (every 2 seconds)
        pollingInterval = setInterval(checkTaskStatus, 2000);
    }
    
    // Function to check task status
    function checkTaskStatus() {
        fetch(`/api/worker_status/task/${taskId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                updateProgressUI(data);
            })
            .catch(error => {
                console.error("Error checking task status:", error);
                addLogMessage(`Error: ${error.message}`, 'error');
            });
    }
    
    // Function to update the progress UI based on task data
    function updateProgressUI(data) {
        // Extract data
        const status = data.status;
        const progress = data.progress || 0;
        const stepName = data.current_step || 'Initializing';
        const stepProgress = data.step_progress || 0;
        const stepDetails = data.step_details || '';
        const message = data.message || '';
        const result = data.result || null;
        
        // Update task status
        taskStatusBadge.textContent = status;
        updateStatusBadgeColor(status);
        
        // Update progress bars
        const progressPercent = Math.round(progress * 100);
        overallProgressBar.style.width = `${progressPercent}%`;
        overallProgressBar.setAttribute('aria-valuenow', progressPercent);
        overallProgressText.textContent = `${progressPercent}%`;
        
        // Update minimized progress bar
        minimizedProgressBar.style.width = `${progressPercent}%`;
        minimizedProgressBar.setAttribute('aria-valuenow', progressPercent);
        minimizedProgressText.textContent = `${progressPercent}%`;
        
        // Update step progress
        currentStepName.textContent = stepName;
        minimizedTaskName.textContent = stepName;
        
        const stepProgressPercent = Math.round(stepProgress * 100);
        stepProgressBar.style.width = `${stepProgressPercent}%`;
        stepProgressBar.setAttribute('aria-valuenow', stepProgressPercent);
        
        if (stepDetails) {
            stepDetail.textContent = stepDetails;
            addLogMessage(stepDetails);
        }
        
        // Update timeline steps
        updateTimelineStep(data);
        
        // Add message to log if provided
        if (message && message.trim() !== '') {
            addLogMessage(message);
        }
        
        // Handle completed tasks
        if (status === 'COMPLETED') {
            handleTaskCompleted(result);
        }
        
        // Handle failed tasks
        if (status === 'FAILED') {
            handleTaskFailed(data.error || 'Unknown error occurred');
        }
    }
    
    // Function to update the status badge color
    function updateStatusBadgeColor(status) {
        // Remove existing color classes
        taskStatusBadge.classList.remove(
            'bg-primary', 'bg-success', 'bg-warning', 
            'bg-danger', 'bg-info', 'bg-secondary'
        );
        
        // Add appropriate color class based on status
        switch (status) {
            case 'PENDING':
                taskStatusBadge.classList.add('bg-secondary');
                break;
            case 'STARTED':
            case 'PROGRESS':
                taskStatusBadge.classList.add('bg-primary');
                break;
            case 'COMPLETED':
                taskStatusBadge.classList.add('bg-success');
                break;
            case 'FAILED':
                taskStatusBadge.classList.add('bg-danger');
                break;
            default:
                taskStatusBadge.classList.add('bg-info');
        }
    }
    
    // Function to update timeline steps based on current progress
    function updateTimelineStep(data) {
        // Determine which step we're on based on the data
        let newStep = 1; // Default to first step
        
        if (data.current_step) {
            if (data.current_step.includes('Audio') || data.current_step.includes('beat')) {
                newStep = 2;
            } else if (data.current_step.includes('Style') || data.current_step.includes('effect')) {
                newStep = 3;
            } else if (data.current_step.includes('Render') || data.current_step.includes('Encode')) {
                newStep = 4;
            } else if (data.status === 'COMPLETED') {
                newStep = 5;
            }
        }
        
        // Only update if the step has changed
        if (newStep !== currentStep) {
            // Mark previous steps as completed
            for (let i = 1; i < newStep; i++) {
                const marker = document.querySelector(`.timeline-step[data-step="${i}"] .timeline-step-marker`);
                if (marker) {
                    marker.classList.remove('active');
                    marker.classList.add('completed');
                    marker.innerHTML = '<i class="fas fa-check"></i>';
                }
            }
            
            // Mark current step as active
            const currentMarker = document.querySelector(`.timeline-step[data-step="${newStep}"] .timeline-step-marker`);
            if (currentMarker) {
                currentMarker.classList.add('active');
            }
            
            currentStep = newStep;
        }
    }
    
    // Function to add a message to the log
    function addLogMessage(message, type = 'info') {
        const timeElapsed = getElapsedTimeString();
        
        // Create log message element
        const logElement = document.createElement('div');
        logElement.className = `log-message log-${type}`;
        logElement.innerHTML = `
            <span class="log-time">${timeElapsed}</span>
            <span class="log-text">${message}</span>
        `;
        
        // Add to log container
        messageLog.appendChild(logElement);
        
        // Scroll to bottom
        messageLog.scrollTop = messageLog.scrollHeight;
    }
    
    // Function to start the timer
    function startTimer() {
        startTime = Date.now();
        updateTimer();
        
        timerInterval = setInterval(updateTimer, 1000);
    }
    
    // Function to update the timer display
    function updateTimer() {
        taskTimer.textContent = getElapsedTimeString();
    }
    
    // Function to get elapsed time as a formatted string
    function getElapsedTimeString() {
        const elapsedMs = Date.now() - startTime;
        const elapsedSeconds = Math.floor(elapsedMs / 1000);
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Function to minimize the progress card
    function minimizeProgress() {
        progressCard.style.display = 'none';
        minimizedProgress.style.display = 'block';
    }
    
    // Function to expand the progress card
    function expandProgress() {
        progressCard.style.display = 'block';
        minimizedProgress.style.display = 'none';
    }
    
    // Function to cancel the task
    function cancelTask() {
        if (confirm('Are you sure you want to cancel this task? This action cannot be undone.')) {
            fetch(`/api/worker_status/task/${taskId}/cancel`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                addLogMessage('Task cancellation request sent', 'warning');
                
                // Check status again after a short delay to confirm cancellation
                setTimeout(checkTaskStatus, 1000);
            })
            .catch(error => {
                console.error("Error cancelling task:", error);
                addLogMessage(`Error: ${error.message}`, 'error');
            });
        }
    }
    
    // Function to handle task completion
    function handleTaskCompleted(result) {
        // Stop polling and timer
        clearInterval(pollingInterval);
        clearInterval(timerInterval);
        
        // Update UI
        addLogMessage('Task completed successfully!', 'success');
        
        // Mark all timeline steps as completed
        document.querySelectorAll('.timeline-step-marker').forEach((marker, index) => {
            marker.classList.remove('active');
            marker.classList.add('completed');
            marker.innerHTML = '<i class="fas fa-check"></i>';
        });
        
        // Enable view result button if we have a result URL
        if (result && result.video_url) {
            viewResultBtn.href = result.video_url;
            viewResultBtn.classList.remove('disabled');
            
            // Add completion message with link
            addLogMessage(`Video is ready! <a href="${result.video_url}" target="_blank">View the result</a>`, 'success');
        }
        
        // Disable cancel button
        cancelBtn.disabled = true;
    }
    
    // Function to handle task failure
    function handleTaskFailed(error) {
        // Stop polling and timer
        clearInterval(pollingInterval);
        clearInterval(timerInterval);
        
        // Update UI
        addLogMessage(`Task failed: ${error}`, 'error');
        
        // Mark current step as failed
        const currentMarker = document.querySelector(`.timeline-step[data-step="${currentStep}"] .timeline-step-marker`);
        if (currentMarker) {
            currentMarker.classList.remove('active');
            currentMarker.classList.add('bg-danger', 'text-white', 'border-danger');
            currentMarker.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
        }
        
        // Disable cancel button
        cancelBtn.disabled = true;
    }
    
    // Function to show an error message
    function showError(message) {
        taskTitle.textContent = 'Error';
        taskStatusBadge.textContent = 'ERROR';
        taskStatusBadge.classList.add('bg-danger');
        
        // Hide main progress elements
        document.querySelector('.progress-container').style.display = 'none';
        document.querySelector('.current-step-details').style.display = 'none';
        document.querySelector('.steps-timeline').style.display = 'none';
        
        // Show error message
        const errorElement = document.createElement('div');
        errorElement.className = 'alert alert-danger mt-3';
        errorElement.innerHTML = `
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Error:</strong> ${message}
        `;
        
        // Add a return to dashboard button
        errorElement.innerHTML += `
            <div class="mt-3">
                <a href="/" class="btn btn-outline-primary">
                    <i class="fas fa-home me-2"></i> Return to Dashboard
                </a>
            </div>
        `;
        
        // Insert after the header
        document.querySelector('.card-body').insertBefore(errorElement, document.querySelector('.progress-container'));
        
        // Disable buttons
        cancelBtn.disabled = true;
        minimizeBtn.disabled = true;
    }
    
    // Initialize the component
    init();
});
</script>
{% endblock %} 