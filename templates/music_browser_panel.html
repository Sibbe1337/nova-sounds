{% extends "base.html" %}

{% block title %}Music Browser | Nova Sounds Shorts Machine{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="section-title mb-4">Music Browser</h2>
        </div>
        
        <!-- Filters Panel -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card filter-panel">
                <div class="card-header">
                    <h5>Filter Tracks</h5>
                </div>
                <div class="card-body">
                    <form id="musicFilterForm">
                        <!-- Genre Filter -->
                        <div class="mb-3">
                            <label for="genreFilter" class="form-label">Genre</label>
                            <select id="genreFilter" class="form-select" multiple>
                                {% for genre in genres %}
                                <option value="{{ genre }}">{{ genre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Mood Filter -->
                        <div class="mb-3">
                            <label for="moodFilter" class="form-label">Mood</label>
                            <select id="moodFilter" class="form-select" multiple>
                                {% for mood in moods %}
                                <option value="{{ mood }}">{{ mood }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- BPM Range Filter -->
                        <div class="mb-3">
                            <label for="bpmRange" class="form-label">BPM Range: <span id="bpmRangeValue">60-180</span></label>
                            <div class="range-slider">
                                <input type="range" id="bpmMinRange" class="form-range" min="60" max="180" value="60">
                                <input type="range" id="bpmMaxRange" class="form-range" min="60" max="180" value="180">
                            </div>
                        </div>
                        
                        <!-- Duration Filter -->
                        <div class="mb-3">
                            <label for="durationFilter" class="form-label">Duration</label>
                            <select id="durationFilter" class="form-select">
                                <option value="any">Any duration</option>
                                <option value="short">Short (< 60s)</option>
                                <option value="medium">Medium (60-120s)</option>
                                <option value="long">Long (> 120s)</option>
                            </select>
                        </div>
                        
                        <!-- Apply/Reset Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Apply Filters</button>
                            <button type="reset" class="btn btn-outline-secondary">Reset</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Music Tracks List -->
        <div class="col-lg-9 col-md-8">
            <div class="card tracks-panel">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Music Tracks</h5>
                    <div class="input-group search-bar" style="max-width: 300px;">
                        <input type="text" id="trackSearch" class="form-control" placeholder="Search tracks...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="track-list" id="musicTrackList">
                        {% if tracks %}
                            {% for track in tracks %}
                            <div class="track-item" data-track-id="{{ track.id }}" data-genre="{{ track.genre }}" data-mood="{{ track.mood }}" data-bpm="{{ track.bpm }}">
                                <div class="track-controls">
                                    <button class="btn btn-sm btn-play" data-track-url="{{ track.url }}">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-select">
                                        <i class="fas fa-plus"></i> Select
                                    </button>
                                </div>
                                <div class="track-info">
                                    <h5 class="track-title">{{ track.title }}</h5>
                                    <div class="track-metadata">
                                        <span class="track-artist">{{ track.artist }}</span>
                                        <span class="track-genre badge bg-primary">{{ track.genre }}</span>
                                        <span class="track-mood badge bg-info">{{ track.mood }}</span>
                                        <span class="track-bpm badge bg-secondary">{{ track.bpm }} BPM</span>
                                        <span class="track-duration">{{ track.duration }}</span>
                                    </div>
                                </div>
                                <div class="track-waveform" id="waveform-{{ track.id }}" data-waveform-url="/music/{{ track.id }}/waveform"></div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-tracks-message">
                                <i class="fas fa-music fa-3x mb-3"></i>
                                <h5>No music tracks found</h5>
                                <p>Try adjusting your filters or search criteria.</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if pagination and pagination.total_pages > 1 %}
                    <div class="pagination-controls mt-4 d-flex justify-content-center">
                        <nav aria-label="Track pagination">
                            <ul class="pagination">
                                <li class="page-item {% if pagination.current_page == 1 %}disabled{% endif %}">
                                    <a class="page-link" href="?page={{ pagination.current_page - 1 }}">Previous</a>
                                </li>
                                
                                {% for page_num in range(1, pagination.total_pages + 1) %}
                                <li class="page-item {% if pagination.current_page == page_num %}active{% endif %}">
                                    <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                                </li>
                                {% endfor %}
                                
                                <li class="page-item {% if pagination.current_page == pagination.total_pages %}disabled{% endif %}">
                                    <a class="page-link" href="?page={{ pagination.current_page + 1 }}">Next</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Music Browser specific styles */
    .filter-panel, .tracks-panel {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .track-item {
        display: flex;
        padding: 15px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        transition: background-color 0.2s ease;
    }
    
    .track-item:last-child {
        border-bottom: none;
    }
    
    .track-item:hover {
        background-color: rgba(0,0,0,0.02);
    }
    
    .track-controls {
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-right: 15px;
    }
    
    .track-info {
        flex: 1;
        overflow: hidden;
    }
    
    .track-title {
        margin: 0 0 5px;
        font-size: 1.1rem;
    }
    
    .track-metadata {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 0.85rem;
    }
    
    .track-artist {
        color: #666;
        margin-right: 10px;
    }
    
    .track-waveform {
        width: 250px;
        height: 60px;
        margin-left: 15px;
        background-color: rgba(0,0,0,0.03);
        border-radius: 4px;
    }
    
    .range-slider {
        position: relative;
        height: 1.5rem;
    }
    
    .range-slider input {
        position: absolute;
        width: 100%;
        height: 5px;
        margin: 0;
        background: none;
        pointer-events: none;
        outline: none;
    }
    
    .range-slider input::-webkit-slider-thumb {
        pointer-events: all;
        position: relative;
        z-index: 1;
        width: 16px;
        height: 16px;
    }
    
    .no-tracks-message {
        text-align: center;
        padding: 40px 0;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize waveform visualizations for each track
    document.querySelectorAll('.track-item').forEach(trackItem => {
        const trackId = trackItem.dataset.trackId;
        const waveformContainer = document.getElementById(`waveform-${trackId}`);
        const waveformUrl = waveformContainer.dataset.waveformUrl;
        
        // Create waveform visualization
        fetch(waveformUrl)
            .then(response => response.json())
            .then(waveformData => {
                renderWaveform(waveformContainer, waveformData);
            })
            .catch(error => {
                console.error('Error loading waveform data:', error);
                waveformContainer.innerHTML = '<p class="text-muted">Waveform unavailable</p>';
            });
    });
    
    // Play button functionality
    document.querySelectorAll('.btn-play').forEach(button => {
        button.addEventListener('click', function() {
            const trackUrl = this.dataset.trackUrl;
            const icon = this.querySelector('i');
            
            // Stop any currently playing tracks
            document.querySelectorAll('.btn-play i.fa-pause').forEach(playingIcon => {
                playingIcon.classList.remove('fa-pause');
                playingIcon.classList.add('fa-play');
            });
            
            // Toggle play/pause for this track
            if (icon.classList.contains('fa-play')) {
                // Play this track
                const audio = new Audio(trackUrl);
                window.currentAudio = audio;
                audio.play();
                
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
                
                // Add ended event to reset icon
                audio.addEventListener('ended', function() {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                });
            } else {
                // Pause current track
                if (window.currentAudio) {
                    window.currentAudio.pause();
                }
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            }
        });
    });
    
    // Select button functionality
    document.querySelectorAll('.btn-select').forEach(button => {
        button.addEventListener('click', function() {
            const trackItem = this.closest('.track-item');
            const trackId = trackItem.dataset.trackId;
            const trackTitle = trackItem.querySelector('.track-title').textContent;
            
            // Store selected track info in session storage
            sessionStorage.setItem('selectedTrackId', trackId);
            sessionStorage.setItem('selectedTrackTitle', trackTitle);
            
            // Provide visual feedback
            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.remove('selected');
            });
            trackItem.classList.add('selected');
            
            // Show confirmation
            showToast(`Selected track: ${trackTitle}`);
        });
    });
    
    // Filter form handling
    const filterForm = document.getElementById('musicFilterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            applyFilters();
        });
        
        filterForm.addEventListener('reset', function() {
            setTimeout(() => {
                applyFilters();
            }, 0);
        });
    }
    
    // BPM range slider functionality
    const bpmMinRange = document.getElementById('bpmMinRange');
    const bpmMaxRange = document.getElementById('bpmMaxRange');
    const bpmRangeValue = document.getElementById('bpmRangeValue');
    
    if (bpmMinRange && bpmMaxRange && bpmRangeValue) {
        const updateBpmRange = () => {
            const minVal = parseInt(bpmMinRange.value);
            const maxVal = parseInt(bpmMaxRange.value);
            
            // Ensure min <= max
            if (minVal > maxVal) {
                bpmMaxRange.value = minVal;
            }
            
            bpmRangeValue.textContent = `${bpmMinRange.value}-${bpmMaxRange.value}`;
        };
        
        bpmMinRange.addEventListener('input', updateBpmRange);
        bpmMaxRange.addEventListener('input', updateBpmRange);
    }
    
    // Search functionality
    const searchInput = document.getElementById('trackSearch');
    const searchBtn = document.getElementById('searchBtn');
    
    if (searchInput && searchBtn) {
        searchBtn.addEventListener('click', function() {
            applyFilters();
        });
        
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    }
    
    // Waveform rendering function
    function renderWaveform(container, waveformData) {
        const canvas = document.createElement('canvas');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        container.appendChild(canvas);
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        // Draw background
        ctx.fillStyle = 'rgba(0, 123, 255, 0.1)';
        ctx.fillRect(0, 0, width, height);
        
        // Draw waveform
        ctx.strokeStyle = '#007bff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        const barWidth = width / waveformData.length;
        
        for (let i = 0; i < waveformData.length; i++) {
            const x = i * barWidth;
            const barHeight = waveformData[i] * height;
            const y = (height - barHeight) / 2;
            
            ctx.rect(x, y, barWidth - 1, barHeight);
        }
        
        ctx.fill();
    }
    
    // Filter application function
    function applyFilters() {
        const genres = Array.from(document.getElementById('genreFilter').selectedOptions).map(opt => opt.value);
        const moods = Array.from(document.getElementById('moodFilter').selectedOptions).map(opt => opt.value);
        const minBpm = parseInt(document.getElementById('bpmMinRange').value);
        const maxBpm = parseInt(document.getElementById('bpmMaxRange').value);
        const duration = document.getElementById('durationFilter').value;
        const searchTerm = document.getElementById('trackSearch').value.toLowerCase();
        
        document.querySelectorAll('.track-item').forEach(track => {
            let visible = true;
            
            // Genre filter
            if (genres.length > 0) {
                const trackGenre = track.dataset.genre;
                if (!genres.includes(trackGenre)) {
                    visible = false;
                }
            }
            
            // Mood filter
            if (visible && moods.length > 0) {
                const trackMood = track.dataset.mood;
                if (!moods.includes(trackMood)) {
                    visible = false;
                }
            }
            
            // BPM filter
            if (visible) {
                const trackBpm = parseInt(track.dataset.bpm);
                if (trackBpm < minBpm || trackBpm > maxBpm) {
                    visible = false;
                }
            }
            
            // Duration filter
            if (visible && duration !== 'any') {
                const trackDurationEl = track.querySelector('.track-duration');
                const trackDurationText = trackDurationEl.textContent;
                const durationSeconds = parseDuration(trackDurationText);
                
                if (duration === 'short' && durationSeconds >= 60) {
                    visible = false;
                } else if (duration === 'medium' && (durationSeconds < 60 || durationSeconds > 120)) {
                    visible = false;
                } else if (duration === 'long' && durationSeconds <= 120) {
                    visible = false;
                }
            }
            
            // Search term filter
            if (visible && searchTerm) {
                const trackTitle = track.querySelector('.track-title').textContent.toLowerCase();
                const trackArtist = track.querySelector('.track-artist').textContent.toLowerCase();
                
                if (!trackTitle.includes(searchTerm) && !trackArtist.includes(searchTerm)) {
                    visible = false;
                }
            }
            
            // Apply visibility
            track.style.display = visible ? '' : 'none';
        });
        
        // Show/hide no results message
        const visibleTracks = document.querySelectorAll('.track-item[style="display: none;"]').length;
        const noTracksMessage = document.querySelector('.no-tracks-message');
        
        if (noTracksMessage) {
            noTracksMessage.style.display = visibleTracks === 0 ? 'block' : 'none';
        }
    }
    
    // Helper function to parse duration string (e.g., "1:45" to seconds)
    function parseDuration(durationStr) {
        const parts = durationStr.split(':').map(Number);
        if (parts.length === 2) {
            return parts[0] * 60 + parts[1];
        } else if (parts.length === 3) {
            return parts[0] * 3600 + parts[1] * 60 + parts[2];
        }
        return 0;
    }
    
    // Toast notification helper
    function showToast(message) {
        // Create toast element if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create new toast
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Nova Sounds</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Initialize and show the toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();
        
        // Remove toast after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
});
</script>
{% endblock %} 