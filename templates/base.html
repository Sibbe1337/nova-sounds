<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="theme-color" content="#FFFFFF" id="theme-color-meta">
    <title>{% block title %}YouTube Shorts Machine{% endblock %}</title>
    
    <!-- Essential utility functions - must be first -->
    <script>
        // Script loading management to prevent duplicates
        window.__loadedScripts = window.__loadedScripts || {};
        
        // Check if a script has been loaded
        window.isScriptLoaded = function(scriptName) {
            return window.__loadedScripts[scriptName] === true;
        };
        
        // Mark a script as loaded
        window.markScriptAsLoaded = function(scriptName) {
            window.__loadedScripts[scriptName] = true;
            console.log(`Script ${scriptName} marked as loaded`);
            return true;
        };
        
        // Safe script loader
        window.loadScriptOnce = function(url, id) {
            const scriptId = id || url.split('/').pop().replace('.js', '');
            
            // Don't load if already loaded
            if (window.isScriptLoaded(scriptId)) {
                console.log(`Script ${scriptId} already loaded, skipping`);
                return Promise.resolve();
            }
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.async = true;
                script.defer = true;
                script.onload = function() {
                    window.markScriptAsLoaded(scriptId);
                    resolve();
                };
                script.onerror = function(err) {
                    console.error(`Error loading script ${url}:`, err);
                    reject(err);
                };
                document.head.appendChild(script);
            });
        };

        // Safely check if element exists and has a property
        window.safeAccess = function(obj, prop) {
            return obj && obj[prop] ? obj[prop] : null;
        };
        
        // Safely add class to element
        window.safeAddClass = function(element, className) {
            if (element && element.classList) {
                element.classList.add(className);
                return true;
            }
            return false;
        };
        
        // Safe querySelector that doesn't throw errors
        window.safeQuery = function(selector, parent) {
            try {
                return (parent || document).querySelector(selector);
            } catch (e) {
                console.warn('Safe query failed:', e);
                return null;
            }
        };
        
        // Error handler for resources
        window.handleResourceError = function(resource, type) {
            console.warn(`Resource failed to load: ${type}`, resource);
            if (type === 'style' && typeof handleStyleError === 'function') {
                handleStyleError(resource);
            }
            return false;
        };
    </script>
    
    <!-- Debug mode script - runs first to ensure debug flag is set before other scripts -->
    <script>
        // Debug mode toggle and state management
        window.__DEBUG_MODE = (function() {
            // This IIFE returns the correct value and avoids linter errors with Jinja syntax
            /* {% if dev_mode %} */
            return true;
            /* {% else %} */
            return false;
            /* {% endif %} */
        })();
        
        // Expose debug utility functions early
        window.debugLog = function(message) {
          if (window.__DEBUG_MODE) {
            console.log("[DEBUG]", message);
          }
        };
        
        // Initialize debug mode from URL param or localStorage
        (function() {
          try {
            // Check URL parameter first
            const urlParams = new URLSearchParams(window.location.search);
            const debugParam = urlParams.get('debug');
            
            if (debugParam === 'true' || debugParam === '1') {
              window.__DEBUG_MODE = true;
              localStorage.setItem('debugMode', 'true');
              debugLog('Debug mode enabled via URL parameter');
            } else if (debugParam === 'false' || debugParam === '0') {
              window.__DEBUG_MODE = false;
              localStorage.setItem('debugMode', 'false');
              debugLog('Debug mode disabled via URL parameter');
            } else if (localStorage.getItem('debugMode') === 'true') {
              window.__DEBUG_MODE = true;
              debugLog('Debug mode enabled via localStorage');
            }
          } catch (e) {
            console.error('Error initializing debug mode:', e);
          }
        })();
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- Font setup with local fallbacks -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Use font-display: swap to show fallback font while loading -->
    <style>
        /* Local fallback fonts */
        @font-face {
            font-family: 'SF Pro Display';
            src: local('SF Pro Display'), local('SFProDisplay-Regular'),
                 local('-apple-system'), local('BlinkMacSystemFont');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'SF Pro Display';
            src: local('SF Pro Display Bold'), local('SFProDisplay-Bold'),
                 local('-apple-system-bold'), local('BlinkMacSystemFont');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'SF Pro Display';
            src: local('SF Pro Display Light'), local('SFProDisplay-Light'),
                 local('-apple-system-thin'), local('BlinkMacSystemFont');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        
        /* Define font variables */
        :root {
            --font-primary: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* Apply fonts */
        body {
            font-family: var(--font-primary);
        }
    </style>

    <!-- Safer font loading script -->
    <script>
        // Use proxy endpoint to avoid CORS issues with Google Fonts
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const linkElement = document.createElement('link');
                linkElement.rel = 'stylesheet';
                // Use our proxy endpoint instead of direct Google Fonts URL with proper encoding
                linkElement.href = '/proxy/fonts/family=SF+Pro+Display:wght@300;400;500;600;700&display=swap';
                
                linkElement.onload = function() {
                    window.safeAddClass(document.body, 'google-fonts-loaded');
                    console.log('Google Fonts loaded successfully via proxy');
                };
                
                linkElement.onerror = function() {
                    window.safeAddClass(document.body, 'use-local-fonts');
                    console.warn('Google Fonts failed to load, using local fonts');
                };
                
                document.head.appendChild(linkElement);
            } catch (e) {
                console.error('Error loading Google Fonts:', e);
                // Fallback to local fonts automatically
                window.safeAddClass(document.body, 'use-local-fonts');
            }
        });
    </script>
    
    <link rel="stylesheet" href="/static/css/styles.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/color-enhancement.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/notifications.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/theme-customizer.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/ui-feedback.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/interactive-cards.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/progress-indicators.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/buttons.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/background-effects.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/onboarding.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/auth.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/ui-fixes.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/grid-system.css" onerror="window.handleResourceError(this, 'style');">
    <link rel="stylesheet" href="/static/css/chat-interface.css" onerror="window.handleResourceError(this, 'style');">
    {% if request.url.path == '/landing' %}
    <link rel="stylesheet" href="/static/css/landing.css" onerror="window.handleResourceError(this, 'style');">
    {% endif %}
    {% if dev_mode %}
    <link rel="stylesheet" href="/static/css/debug-toolbar.css" onerror="window.handleResourceError(this, 'style');">
    {% endif %}
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" onerror="window.handleResourceError(this, 'icon');">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" onerror="window.handleResourceError(this, 'icon');">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon" onerror="window.handleResourceError(this, 'icon');">
    <link rel="apple-touch-icon" href="/static/favicon.svg">
    <script>
        // Handle stylesheet loading errors
        window.handleStyleError = function(stylesheet) {
            console.error('Failed to load stylesheet:', stylesheet ? stylesheet.href : 'unknown');
            // Create an inline style element with basic styles as fallback
            try {
                const fallbackStyle = document.createElement('style');
                fallbackStyle.textContent = `
                    :root {
                        --primary-color: #0071e3;
                        --accent-color: #0071e3;
                        --primary-color-rgb: 0, 113, 227;
                        --background-color: #f5f5f7;
                        --card-bg: #ffffff;
                        --text-color: #333333;
                        --text-color-light: #86868b;
                        --border-color: #d2d2d7;
                        --success-color: #28a745;
                        --error-color: #dc3545;
                        --warning-color: #ffc107;
                        --info-color: #17a2b8;
                        --success-light: #e8f5e9;
                        --error-light: #ffebee;
                        --warning-light: #fff8e1;
                        --info-light: #e1f5fe;
                    }
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                        margin: 0;
                        padding: 0;
                        background-color: var(--background-color);
                        color: var(--text-color);
                    }
                    .container {
                        max-width: 1200px;
                        margin: 0 auto;
                        padding: 0 20px;
                    }
                    .btn {
                        display: inline-block;
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        text-decoration: none;
                    }
                    .btn.primary {
                        background-color: var(--primary-color);
                        color: white;
                        border: none;
                    }
                    .btn.secondary {
                        background-color: transparent;
                        color: var(--text-color);
                        border: 1px solid var(--border-color);
                    }
                `;
                
                // Safe append to head
                if (document && document.head) {
                    document.head.appendChild(fallbackStyle);
                }
            } catch (e) {
                console.error('Error creating fallback styles:', e);
            }
        }
    </script>

    <!-- Responsive sizing fixes - critical CSS -->
    <style>
        /* Enhanced box sizing model */
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        /* Base viewport size correction */
        html, body {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Responsive image sizing */
        img {
            max-width: 100%;
            height: auto;
        }
        
        /* Consistent container sizing */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Fix for responsive tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Force consistent form element sizing */
        input, select, textarea, button {
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
        }
        
        /* Improved mobile tap targets */
        button, 
        [type="button"], 
        [type="reset"], 
        [type="submit"],
        .btn {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Flexible card layouts */
        .card {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Fix overflow issues in containers */
        .main-content {
            width: 100%;
            position: relative;
        }
        
        /* Fix for modals */
        .modal {
            max-height: 90vh;
            max-width: 90vw;
            overflow-y: auto;
        }
        
        /* Responsive typography scale */
        @media (max-width: 768px) {
            h1 { font-size: 1.8rem !important; }
            h2 { font-size: 1.5rem !important; }
            h3 { font-size: 1.3rem !important; }
            h4 { font-size: 1.2rem !important; }
            h5 { font-size: 1.1rem !important; }
            h6 { font-size: 1rem !important; }
            
            .display-1, .display-2, .display-3, .display-4 {
                font-size: 2rem !important;
            }
        }
        
        @media (max-width: 576px) {
            h1 { font-size: 1.6rem !important; }
            h2 { font-size: 1.4rem !important; }
            h3 { font-size: 1.2rem !important; }
            h4 { font-size: 1.1rem !important; }
            h5, h6 { font-size: 1rem !important; }
            
            .display-1, .display-2, .display-3, .display-4 {
                font-size: 1.8rem !important;
            }
            
            .container {
                padding: 0 15px;
            }
        }
    </style>

    <!-- Theme Switcher Script - Early loading to prevent flash -->
    <script>
        // Immediately set theme based on local storage or system preference to prevent flash
        (function() {
            const THEME_STORAGE_KEY = 'youtube-shorts-machine-theme';
            const DARK_THEME = 'dark-theme';
            const LIGHT_THEME = 'light-theme';
            
            const savedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            let themeToApply;
            
            if (savedTheme === DARK_THEME || savedTheme === LIGHT_THEME) {
                themeToApply = savedTheme;
            } else {
                themeToApply = prefersDark ? DARK_THEME : LIGHT_THEME;
            }
            
            // Apply theme to both html and body
            document.documentElement.classList.add(themeToApply);
            
            // For body, we need to wait until it exists
            if (document.body) {
                document.body.classList.add(themeToApply);
            } else {
                // If body doesn't exist yet, add event listener
                document.addEventListener('DOMContentLoaded', function() {
                    document.body.classList.add(themeToApply);
                });
            }
            
            // Update meta theme color
            const metaThemeColor = document.getElementById('theme-color-meta');
            if (metaThemeColor) {
                metaThemeColor.setAttribute('content', themeToApply === DARK_THEME ? '#1A202C' : '#FFFFFF');
            }
        })();
    </script>
</head>
<body class="{% if request.url.path == '/landing' %}landing-page{% endif %} {% block body_class %}{% endblock %}">
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Animated Backgrounds -->
    <div class="spotlight" id="spotlight"></div>
    <div class="bubble-bg">
        <div class="bubble bubble-1"></div>
        <div class="bubble bubble-2"></div>
        <div class="bubble bubble-3"></div>
        <div class="bubble bubble-4"></div>
        <div class="bubble bubble-5"></div>
    </div>
    
    <!-- Background Decorations -->
    <div class="decoration-dots" style="top: 15%; left: 5%;"></div>
    <div class="decoration-dots" style="bottom: 20%; right: 8%;"></div>
    <div class="blurred-circle gradient-bg" style="top: 10%; right: 15%;"></div>
    <div class="blurred-circle gradient-bg" style="bottom: 15%; left: 10%;"></div>
    
    <div class="app-container">
        <header class="app-header glass-nav">
            <div class="container">
                {% if dev_mode %}
                <div class="dev-mode-indicator">
                    <i class="fas fa-bug"></i> Development Mode
                </div>
                {% endif %}
                <div class="header-content">
                    <div class="logo-container">
                        <a href="/" class="logo hover-scale">
                            <div class="logo-icon">
                                <i class="fab fa-youtube"></i>
                            </div>
                            <span class="logo-text">YouTube <span class="logo-accent gradient-text">Shorts</span> Machine</span>
                        </a>
                    </div>
                    
                    <nav class="main-nav">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link hover-lift">Create</a></li>
                            <li class="nav-item">
                                <a class="nav-link" href="/enhanced"><i class="fas fa-edit"></i> Enhanced Creator</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/audio-waveform"><i class="fas fa-music"></i> Audio Waveform</a>
                            </li>
                            <li class="nav-item"><a href="/gallery" class="nav-link hover-lift">Gallery</a></li>
                            <li class="nav-item"><a href="/youtube/dashboard" class="nav-link hover-lift">YouTube</a></li>
                            <li class="nav-item"><a href="/analytics" class="nav-link hover-lift">Analytics</a></li>
                            <li class="nav-item"><a href="/status" class="nav-link hover-lift">Status</a></li>
                        </ul>
                    </nav>
                    
                    <!-- Firebase Authentication Status -->
                    <div class="signed-in-container" style="display: none;">
                        <div class="dropdown">
                            <a href="#" class="dropdown-toggle hover-lift">
                                <img src="" alt="User Avatar" class="user-avatar nav-avatar">
                                <span class="user-display-name">User</span>
                            </a>
                            <div class="dropdown-menu glass-card">
                                <a href="/dashboard" class="dropdown-item">
                                    <i class="fas fa-chart-line"></i> Dashboard
                                </a>
                                <a href="/gallery" class="dropdown-item">
                                    <i class="fas fa-photo-video"></i> My Videos
                                </a>
                                <a href="/analytics" class="dropdown-item">
                                    <i class="fas fa-chart-bar"></i> Analytics
                                </a>
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item btn-sign-out">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Regular Authentication Status (Server-side) -->
                    {% if authenticated %}
                    <div class="user-menu">
                        <div class="dropdown">
                            <a href="#" class="dropdown-toggle hover-lift">
                                <i class="fas fa-user-circle"></i> {{user_name}}
                            </a>
                            <div class="dropdown-menu glass-card">
                                <a href="/dashboard" class="dropdown-item">
                                    <i class="fas fa-chart-line"></i> Dashboard
                                </a>
                                <a href="/gallery" class="dropdown-item">
                                    <i class="fas fa-photo-video"></i> My Videos
                                </a>
                                <a href="/analytics" class="dropdown-item">
                                    <i class="fas fa-chart-bar"></i> Analytics
                                </a>
                                <a href="/auth/logout" class="dropdown-item">
                                    <i class="fas fa-sign-out-alt"></i> Logout
                                </a>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="signed-out-container">
                        <label class="theme-toggle" for="theme-toggle" title="Toggle dark mode">
                            <input type="checkbox" id="theme-toggle" aria-label="Switch between dark and light mode">
                            <span class="theme-toggle-track">
                                <span class="theme-toggle-thumb">
                                    <i class="theme-toggle-icon fas fa-sun"></i>
                                </span>
                            </span>
                        </label>
                        <a href="/auth" class="auth-link">
                            <i class="fab fa-youtube"></i> Sign in
                        </a>
                    </div>
                    {% endif %}
                    
                    <button class="mobile-menu-button" aria-label="Toggle menu">
                        <span class="menu-icon"></span>
                    </button>
                </div>
            </div>
        </header>
        
        <main class="app-main" id="main-content">
            <div class="container">
                <!-- Improved status message container -->
                <div id="status-message-container" aria-live="polite">
                    <!-- Status messages will be injected here -->
                </div>
                
                {% block content %}{% endblock %}
            </div>
        </main>
        
        <footer class="app-footer glass-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-info">
                        <p class="copyright">&copy; 2025 YouTube Shorts Machine</p>
                    </div>
                    <div class="footer-links">
                        <a href="#" class="footer-link hover-lift">Terms</a>
                        <a href="#" class="footer-link hover-lift">Privacy</a>
                        <a href="#" class="footer-link hover-lift">Help</a>
                        <a href="#" class="footer-link hover-lift" id="showKeyboardShortcuts">
                            <i class="fas fa-keyboard"></i> Keyboard Shortcuts
                        </a>
                        {% if dev_mode %}
                        <a href="/debug" class="footer-link debug-link hover-lift">
                            <i class="fas fa-bug"></i> Debug Console
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <script>
        // Mobile menu toggle
        document.querySelector('.mobile-menu-button').addEventListener('click', function() {
            document.querySelector('.main-nav').classList.toggle('active');
            this.classList.toggle('active');
        });
        
        // Dropdown menu
        document.querySelectorAll('.dropdown-toggle').forEach(item => {
            item.addEventListener('click', event => {
                event.preventDefault();
                event.stopPropagation();
                const dropdown = item.parentElement;
                dropdown.classList.toggle('active');
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', event => {
            document.querySelectorAll('.dropdown.active').forEach(dropdown => {
                if (!dropdown.contains(event.target)) {
                    dropdown.classList.remove('active');
                }
            });
        });
        
        // Add active class to current nav link
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-link').forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPath || 
                    (href !== '/' && currentPath.startsWith(href))) {
                    link.classList.add('active');
                    
                    // If this is inside a dropdown, also activate the dropdown
                    const parentDropdown = link.closest('.dropdown');
                    if (parentDropdown) {
                        const dropdownToggle = parentDropdown.querySelector('.dropdown-toggle');
                        if (dropdownToggle) {
                            dropdownToggle.classList.add('active');
                        }
                    }
                }
            });
        });
        
        // Subtle animation on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.body.classList.add('loaded');
            
            // Add scroll animation for elements
            const animateOnScroll = function() {
                const elements = document.querySelectorAll('.scroll-animate');
                elements.forEach(element => {
                    const elementPosition = element.getBoundingClientRect().top;
                    const windowHeight = window.innerHeight;
                    if (elementPosition < windowHeight - 100) {
                        element.classList.add('visible');
                    }
                });
            };
            
            // Run once on initial load
            animateOnScroll();
            
            // Set up scroll listener
            window.addEventListener('scroll', animateOnScroll);
            
            // Spotlight follow effect
            const spotlight = document.getElementById('spotlight');
            if (spotlight) {
                document.addEventListener('mousemove', function(e) {
                    const mouseX = e.clientX;
                    const mouseY = e.clientY;
                    spotlight.style.transform = `translate(${mouseX}px, ${mouseY}px)`;
                });
            }
        });
    </script>
    
    {% block extra_js %}{% endblock %}
    
    <!-- Theme Toggle and Keyboard Shortcuts -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggle functionality
            const themeToggle = document.getElementById('theme-toggle');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            
            // Initialize theme based on local storage or system preference
            function initializeTheme() {
                if (localStorage.getItem('theme')) {
                    // If user has explicitly set a theme, use that
                    document.body.classList.toggle('dark-theme', localStorage.getItem('theme') === 'dark');
                    document.body.classList.toggle('light-theme', localStorage.getItem('theme') === 'light');
                    themeToggle.checked = localStorage.getItem('theme') === 'dark';
                } else {
                    // Otherwise, use system preference
                    document.body.classList.toggle('dark-theme', prefersDarkScheme.matches);
                    document.body.classList.toggle('light-theme', !prefersDarkScheme.matches);
                    themeToggle.checked = prefersDarkScheme.matches;
                }
                
                // Update icon
                updateThemeIcon();
            }
            
            // Update the icon in the toggle
            function updateThemeIcon() {
                const icon = document.querySelector('.theme-toggle-icon');
                if (themeToggle.checked) {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                } else {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            }
            
            // Initialize on page load
            if (themeToggle) {
                initializeTheme();
                
                // Listen for toggle changes
                themeToggle.addEventListener('change', function() {
                    if (themeToggle.checked) {
                        document.body.classList.add('dark-theme');
                        document.body.classList.remove('light-theme');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-theme');
                        document.body.classList.add('light-theme');
                        localStorage.setItem('theme', 'light');
                    }
                    updateThemeIcon();
                });
                
                // Listen for system preference changes
                prefersDarkScheme.addEventListener('change', function(e) {
                    // Only update if user hasn't explicitly set a preference
                    if (!localStorage.getItem('theme')) {
                        document.body.classList.toggle('dark-theme', e.matches);
                        document.body.classList.toggle('light-theme', !e.matches);
                        themeToggle.checked = e.matches;
                        updateThemeIcon();
                    }
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Shift + D: Toggle dark mode
                if (e.shiftKey && e.key === 'D') {
                    if (themeToggle) {
                        themeToggle.checked = !themeToggle.checked;
                        themeToggle.dispatchEvent(new Event('change'));
                    }
                }
                
                // Shift + H: Go to home
                if (e.shiftKey && e.key === 'H') {
                    window.location.href = '/';
                }
                
                // Shift + G: Go to gallery
                if (e.shiftKey && e.key === 'G') {
                    window.location.href = '/gallery';
                }
                
                // Shift + C: Create new video
                if (e.shiftKey && e.key === 'C') {
                    const createBtn = document.querySelector('a[href="/enhanced"]');
                    if (createBtn) {
                        createBtn.click();
                    } else {
                        window.location.href = '/enhanced';
                    }
                }
                
                // Show keyboard shortcuts help when ? is pressed
                if (e.key === '?') {
                    const shortcutsModal = document.getElementById('keyboardShortcutsModal');
                    if (shortcutsModal) {
                        shortcutsModal.classList.add('active');
                    }
                }
            });
        });
    </script>
    
    <!-- Core JavaScript libraries -->
    <script src="/static/js/notifications.js"></script>
    <script src="/static/js/theme-switcher.js"></script>
    <script src="/static/js/ui-feedback.js"></script>
    <script src="/static/js/interactive-cards.js"></script>
    <!-- Progress indicators script loaded only once through scripts array to prevent duplicate declarations -->
    <script src="/static/js/onboarding.js" onerror="console.error('Failed to load onboarding.js')"></script>
    <script src="/static/js/image-utils.js" onerror="console.error('Failed to load image-utils.js')"></script>

    <!-- Supabase Authentication -->
    <script type="module" src="/static/js/supabase-auth.js" onerror="console.error('Failed to load supabase-auth.js')"></script>

    {% if dev_mode %}
    <!-- Debug scripts -->
    <script src="/static/js/debug-toolbar.js" onerror="console.error('Failed to load debug-toolbar.js')"></script>
    <script src="/static/js/debug.js" onerror="console.error('Failed to load debug.js')"></script>
    <script src="/static/js/mock-resources.js" onerror="console.error('Failed to load mock-resources.js')"></script>
    {% endif %}

    <!-- Third-party Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/js/all.min.js" defer></script>
    
    <!-- Core UI utilities - must be loaded early -->
    <script src="/static/js/ui-utils.js"></script>
    <script src="/static/js/api-client.js"></script>
    <script src="/static/js/form-validator.js"></script>
    <script src="/static/js/app.js"></script>
    
    <!-- Accessibility and UI enhancement scripts -->
    <script src="/static/js/theme-manager.js"></script>
    <script src="/static/js/offline-handler.js"></script>
    
    <!-- Other scripts will load from individual templates -->
    {% block scripts %}{% endblock %}
    
    <!-- Force refresh theme on page load to ensure proper application -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Force refresh the theme to ensure all CSS rules are applied correctly
            if (window.themeManager && window.themeManager.applyTheme) {
                window.themeManager.applyTheme();
            } else if (window.ThemeSwitcher && window.ThemeSwitcher.forceRefreshTheme) {
                window.ThemeSwitcher.forceRefreshTheme();
            } else {
                // Fallback if ThemeSwitcher is not available
                const isDarkTheme = document.body.classList.contains('dark-theme');
                // Remove and re-add class to trigger any CSS transitions
                document.body.classList.remove('dark-theme', 'light-theme');
                document.body.classList.add(isDarkTheme ? 'dark-theme' : 'light-theme');
                
                // Update meta theme color
                const metaThemeColor = document.querySelector('meta[name="theme-color"]');
                if (metaThemeColor) {
                    metaThemeColor.setAttribute('content', isDarkTheme ? '#1A202C' : '#FFFFFF');
                }
            }
        });
    </script>

    <!-- Improved navigation script -->
    <script src="/static/js/ui-enhancements.js" defer></script>
</body>

<!-- Include any template fragments if needed -->
{% include "onboarding.html" %}

{% if dev_mode %}
{% include "debug-toolbar.html" %}
{% endif %}
</html> 