{% extends "base.html" %}

{% block title %}Video Style Selector | Nova Sounds Shorts Machine{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="section-title mb-4">Video Style Selector</h2>
            <p class="lead mb-4">Choose a style for your video to define its overall look and feel.</p>
        </div>
    </div>
    
    <div class="row">
        <!-- Style Categories Sidebar -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>Categories</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <button type="button" class="list-group-item list-group-item-action active" data-category="all">
                            All Styles
                        </button>
                        <button type="button" class="list-group-item list-group-item-action" data-category="vlog">
                            <i class="fas fa-video me-2"></i> Vlog
                        </button>
                        <button type="button" class="list-group-item list-group-item-action" data-category="chill">
                            <i class="fas fa-umbrella-beach me-2"></i> Chill
                        </button>
                        <button type="button" class="list-group-item list-group-item-action" data-category="cinematic">
                            <i class="fas fa-film me-2"></i> Cinematic
                        </button>
                        <button type="button" class="list-group-item list-group-item-action" data-category="hype">
                            <i class="fas fa-bolt me-2"></i> Hype
                        </button>
                        <button type="button" class="list-group-item list-group-item-action" data-category="trending">
                            <i class="fas fa-chart-line me-2"></i> Trending
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Style Tiles Grid -->
        <div class="col-lg-9 col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Style Presets</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showPreviewsSwitch" checked>
                        <label class="form-check-label" for="showPreviewsSwitch">Show Previews</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3" id="styleGrid">
                        <!-- Vlog Styles -->
                        <div class="col-lg-4 col-md-6 style-tile-wrapper" data-category="vlog">
                            <div class="style-tile" data-style-id="vlog_casual">
                                <div class="style-preview">
                                    <img src="/static/images/styles/vlog_casual.gif" alt="Casual Vlog Style" class="style-preview-img">
                                    <div class="style-play-overlay">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                </div>
                                <div class="style-info">
                                    <h5 class="style-name">Casual Vlog</h5>
                                    <p class="style-description">Clean cuts with subtle transitions, perfect for daily vlogs and lifestyle content.</p>
                                    <div class="style-tags">
                                        <span class="badge bg-primary">Vlog</span>
                                        <span class="badge bg-secondary">Casual</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-select-style">Select</button>
                            </div>
                        </div>
                        
                        <div class="col-lg-4 col-md-6 style-tile-wrapper" data-category="vlog">
                            <div class="style-tile" data-style-id="vlog_travel">
                                <div class="style-preview">
                                    <img src="/static/images/styles/vlog_travel.gif" alt="Travel Vlog Style" class="style-preview-img">
                                    <div class="style-play-overlay">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                </div>
                                <div class="style-info">
                                    <h5 class="style-name">Travel Vlog</h5>
                                    <p class="style-description">Dynamic transitions with location text overlays, ideal for travel content.</p>
                                    <div class="style-tags">
                                        <span class="badge bg-primary">Vlog</span>
                                        <span class="badge bg-info">Travel</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-select-style">Select</button>
                            </div>
                        </div>
                        
                        <!-- Chill Styles -->
                        <div class="col-lg-4 col-md-6 style-tile-wrapper" data-category="chill">
                            <div class="style-tile" data-style-id="chill_lofi">
                                <div class="style-preview">
                                    <img src="/static/images/styles/chill_lofi.gif" alt="Lo-Fi Chill Style" class="style-preview-img">
                                    <div class="style-play-overlay">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                </div>
                                <div class="style-info">
                                    <h5 class="style-name">Lo-Fi Chill</h5>
                                    <p class="style-description">Smooth transitions with a vintage grain effect, perfect for relaxing content.</p>
                                    <div class="style-tags">
                                        <span class="badge bg-primary">Chill</span>
                                        <span class="badge bg-secondary">Lo-Fi</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-select-style">Select</button>
                            </div>
                        </div>
                        
                        <div class="col-lg-4 col-md-6 style-tile-wrapper" data-category="chill">
                            <div class="style-tile" data-style-id="chill_minimalist">
                                <div class="style-preview">
                                    <img src="/static/images/styles/chill_minimalist.gif" alt="Minimalist Chill Style" class="style-preview-img">
                                    <div class="style-play-overlay">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                </div>
                                <div class="style-info">
                                    <h5 class="style-name">Minimalist</h5>
                                    <p class="style-description">Clean, simple transitions with minimal text overlays for a modern aesthetic.</p>
                                    <div class="style-tags">
                                        <span class="badge bg-primary">Chill</span>
                                        <span class="badge bg-secondary">Minimalist</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-select-style">Select</button>
                            </div>
                        </div>
                        
                        <!-- Cinematic Styles -->
                        <div class="col-lg-4 col-md-6 style-tile-wrapper" data-category="cinematic">
                            <div class="style-tile" data-style-id="cinematic_film">
                                <div class="style-preview">
                                    <img src="/static/images/styles/cinematic_film.gif" alt="Film Cinematic Style" class="style-preview-img">
                                    <div class="style-play-overlay">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                </div>
                                <div class="style-info">
                                    <h5 class="style-name">Film Noir</h5>
                                    <p class="style-description">Dramatic lighting effects with film grain and cinematic letterboxing.</p>
                                    <div class="style-tags">
                                        <span class="badge bg-primary">Cinematic</span>
                                        <span class="badge bg-secondary">Film</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-select-style">Select</button>
                            </div>
                        </div>
                        
                        <div class="col-lg-4 col-md-6 style-tile-wrapper" data-category="cinematic">
                            <div class="style-tile" data-style-id="cinematic_epic">
                                <div class="style-preview">
                                    <img src="/static/images/styles/cinematic_epic.gif" alt="Epic Cinematic Style" class="style-preview-img">
                                    <div class="style-play-overlay">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                </div>
                                <div class="style-info">
                                    <h5 class="style-name">Epic</h5>
                                    <p class="style-description">Slow-motion effects with dramatic zoom transitions and color grading.</p>
                                    <div class="style-tags">
                                        <span class="badge bg-primary">Cinematic</span>
                                        <span class="badge bg-danger">Epic</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-select-style">Select</button>
                            </div>
                        </div>
                        
                        <!-- Hype Styles -->
                        <div class="col-lg-4 col-md-6 style-tile-wrapper" data-category="hype">
                            <div class="style-tile" data-style-id="hype_energetic">
                                <div class="style-preview">
                                    <img src="/static/images/styles/hype_energetic.gif" alt="Energetic Hype Style" class="style-preview-img">
                                    <div class="style-play-overlay">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                </div>
                                <div class="style-info">
                                    <h5 class="style-name">Energetic</h5>
                                    <p class="style-description">Fast-paced cuts synchronized with beats, zoom flashes and dynamic text.</p>
                                    <div class="style-tags">
                                        <span class="badge bg-primary">Hype</span>
                                        <span class="badge bg-danger">Energetic</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-select-style">Select</button>
                            </div>
                        </div>
                        
                        <div class="col-lg-4 col-md-6 style-tile-wrapper" data-category="hype">
                            <div class="style-tile" data-style-id="hype_glitch">
                                <div class="style-preview">
                                    <img src="/static/images/styles/hype_glitch.gif" alt="Glitch Hype Style" class="style-preview-img">
                                    <div class="style-play-overlay">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                </div>
                                <div class="style-info">
                                    <h5 class="style-name">Glitch</h5>
                                    <p class="style-description">Digital glitch effects with VHS artifacts and RGB splits, perfect for tech and gaming.</p>
                                    <div class="style-tags">
                                        <span class="badge bg-primary">Hype</span>
                                        <span class="badge bg-warning text-dark">Glitch</span>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-select-style">Select</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Style Suggestion Button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-primary btn-lg" id="suggestStyleBtn">
                            <i class="fas fa-magic me-2"></i> Let AI Suggest a Style
                        </button>
                        <p class="text-muted mt-2"><small>Based on your music track and content</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Style Preview Modal -->
<div class="modal fade" id="stylePreviewModal" tabindex="-1" aria-labelledby="stylePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stylePreviewModalLabel">Style Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="style-preview-container">
                    <video id="stylePreviewVideo" controls class="img-fluid w-100">
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="style-details mt-3">
                    <h4 id="modalStyleName"></h4>
                    <p id="modalStyleDescription"></p>
                    <div id="modalStyleTags"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="modalSelectStyleBtn">Select this Style</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Style Selector specific styles */
    .style-tile-wrapper {
        margin-bottom: 1.5rem;
    }
    
    .style-tile {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: #fff;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .style-tile:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    .style-tile.selected {
        border: 2px solid #0d6efd;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.25);
    }
    
    .style-preview {
        position: relative;
        height: 180px;
        overflow: hidden;
        background-color: #f0f0f0;
    }
    
    .style-preview-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .style-tile:hover .style-preview-img {
        transform: scale(1.05);
    }
    
    .style-play-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .style-tile:hover .style-play-overlay {
        opacity: 1;
    }
    
    .style-play-overlay i {
        font-size: 3rem;
        color: #fff;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .style-info {
        padding: 1rem;
        flex-grow: 1;
    }
    
    .style-name {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
    }
    
    .style-description {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.75rem;
    }
    
    .style-tags {
        margin-bottom: 0.75rem;
    }
    
    .style-tags .badge {
        margin-right: 0.25rem;
    }
    
    .btn-select-style {
        margin: 0 1rem 1rem;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables
    const styleGrid = document.getElementById('styleGrid');
    const showPreviewsSwitch = document.getElementById('showPreviewsSwitch');
    const categoryButtons = document.querySelectorAll('[data-category]');
    const styleTiles = document.querySelectorAll('.style-tile');
    const stylePreviews = document.querySelectorAll('.style-preview');
    const suggestStyleBtn = document.getElementById('suggestStyleBtn');
    
    // Style Preview Modal Elements
    const stylePreviewModal = new bootstrap.Modal(document.getElementById('stylePreviewModal'));
    const stylePreviewVideo = document.getElementById('stylePreviewVideo');
    const modalStyleName = document.getElementById('modalStyleName');
    const modalStyleDescription = document.getElementById('modalStyleDescription');
    const modalStyleTags = document.getElementById('modalStyleTags');
    const modalSelectStyleBtn = document.getElementById('modalSelectStyleBtn');
    
    let selectedStyleId = null;
    
    // Initialize
    function init() {
        // Restore previously selected style if any
        const savedStyleId = sessionStorage.getItem('selectedStyleId');
        if (savedStyleId) {
            selectStyle(savedStyleId);
        }
        
        // Preview toggle functionality
        if (showPreviewsSwitch) {
            showPreviewsSwitch.addEventListener('change', togglePreviews);
        }
        
        // Category filter functionality
        categoryButtons.forEach(button => {
            button.addEventListener('click', function() {
                const category = this.dataset.category;
                
                // Update active button
                categoryButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Filter tiles
                filterStyles(category);
            });
        });
        
        // Style tile selection
        styleTiles.forEach(tile => {
            const selectBtn = tile.querySelector('.btn-select-style');
            const styleId = tile.dataset.styleId;
            
            if (selectBtn) {
                selectBtn.addEventListener('click', function() {
                    selectStyle(styleId);
                });
            }
            
            // Add click event for preview
            const previewElement = tile.querySelector('.style-preview');
            if (previewElement) {
                previewElement.addEventListener('click', function() {
                    openStylePreview(styleId);
                });
            }
        });
        
        // Suggest style button
        if (suggestStyleBtn) {
            suggestStyleBtn.addEventListener('click', suggestStyle);
        }
        
        // Modal select button
        if (modalSelectStyleBtn) {
            modalSelectStyleBtn.addEventListener('click', function() {
                if (selectedStyleId) {
                    selectStyle(selectedStyleId);
                    stylePreviewModal.hide();
                }
            });
        }
    }
    
    // Function to toggle GIF previews
    function togglePreviews() {
        const showPreviews = showPreviewsSwitch.checked;
        
        stylePreviews.forEach(preview => {
            const img = preview.querySelector('img');
            if (img) {
                // If turned off, pause GIFs by switching to a still frame
                if (!showPreviews) {
                    const gifSrc = img.src;
                    const stillSrc = gifSrc.replace('.gif', '-still.jpg');
                    img.dataset.gifSrc = gifSrc; // Store original GIF source
                    img.src = stillSrc;
                } else {
                    // If turned on, restore GIFs
                    if (img.dataset.gifSrc) {
                        img.src = img.dataset.gifSrc;
                    }
                }
            }
        });
    }
    
    // Function to filter styles by category
    function filterStyles(category) {
        const wrappers = document.querySelectorAll('.style-tile-wrapper');
        
        wrappers.forEach(wrapper => {
            if (category === 'all' || wrapper.dataset.category === category) {
                wrapper.style.display = '';
            } else {
                wrapper.style.display = 'none';
            }
        });
    }
    
    // Function to select a style
    function selectStyle(styleId) {
        selectedStyleId = styleId;
        
        // Update visual state
        styleTiles.forEach(tile => {
            if (tile.dataset.styleId === styleId) {
                tile.classList.add('selected');
                
                // Store selected style info
                const styleName = tile.querySelector('.style-name').textContent;
                sessionStorage.setItem('selectedStyleId', styleId);
                sessionStorage.setItem('selectedStyleName', styleName);
                
                // Show success message
                showToast(`Selected style: ${styleName}`);
            } else {
                tile.classList.remove('selected');
            }
        });
    }
    
    // Function to open style preview modal
    function openStylePreview(styleId) {
        selectedStyleId = styleId;
        
        // Find the style tile
        const styleTile = document.querySelector(`.style-tile[data-style-id="${styleId}"]`);
        if (styleTile) {
            const name = styleTile.querySelector('.style-name').textContent;
            const description = styleTile.querySelector('.style-description').textContent;
            const tagsHtml = styleTile.querySelector('.style-tags').innerHTML;
            
            // Set modal content
            modalStyleName.textContent = name;
            modalStyleDescription.textContent = description;
            modalStyleTags.innerHTML = tagsHtml;
            
            // Set video source
            const videoSrc = `/static/videos/style-previews/${styleId}.mp4`;
            stylePreviewVideo.src = videoSrc;
            stylePreviewVideo.load();
            
            // Show modal
            stylePreviewModal.show();
            
            // Auto-play video when modal is shown
            document.getElementById('stylePreviewModal').addEventListener('shown.bs.modal', function () {
                stylePreviewVideo.play().catch(e => console.log('Auto-play prevented:', e));
            });
        }
    }
    
    // Function to suggest a style based on selected content
    function suggestStyle() {
        const selectedTrackId = sessionStorage.getItem('selectedTrackId');
        
        if (!selectedTrackId) {
            showToast('Please select a music track first to get style suggestions.', 'warning');
            return;
        }
        
        // Show loading state
        suggestStyleBtn.disabled = true;
        suggestStyleBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';
        
        // Call AI suggestion API
        fetch('/api/styles/suggest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                track_id: selectedTrackId,
                // Add any other content info that might be available
                uploaded_images: sessionStorage.getItem('uploadedImageCount') || 0
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.suggested_style_id) {
                // Select the suggested style
                selectStyle(data.suggested_style_id);
                
                // Show the preview modal
                openStylePreview(data.suggested_style_id);
                
                // Show success message
                showToast('AI has suggested a style based on your content!', 'success');
            } else {
                throw new Error('No style suggestion received');
            }
        })
        .catch(error => {
            console.error('Error suggesting style:', error);
            showToast('Could not suggest a style. Please select one manually.', 'error');
        })
        .finally(() => {
            // Reset button state
            suggestStyleBtn.disabled = false;
            suggestStyleBtn.innerHTML = '<i class="fas fa-magic me-2"></i> Let AI Suggest a Style';
        });
    }
    
    // Toast notification helper
    function showToast(message, type = 'info') {
        // Create toast element if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Set toast class based on type
        let bgClass = 'bg-primary text-white';
        if (type === 'success') bgClass = 'bg-success text-white';
        if (type === 'warning') bgClass = 'bg-warning text-dark';
        if (type === 'error') bgClass = 'bg-danger text-white';
        
        // Create new toast
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast ${bgClass}" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Nova Sounds</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // Initialize and show the toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();
        
        // Remove toast after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    // Initialize the component
    init();
});
</script>
{% endblock %} 