<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music-Responsive Video Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Tapfiliate Affiliate SDK -->
    <script>
        (function(t, a, p) {
            t.TapfiliateObject = a;
            t[a] = t[a] || function() {
                (t[a].q = t[a].q || []).push(arguments)
            };
        })(window, 'tap');
        
        tap('create', 'TAPFILIATE_ACCOUNT_ID', { integration: 'javascript' });
        tap('detect');
    </script>
    
    <style>
        /* Base styles */
        :root {
            --primary-color: #0d6efd;
            --hover-shadow: 0 10px 20px rgba(0,0,0,0.1);
            --primary-bg-light: rgba(13, 110, 253, 0.05);
            --border-radius: 8px;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --info-color: #0dcaf0;
            --warning-color: #ffc107;
        }

        /* Card styles */
        .preset-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        
        .preset-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }
        
        .preset-card.selected {
            border: 2px solid var(--primary-color);
            background-color: var(--primary-bg-light);
        }
        
        /* Preview styles */
        .preview-container {
            position: relative;
            width: 100%;
            padding-top: 177.78%; /* 16:9 aspect ratio */
            background-color: #000;
            overflow: hidden;
            border-radius: var(--border-radius);
        }
        
        .preview-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        /* File upload button styling */
        .custom-file-button input[type=file] {
            margin-left: -2px !important;
        }
        
        .custom-file-button input[type=file]::-webkit-file-upload-button,
        .custom-file-button input[type=file]::file-selector-button {
            display: none;
        }
        
        .custom-file-button label {
            cursor: pointer;
        }
        
        /* Progress styles */
        .progress-container {
            margin-top: 20px;
            display: none;
        }
        
        #statusMessage {
            margin-top: 10px;
        }

        /* Analytics Dashboard styles */
        .metric-card {
            transition: transform 0.2s;
            border-left: 4px solid var(--primary-color);
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .metric-trend {
            font-size: 0.9rem;
        }
        
        .trend-up {
            color: var(--success-color);
        }
        
        .trend-down {
            color: var(--danger-color);
        }

        .metric-primary {
            border-left-color: var(--primary-color);
        }
        
        .metric-success {
            border-left-color: var(--success-color);
        }
        
        .metric-info {
            border-left-color: var(--info-color);
        }
        
        .metric-warning {
            border-left-color: var(--warning-color);
        }

        .nav-tabs .nav-link {
            color: var(--secondary-color);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 500;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .nav-icon {
            margin-right: 0.5rem;
        }
        
        /* Calendar styles */
        .calendar-container {
            height: 650px;
            background-color: #fff;
            border-radius: var(--border-radius);
        }
        
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .time-slot {
            text-align: center;
            padding: 8px 0;
            transition: all 0.2s;
        }
        
        .time-slot.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .time-slot.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .selected-date-display {
            padding: 8px 12px;
            background-color: var(--primary-bg-light);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
        }

        /* Licensing UI styles */
        .spin {
            animation: spinner 1s linear infinite;
        }

        @keyframes spinner {
            to {
                transform: rotate(360deg);
            }
        }

        /* Make selected plan stand out */
        .list-group-item.active small.text-white {
            opacity: 0.8;
        }

        /* Style for license features */
        .badge.bg-success {
            background-color: var(--success-color) !important;
        }

        .badge.bg-warning {
            color: #212529 !important;
            background-color: var(--warning-color) !important;
        }

        /* Video preview styles */
        .video-preview-container {
            max-width: 360px;
            margin: 0 auto;
            background-color: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .platform-frame {
            position: relative;
            display: none;
        }
        
        .platform-frame.active {
            display: block;
        }
        
        .platform-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            color: white;
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        /* YouTube specific styles */
        .youtube-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        
        .youtube-footer {
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        
        /* TikTok specific styles */
        .tiktok-right-controls {
            position: absolute;
            right: 12px;
            bottom: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .tiktok-control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
        }
        
        .tiktok-control-item i {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }
        
        .tiktok-footer {
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        
        /* Instagram specific styles */
        .instagram-header {
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        
        .instagram-footer {
            padding: 8px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        
        .instagram-username {
            font-weight: bold;
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <header class="mb-4">
            <h1 class="mb-3">Music-Responsive Video Generator</h1>
            <p class="lead">Create videos that respond to music with synchronized effects</p>
        </header>
        
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="creator-tab" data-bs-toggle="tab" data-bs-target="#creator" type="button" role="tab" aria-controls="creator" aria-selected="true">
                    <i class="bi bi-film nav-icon"></i>Video Creator
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab" aria-controls="analytics" aria-selected="false">
                    <i class="bi bi-graph-up nav-icon"></i>Analytics Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="platforms-tab" data-bs-toggle="pill" data-bs-target="#platforms" type="button" role="tab" aria-controls="platforms" aria-selected="false">
                    <i class="bi bi-share nav-icon"></i>Platform Distribution
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="licensing-tab" data-bs-toggle="pill" data-bs-target="#licensing" type="button" role="tab" aria-controls="licensing" aria-selected="false">
                    <i class="bi bi-key nav-icon"></i>Licensing
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trends-tab" data-bs-toggle="pill" data-bs-target="#trends" type="button" role="tab" aria-controls="trends" aria-selected="false">
                    <i class="bi bi-lightning-charge nav-icon"></i>Trends & Insights
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="predictions-tab" data-bs-toggle="pill" data-bs-target="#predictions" type="button" role="tab" aria-controls="predictions" aria-selected="false">
                    <i class="bi bi-graph-up nav-icon"></i>Performance Prediction
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schedule-tab" data-bs-toggle="pill" data-bs-target="#schedule" type="button" role="tab" aria-controls="schedule" aria-selected="false">
                    <i class="bi bi-calendar-event nav-icon"></i>Content Calendar
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="mainTabsContent">
            <!-- Video Creator Tab -->
            <div class="tab-pane fade show active" id="creator" role="tabpanel" aria-labelledby="creator-tab">
                <div class="row">
                    <main class="col-lg-8">
                        <!-- Main Form -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <form id="videoForm" enctype="multipart/form-data">
                                    <section>
                                        <h5 class="card-title mb-4">1. Upload Media</h5>
                                        
                                        <!-- Images Upload -->
                                        <div class="mb-4">
                                            <label for="images" class="form-label">Upload Images (at least 5 recommended)</label>
                                            <div class="input-group custom-file-button">
                                                <label class="input-group-text" for="images">Choose Images</label>
                                                <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple required>
                                            </div>
                                            <div id="imagePreviewContainer" class="d-flex flex-wrap mt-3"></div>
                                        </div>
                                        
                                        <!-- Music Upload -->
                                        <div class="mb-4">
                                            <label for="music" class="form-label">Upload Music</label>
                                            <div class="input-group custom-file-button">
                                                <label class="input-group-text" for="music">Choose Music</label>
                                                <input type="file" class="form-control" id="music" name="music" accept="audio/*" required>
                                            </div>
                                            <div id="musicPreview" class="mt-3"></div>
                                        </div>
                                    </section>
                                    
                                    <section>
                                        <h5 class="card-title mb-4">2. Choose Style Preset</h5>
                                        
                                        <!-- Style Preset Selector -->
                                        <div class="mb-4">
                                            <label for="stylePreset" class="form-label">Select Style Preset</label>
                                            <select class="form-select" id="stylePreset">
                                                <option value="vlog">Vlog Style</option>
                                                <option value="hype">Hype Style</option>
                                                <option value="chill">Chill Style</option>
                                                <option value="cinematic">Cinematic Style</option>
                                                <option value="minimal">Minimal Style</option>
                                                <option value="retro">Retro Style</option>
                                            </select>
                                        </div>
                                    </section>
                                    
                                    <section>
                                        <h5 class="card-title mb-4">3. Adjust Settings</h5>
                                        
                                        <!-- Effect Settings -->
                                        <div class="mb-4">
                                            <label for="effectIntensity" class="form-label">Effect Intensity: <span id="intensityValue">1.0</span></label>
                                            <input type="range" class="form-range" min="0.1" max="2" step="0.1" id="effectIntensity" name="effect_intensity" value="1.0">
                                            <div class="form-text">Lower values create subtle effects, higher values create more dramatic effects</div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <label for="duration" class="form-label">Maximum Duration (seconds)</label>
                                            <input type="number" class="form-control" id="duration" name="duration" min="5" max="300" value="60">
                                        </div>
                                        
                                        <div class="mb-4 form-check">
                                            <input class="form-check-input" type="checkbox" id="smoothTransitions" name="use_smooth_transitions" checked>
                                            <label class="form-check-label" for="smoothTransitions">Use smooth transitions between images</label>
                                        </div>
                                    </section>
                                    
                                    <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">Generate Video</button>
                                </form>
                                
                                <!-- Progress and Status -->
                                <div class="progress-container">
                                    <div class="progress" style="height: 20px;">
                                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
                                    </div>
                                    <p id="statusMessage" class="text-center"></p>
                                    <div id="downloadContainer" class="text-center mt-4" style="display: none;">
                                        <a id="downloadBtn" href="#" class="btn btn-success" download>Download Video</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    <aside class="col-lg-4">
                        <!-- Preview and Help Section -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Preview</h5>
                                <div class="preview-container mb-3">
                                    <img src="/static/placeholder.jpg" alt="Preview" class="preview-image" id="previewImage">
                                </div>
                                <h6 id="presetTitle" class="mt-3">Standard Preset</h6>
                                <p id="presetDescription" class="text-muted">Balanced effects for general use</p>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Tips</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">Upload at least 5 images for best results</li>
                                    <li class="list-group-item">Choose a preset that matches your music genre</li>
                                    <li class="list-group-item">For subtle effects, reduce the intensity below 1.0</li>
                                    <li class="list-group-item">For dramatic effects, increase the intensity above 1.0</li>
                                    <li class="list-group-item">Processing may take several minutes depending on duration</li>
                                </ul>
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
            
            <!-- Analytics Dashboard Tab -->
            <div class="tab-pane fade" id="analytics" role="tabpanel" aria-labelledby="analytics-tab">
                <!-- Loading and Error States -->
                <div id="analytics-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading analytics data...</p>
                </div>
                
                <div id="analytics-error" class="error-container my-5" style="display: none;">
                    <div class="error-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <h4 class="mb-3">Unable to load analytics data</h4>
                    <p class="mb-4">We encountered an error while trying to fetch your analytics data. Please try again later.</p>
                    <button id="retry-analytics-btn" class="btn btn-primary">Retry</button>
                </div>
                
                <!-- Main Dashboard Content -->
                <div id="analytics-content" class="container-fluid py-4" style="display: none;">
                    <!-- Performance Overview Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card metric-card metric-primary">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-0">Total Views</p>
                                            <h3 class="metric-value mb-0" id="totalViewsValue">0</h3>
                                        </div>
                                        <div class="metric-icon">
                                            <i class="bi bi-eye fs-1 text-primary opacity-50"></i>
                                        </div>
                                    </div>
                                    <div class="metric-trend">
                                        <span class="trend-up"><i class="bi bi-arrow-up"></i> <span id="viewsTrendValue">0</span>%</span> from last month
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card metric-success">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-0">Total Likes</p>
                                            <h3 class="metric-value mb-0" id="totalLikesValue">0</h3>
                                        </div>
                                        <div class="metric-icon">
                                            <i class="bi bi-hand-thumbs-up fs-1 text-success opacity-50"></i>
                                        </div>
                                    </div>
                                    <div class="metric-trend">
                                        <span class="trend-up"><i class="bi bi-arrow-up"></i> <span id="likesTrendValue">0</span>%</span> from last month
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card metric-info">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-0">Videos Generated</p>
                                            <h3 class="metric-value mb-0" id="videosGeneratedValue">0</h3>
                                        </div>
                                        <div class="metric-icon">
                                            <i class="bi bi-film fs-1 text-info opacity-50"></i>
                                        </div>
                                    </div>
                                    <div class="metric-trend">
                                        <span class="trend-up"><i class="bi bi-arrow-up"></i> <span id="videosTrendValue">0</span>%</span> from last month
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card metric-warning">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-0">Engagement Rate</p>
                                            <h3 class="metric-value mb-0" id="engagementRateValue">0%</h3>
                                        </div>
                                        <div class="metric-icon">
                                            <i class="bi bi-graph-up-arrow fs-1 text-warning opacity-50"></i>
                                        </div>
                                    </div>
                                    <div class="metric-trend">
                                        <span class="trend-up"><i class="bi bi-arrow-up"></i> <span id="engagementTrendValue">0</span>%</span> from last month
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Previously Generated Videos -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Your Generated Videos</h5>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="refreshVideosBtn">
                                                <i class="bi bi-arrow-clockwise"></i> Refresh
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#filterVideosModal">
                                                <i class="bi bi-funnel"></i> Filter
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 30%">Video</th>
                                                    <th>Title</th>
                                                    <th>Platform</th>
                                                    <th>Created</th>
                                                    <th>Views</th>
                                                    <th>Likes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="generatedVideosList">
                                                <!-- Generated videos will be populated here -->
                                                <tr>
                                                    <td colspan="7" class="text-center py-4">Loading your videos...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer bg-white">
                                    <nav aria-label="Video pagination">
                                        <ul class="pagination justify-content-center mb-0">
                                            <li class="page-item disabled">
                                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                            </li>
                                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                                            <li class="page-item">
                                                <a class="page-link" href="#">Next</a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Views by Platform</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="platformViewsChart" class="chart-container"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Top Performing Music Tracks</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Track</th>
                                                    <th>Genre</th>
                                                    <th>Videos</th>
                                                    <th>Total Views</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topTracksTable">
                                                <!-- Top tracks will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Affiliate Stats -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Affiliate Performance</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body text-center">
                                                    <h6 class="text-muted">Total Referrals</h6>
                                                    <h2 class="display-5 fw-bold text-primary" id="dashboardReferralsValue">0</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body text-center">
                                                    <h6 class="text-muted">Total Earnings</h6>
                                                    <h2 class="display-5 fw-bold text-success" id="dashboardEarningsValue">$0.00</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body text-center">
                                                    <h6 class="text-muted">Conversion Rate</h6>
                                                    <h2 class="display-5 fw-bold text-info" id="dashboardConversionRateValue">0%</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <a href="/affiliate-dashboard" class="btn btn-outline-primary">View Full Affiliate Dashboard</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Platform Distribution Tab -->
            <div class="tab-pane fade" id="platforms" role="tabpanel" aria-labelledby="platforms-tab">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Platform Distribution</h5>
                                <canvas id="platformDistributionChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Success Rate by Platform</h5>
                                <canvas id="platformSuccessChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Recent Platform Distributions</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="platformDistributionsTable">
                                        <thead>
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>Platform</th>
                                                <th>Status</th>
                                                <th>Processing Time</th>
                                                <th>File Size</th>
                                                <th>Resolution</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Dynamically populated -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trends & Insights Tab -->
            <div class="tab-pane fade" id="trends" role="tabpanel" aria-labelledby="trends-tab">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Trending Presets</h5>
                                <canvas id="trendingPresetsChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Trending Effects</h5>
                                <canvas id="trendingEffectsChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Content Recommendations</h5>
                                <div id="recommendationsContainer" class="row">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Prediction Tab -->
            <div class="tab-pane fade" id="predictions" role="tabpanel" aria-labelledby="predictions-tab">
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Predict Performance</h5>
                                <p class="card-text">Estimate how well your video will perform before publishing it.</p>
                                
                                <form id="predictionForm" class="mt-4">
                                    <div class="mb-3">
                                        <label for="predictionDuration" class="form-label">Video Duration (seconds)</label>
                                        <input type="range" class="form-range" min="15" max="300" step="15" id="predictionDuration" value="60">
                                        <div class="d-flex justify-content-between">
                                            <span>15s</span>
                                            <span id="durationValue">60s</span>
                                            <span>300s</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="predictionPreset" class="form-label">Style Preset</label>
                                        <select class="form-select" id="predictionPreset">
                                            <option value="standard">Standard</option>
                                            <option value="subtle">Subtle</option>
                                            <option value="energetic">Energetic</option>
                                            <option value="dramatic">Dramatic</option>
                                            <option value="cinematic">Cinematic</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Effects (select all that apply)</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="pulse" id="effectPulse">
                                                    <label class="form-check-label" for="effectPulse">Pulse</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="zoom" id="effectZoom">
                                                    <label class="form-check-label" for="effectZoom">Zoom</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="shake" id="effectShake">
                                                    <label class="form-check-label" for="effectShake">Shake</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="flash" id="effectFlash">
                                                    <label class="form-check-label" for="effectFlash">Flash</label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="color_shift" id="effectColorShift">
                                                    <label class="form-check-label" for="effectColorShift">Color Shift</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="blur" id="effectBlur">
                                                    <label class="form-check-label" for="effectBlur">Blur</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="warp" id="effectWarp">
                                                    <label class="form-check-label" for="effectWarp">Warp</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="glitch" id="effectGlitch">
                                                    <label class="form-check-label" for="effectGlitch">Glitch</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="predictionTempo" class="form-label">Music Tempo (BPM): <span id="tempoValue">120</span></label>
                                        <input type="range" class="form-range" min="60" max="180" step="5" id="predictionTempo" value="120">
                                        <div class="d-flex justify-content-between">
                                            <span>Slow (60)</span>
                                            <span>Medium (120)</span>
                                            <span>Fast (180)</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="predictionEnergy" class="form-label">Music Energy Level: <span id="energyValue">Medium</span></label>
                                        <input type="range" class="form-range" min="1" max="10" step="1" id="predictionEnergy" value="5">
                                        <div class="d-flex justify-content-between">
                                            <span>Calm</span>
                                            <span>Medium</span>
                                            <span>Intense</span>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">Predict Performance</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Prediction Results</h5>
                                
                                <div id="noPrediction" class="text-center py-5">
                                    <i class="bi bi-graph-up-arrow" style="font-size: 3rem; color: #6c757d;"></i>
                                    <p class="mt-3">Fill out the form and click "Predict Performance" to see engagement predictions.</p>
                                </div>
                                
                                <div id="predictionResults" class="d-none">
                                    <div class="text-center mb-4">
                                        <h2 class="display-4" id="engagementScore">0.0</h2>
                                        <p class="lead" id="performanceCategory">Calculating...</p>
                                        <div class="progress mt-3" style="height: 20px;">
                                            <div id="engagementBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="10"></div>
                                        </div>
                                        <p class="text-muted mt-2">
                                            Prediction confidence: <span id="predictionConfidence">0%</span>
                                        </p>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6 class="card-subtitle mb-3">Recommendations to Improve Performance</h6>
                                        <ul id="recommendationsList" class="list-group">
                                            <li class="list-group-item">Loading recommendations...</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                            <button id="applyRecommendationsBtn" class="btn btn-outline-primary">Apply Recommendations</button>
                                            <button id="generateWithCurrentSettingsBtn" class="btn btn-primary">Generate with Current Settings</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">A/B Testing</h5>
                                <p class="card-text">Create multiple variants of your video with different settings to test performance.</p>
                                
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Create Variants</h6>
                                        <form id="abTestForm">
                                            <div class="mb-3">
                                                <label class="form-label">Parameters to Test</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="preset" id="testPreset" checked>
                                                    <label class="form-check-label" for="testPreset">Style Preset</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="effects" id="testEffects" checked>
                                                    <label class="form-check-label" for="testEffects">Effects</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="intensity" id="testIntensity">
                                                    <label class="form-check-label" for="testIntensity">Effect Intensity</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="transitions" id="testTransitions">
                                                    <label class="form-check-label" for="testTransitions">Transition Style</label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="variantCount" class="form-label">Number of Variants</label>
                                                <select class="form-select" id="variantCount">
                                                    <option value="2">2 variants</option>
                                                    <option value="3">3 variants</option>
                                                    <option value="4">4 variants</option>
                                                </select>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary">Generate Variants</button>
                                        </form>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Test Results</h6>
                                        <div id="noABTest" class="text-center py-5">
                                            <i class="bi bi-bar-chart" style="font-size: 3rem; color: #6c757d;"></i>
                                            <p class="mt-3">Generate variants to see performance comparison.</p>
                                        </div>
                                        
                                        <div id="abTestResults" class="d-none">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Variant</th>
                                                            <th>Changes</th>
                                                            <th>Score</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="variantsTableBody">
                                                        <!-- Dynamically populated -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Licensing Tab -->
            <div class="tab-pane fade" id="licensing" role="tabpanel" aria-labelledby="licensing-tab">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- License Information Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">License Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info" id="licenseStatusAlert">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span id="licenseStatusMessage">Your Professional license is active until December 31, 2023</span>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">License Type</label>
                                            <p id="licenseType">Professional</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Expiration Date</label>
                                            <p id="licenseExpiration">December 31, 2023</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">License Key</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="licenseKey" value="XXXX-XXXX-XXXX-XXXX" readonly>
                                                <button class="btn btn-outline-secondary" type="button" id="viewLicenseKeyBtn">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Registered To</label>
                                            <p id="licenseOwner">John Doe (john.doe@example.com)</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Active Devices</label>
                                            <p id="activeDevices">2 of 3 allowed</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Project Exports</label>
                                            <p id="projectExports">Unlimited</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button class="btn btn-primary me-2" id="renewLicenseBtn">
                                        <i class="bi bi-arrow-repeat me-1"></i> Renew License
                                    </button>
                                    <button class="btn btn-outline-primary me-2" id="upgradeLicenseBtn">
                                        <i class="bi bi-arrow-up-circle me-1"></i> Upgrade License
                                    </button>
                                    <button class="btn btn-outline-secondary" id="transferLicenseBtn">
                                        <i class="bi bi-person-plus me-1"></i> Transfer License
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Music Rights Management Card (NEW) -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Music Rights Management</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning mb-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <span>Proper music licensing is essential for monetization on platforms like YouTube and TikTok.</span>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Track</th>
                                                <th>License Type</th>
                                                <th>Platforms</th>
                                                <th>Manage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="musicRightsTableBody">
                                            <tr>
                                                <td>Summer Vibes</td>
                                                <td><span class="badge bg-success">Commercial</span></td>
                                                <td>All Platforms</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" data-track="Summer Vibes">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Urban Beats</td>
                                                <td><span class="badge bg-warning text-dark">Attribution</span></td>
                                                <td>YouTube, TikTok</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" data-track="Urban Beats">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Cinematic Orchestra</td>
                                                <td><span class="badge bg-danger">Personal</span></td>
                                                <td>Non-Commercial Only</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" data-track="Cinematic Orchestra">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-3">
                                    <button class="btn btn-primary" id="importMusicRightsBtn">
                                        <i class="bi bi-cloud-arrow-up me-1"></i> Import Rights Metadata
                                    </button>
                                    <button class="btn btn-outline-primary" id="exportMusicRightsBtn">
                                        <i class="bi bi-cloud-arrow-down me-1"></i> Export Rights Database
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- License Features Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">License Features</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Feature</th>
                                                <th>Status</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Video Exports</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Unlimited exports in up to 4K resolution</td>
                                            </tr>
                                            <tr>
                                                <td>Advanced Effects</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Access to all premium effects and transitions</td>
                                            </tr>
                                            <tr>
                                                <td>Commercial Usage</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Licensed for commercial projects</td>
                                            </tr>
                                            <tr>
                                                <td>Batch Processing</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Process up to 10 videos simultaneously</td>
                                            </tr>
                                            <tr>
                                                <td>Extended Analysis</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Access to advanced analytics and insights</td>
                                            </tr>
                                            <tr>
                                                <td>API Access</td>
                                                <td><span class="badge bg-warning">Limited</span></td>
                                                <td>500 API calls per day (upgrade for more)</td>
                                            </tr>
                                            <!-- New feature for music rights -->
                                            <tr>
                                                <td>Sync Licensing</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Generate and export metadata for all tracks</td>
                                            </tr>
                                            <!-- New feature for watermarking -->
                                            <tr>
                                                <td>Watermark Removal</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Remove Nova Sounds branding from exports</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- License History Card -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">License History</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Action</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Jan 15, 2023</td>
                                                <td>License Purchased</td>
                                                <td>Professional Plan - 1 Year</td>
                                            </tr>
                                            <tr>
                                                <td>Jan 16, 2023</td>
                                                <td>Device Activated</td>
                                                <td>MacBook Pro (John's Laptop)</td>
                                            </tr>
                                            <tr>
                                                <td>Mar 20, 2023</td>
                                                <td>Device Activated</td>
                                                <td>Mac Studio (Office)</td>
                                            </tr>
                                            <tr>
                                                <td>Apr 10, 2023</td>
                                                <td>License Feature Added</td>
                                                <td>Added Batch Processing capability</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Affiliate Program Card (NEW) -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Affiliate Program <span class="badge bg-light text-success ms-2">NEW</span></h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6>Your Affiliate Stats</h6>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="fs-4 fw-bold text-success">0</div>
                                            <div class="small text-muted">Referrals</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-4 fw-bold text-success">$0</div>
                                            <div class="small text-muted">Earned</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-4 fw-bold text-success">20%</div>
                                            <div class="small text-muted">Commission</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-success py-2">
                                    <small><i class="bi bi-info-circle me-1"></i> Earn 20% commission on every referral who subscribes!</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Your Referral Link</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" value="https://novasounds.ai/?ref=johndoe" readonly id="referralLink">
                                        <button class="btn btn-outline-secondary" type="button" id="copyReferralBtn">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Share this link to earn commissions</small>
                                </div>
                                
                                <div class="d-grid mt-3">
                                    <button class="btn btn-success" id="affiliateDashboardBtn">
                                        <i class="bi bi-graph-up me-1"></i> Affiliate Dashboard
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- License Tag Manager Card (NEW) -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">License Tag Manager</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text small mb-3">Define custom license tags for your music tracks to streamline rights management.</p>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autoTagToggle" checked>
                                        <label class="form-check-label" for="autoTagToggle">
                                            Auto-tag tracks on import
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="list-group mb-3">
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        Commercial Use
                                        <span class="badge bg-success rounded-pill">15</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        Attribution Required
                                        <span class="badge bg-warning text-dark rounded-pill">8</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        Personal Use Only
                                        <span class="badge bg-danger rounded-pill">3</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        YouTube Monetizable
                                        <span class="badge bg-primary rounded-pill">12</span>
                                    </a>
                                </div>
                                
                                <button class="btn btn-outline-primary w-100" id="manageLicenseTagsBtn">
                                    <i class="bi bi-tags me-1"></i> Manage Custom Tags
                                </button>
                            </div>
                        </div>
                        
                        <!-- Compare Plans Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Compare Plans</h5>
                            </div>
                            <div class="card-body">
                                <div class="list-group">
                                    <a href="#" class="list-group-item list-group-item-action" aria-current="true">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">Basic</h5>
                                            <span class="badge bg-secondary">$99/year</span>
                                        </div>
                                        <p class="mb-1">Essential features for personal use</p>
                                        <small>720p exports, basic effects, 1 device</small>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action active">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">Professional</h5>
                                            <span class="badge bg-light text-dark">$199/year</span>
                                        </div>
                                        <p class="mb-1">Full features for professional creators</p>
                                        <small class="text-white">4K exports, all effects, 3 devices, commercial use</small>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">Enterprise</h5>
                                            <span class="badge bg-primary">$499/year</span>
                                        </div>
                                        <p class="mb-1">Advanced features for teams</p>
                                        <small>Unlimited everything, 10 devices, priority support</small>
                                    </a>
                                </div>
                                
                                <div class="d-grid mt-3">
                                    <button class="btn btn-success" id="viewAllPlansBtn">View All Plans</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Content Calendar Tab -->
            <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                <div class="container-fluid py-4">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-1">Content Calendar</h3>
                                    <p class="text-muted">Schedule and manage your video publishing for maximum engagement</p>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#batchScheduleModal">
                                        <i class="bi bi-calendar-plus"></i> Batch Schedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Calendar View (Left Side) -->
                        <div class="col-lg-8">
                            <div class="card mb-4">
                                <div class="card-header bg-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="bi bi-calendar-event text-primary me-2"></i>Publishing Calendar</h5>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" id="calendarViewMonthBtn">Month</button>
                                            <button class="btn btn-sm btn-outline-primary" id="calendarViewWeekBtn">Week</button>
                                            <button class="btn btn-sm btn-outline-primary" id="calendarViewListBtn">List</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="schedulingCalendar" class="scheduling-calendar-container"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sidebar (Right Side) -->
                        <div class="col-lg-4">
                            <!-- Time Selector Card -->
                            <div class="card mb-4">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0"><i class="bi bi-clock text-primary me-2"></i>Scheduling Details</h5>
                                </div>
                                <div class="card-body">
                                    <div class="selected-date-info mb-3">
                                        <label class="form-label fw-bold">Selected Date</label>
                                        <div id="schedule-selected-date" class="selected-date-display p-2 border rounded">
                                            <span class="text-muted">Select a date from the calendar</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Time Slots</label>
                                        <div id="schedule-time-slots" class="time-slots-grid">
                                            <div class="text-muted small p-2">Please select a date first</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Platform Selection</label>
                                        <div class="platform-selection">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="platform-youtube" checked>
                                                <label class="form-check-label" for="platform-youtube">
                                                    <i class="bi bi-youtube text-danger"></i> YouTube
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="platform-tiktok">
                                                <label class="form-check-label" for="platform-tiktok">
                                                    <i class="bi bi-tiktok"></i> TikTok
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="platform-instagram">
                                                <label class="form-check-label" for="platform-instagram">
                                                    <i class="bi bi-instagram text-purple"></i> Instagram
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="optimal-time-switch">
                                            <label class="form-check-label" for="optimal-time-switch">
                                                Use AI-recommended optimal time
                                            </label>
                                        </div>
                                        <div class="form-text text-muted small">
                                            Our AI analyzes your audience activity patterns to find the best publishing times.
                                        </div>
                                    </div>
                                    
                                    <div id="optimal-time-recommendations" class="mb-3 p-2 border rounded bg-light" style="display: none;">
                                        <h6 class="mb-2">Recommended Times:</h6>
                                        <ul class="list-unstyled mb-0">
                                            <li><i class="bi bi-youtube text-danger me-1"></i> YouTube: <strong>5:30 PM</strong> (91% audience activity)</li>
                                            <li><i class="bi bi-tiktok me-1"></i> TikTok: <strong>7:15 PM</strong> (87% audience activity)</li>
                                            <li><i class="bi bi-instagram text-purple me-1"></i> Instagram: <strong>8:00 PM</strong> (83% audience activity)</li>
                                        </ul>
                                    </div>
                                    
                                    <button id="schedule-save-btn" class="btn btn-primary w-100" disabled>
                                        <i class="bi bi-calendar-check"></i> Schedule Publishing
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Upcoming Publications Card -->
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0"><i class="bi bi-list-check text-primary me-2"></i>Upcoming Publications</h5>
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush" id="upcoming-publications-list">
                                        <li class="list-group-item text-center py-4">
                                            <i class="bi bi-calendar-x display-6 text-muted"></i>
                                            <p class="mt-2 text-muted">No scheduled publications</p>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // ... existing code ...
    </script>
    
    <!-- Licensing functionality -->
    <script src="/static/js/licensing.js"></script>

    <!-- Music Browser Section -->
    <section class="container mt-5" id="musicBrowser">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Music Browser</h4>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#musicFilters">
                            <i class="bi bi-funnel"></i> Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Music Filters -->
            <div class="collapse" id="musicFilters">
                <div class="card-body border-bottom">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="genreFilter" class="form-label">Genre</label>
                            <select class="form-select" id="genreFilter" multiple>
                                <option value="electronic">Electronic</option>
                                <option value="pop">Pop</option>
                                <option value="hip_hop">Hip Hop</option>
                                <option value="rock">Rock</option>
                                <option value="rnb">R&B</option>
                                <option value="jazz">Jazz</option>
                                <option value="classical">Classical</option>
                                <option value="ambient">Ambient</option>
                                <option value="lo_fi">Lo-Fi</option>
                                <option value="edm">EDM</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="moodFilter" class="form-label">Mood</label>
                            <select class="form-select" id="moodFilter" multiple>
                                <option value="happy">Happy</option>
                                <option value="energetic">Energetic</option>
                                <option value="calm">Calm</option>
                                <option value="melancholic">Melancholic</option>
                                <option value="dark">Dark</option>
                                <option value="uplifting">Uplifting</option>
                                <option value="dramatic">Dramatic</option>
                                <option value="chill">Chill</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="bpmRange" class="form-label">BPM Range</label>
                            <div class="d-flex gap-2">
                                <input type="number" class="form-control" id="bpmMin" placeholder="Min" min="60" max="200">
                                <input type="number" class="form-control" id="bpmMax" placeholder="Max" min="60" max="200">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="licenseFilter" class="form-label">License Type</label>
                            <select class="form-select" id="licenseFilter">
                                <option value="">All Licenses</option>
                                <option value="standard">Standard</option>
                                <option value="premium">Premium</option>
                                <option value="commercial">Commercial</option>
                                <option value="exclusive">Exclusive</option>
                                <option value="creative_commons">Creative Commons</option>
                                <option value="royalty_free">Royalty Free</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                        <button class="btn btn-outline-secondary" id="resetFilters">Reset</button>
                    </div>
                </div>
            </div>
            
            <!-- Music Tracks List with Waveform -->
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="musicTracksList">
                    <!-- Music tracks will be populated here via JavaScript -->
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading music tracks...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Music Track Item Template -->
    <template id="musicTrackTemplate">
        <div class="list-group-item music-track p-3">
            <div class="row align-items-center">
                <div class="col-auto">
                    <button class="btn btn-play btn-sm rounded-circle" data-action="play">
                        <i class="bi bi-play-fill"></i>
                    </button>
                </div>
                <div class="col">
                    <h6 class="mb-0 track-title">Track Title</h6>
                    <small class="text-muted track-artist">Artist Name</small>
                </div>
                <div class="col-md-4">
                    <div class="waveform-container" style="height: 60px;">
                        <!-- Waveform visualization will be inserted here -->
                    </div>
                </div>
                <div class="col-auto d-none d-md-block">
                    <span class="badge bg-primary me-1">Genre</span>
                    <span class="badge bg-secondary me-1">Mood</span>
                    <span class="small text-muted me-2"><i class="bi bi-music-note"></i> <span class="track-bpm">120</span> BPM</span>
                    <span class="small text-muted"><i class="bi bi-clock"></i> <span class="track-duration">0:30</span></span>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-primary" data-action="select">Select</button>
                </div>
            </div>
            <div class="mt-2 license-info small d-none">
                <div class="alert alert-info py-2">
                    <div class="row">
                        <div class="col-md-6">
                            <div><strong>License:</strong> <span class="license-type">Standard</span></div>
                            <div><strong>Attribution:</strong> <span class="attribution-required">Yes</span></div>
                        </div>
                        <div class="col-md-6">
                            <div><strong>Restrictions:</strong> <span class="license-restrictions">None</span></div>
                            <div><strong>Expires:</strong> <span class="license-expiration">Never</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Add JavaScript for the music browser -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize music browser functionality
        initMusicBrowser();
        
        // Initialize analytics dashboard
        initAnalyticsDashboard();
    });

    function initMusicBrowser() {
        // Track loading and filtering functionality will be implemented here
        const applyFilters = document.getElementById('applyFilters');
        const resetFilters = document.getElementById('resetFilters');
        
        applyFilters.addEventListener('click', function() {
            loadMusicTracks();
        });
        
        resetFilters.addEventListener('click', function() {
            document.getElementById('genreFilter').selectedIndex = -1;
            document.getElementById('moodFilter').selectedIndex = -1;
            document.getElementById('bpmMin').value = '';
            document.getElementById('bpmMax').value = '';
            document.getElementById('licenseFilter').selectedIndex = 0;
        });
        
        // Initial load of music tracks
        loadMusicTracks();
    }

    function loadMusicTracks() {
        const tracksList = document.getElementById('musicTracksList');
        const template = document.getElementById('musicTrackTemplate');
        
        // Show loading state
        tracksList.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading music tracks...</p>
            </div>
        `;
        
        // Get filter values
        const genres = Array.from(document.getElementById('genreFilter').selectedOptions).map(o => o.value);
        const moods = Array.from(document.getElementById('moodFilter').selectedOptions).map(o => o.value);
        const bpmMin = document.getElementById('bpmMin').value;
        const bpmMax = document.getElementById('bpmMax').value;
        const licenseType = document.getElementById('licenseFilter').value;
        
        // Build query parameters
        const params = new URLSearchParams();
        if (genres.length) params.append('genres', genres.join(','));
        if (moods.length) params.append('moods', moods.join(','));
        if (bpmMin) params.append('bpm_min', bpmMin);
        if (bpmMax) params.append('bpm_max', bpmMax);
        if (licenseType) params.append('license_type', licenseType);
        
        // Fetch music tracks with filters
        fetch(`/api/music/tracks?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                tracksList.innerHTML = '';
                
                if (data.length === 0) {
                    tracksList.innerHTML = `
                        <div class="text-center p-5">
                            <i class="bi bi-music-note-list fs-1 text-muted"></i>
                            <p class="mt-2">No music tracks found matching your filters.</p>
                        </div>
                    `;
                    return;
                }
                
                data.forEach(track => {
                    const trackElement = template.content.cloneNode(true);
                    
                    // Set track data
                    trackElement.querySelector('.track-title').textContent = track.title;
                    trackElement.querySelector('.track-artist').textContent = track.artist;
                    trackElement.querySelector('.track-bpm').textContent = track.bpm || 'N/A';
                    
                    // Format duration (seconds to MM:SS)
                    const minutes = Math.floor(track.duration / 60);
                    const seconds = track.duration % 60;
                    trackElement.querySelector('.track-duration').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Set license information
                    trackElement.querySelector('.license-type').textContent = track.license_type;
                    trackElement.querySelector('.attribution-required').textContent = 
                        track.attribution_required ? 'Required' : 'Not Required';
                    
                    // Add restrictions if any
                    if (track.license_restrictions && track.license_restrictions.length > 0) {
                        trackElement.querySelector('.license-restrictions').textContent = 
                            track.license_restrictions.join(', ');
                    }
                    
                    // Add expiration if any
                    if (track.license_expiration) {
                        trackElement.querySelector('.license-expiration').textContent = 
                            new Date(track.license_expiration).toLocaleDateString();
                    }
                    
                    // Create badges for genres and moods
                    const badgesContainer = trackElement.querySelector('.col-auto.d-none.d-md-block');
                    badgesContainer.innerHTML = '';
                    
                    if (track.genres && track.genres.length > 0) {
                        track.genres.slice(0, 2).forEach(genre => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-primary me-1';
                            badge.textContent = genre;
                            badgesContainer.appendChild(badge);
                        });
                    }
                    
                    if (track.moods && track.moods.length > 0) {
                        track.moods.slice(0, 2).forEach(mood => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary me-1';
                            badge.textContent = mood;
                            badgesContainer.appendChild(badge);
                        });
                    }
                    
                    // Add BPM and duration
                    const bpmSpan = document.createElement('span');
                    bpmSpan.className = 'small text-muted me-2';
                    bpmSpan.innerHTML = `<i class="bi bi-music-note"></i> <span class="track-bpm">${track.bpm || 'N/A'}</span> BPM`;
                    badgesContainer.appendChild(bpmSpan);
                    
                    const durationSpan = document.createElement('span');
                    durationSpan.className = 'small text-muted';
                    durationSpan.innerHTML = `<i class="bi bi-clock"></i> <span class="track-duration">${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
                    badgesContainer.appendChild(durationSpan);
                    
                    // Set up waveform visualization
                    const waveformContainer = trackElement.querySelector('.waveform-container');
                    if (track.waveform_data) {
                        renderWaveform(waveformContainer, track.waveform_data);
                    } else {
                        waveformContainer.innerHTML = '<div class="text-center text-muted pt-3">Waveform not available</div>';
                    }
                    
                    // Setup play/pause functionality
                    const playButton = trackElement.querySelector('[data-action="play"]');
                    playButton.addEventListener('click', function() {
                        togglePlayTrack(track.id, playButton);
                    });
                    
                    // Setup select functionality
                    const selectButton = trackElement.querySelector('[data-action="select"]');
                    selectButton.addEventListener('click', function() {
                        selectMusicTrack(track);
                    });
                    
                    // Setup license info toggle
                    const trackRow = trackElement.querySelector('.row.align-items-center');
                    trackRow.addEventListener('click', function(e) {
                        if (!e.target.closest('[data-action]')) {
                            const licenseInfo = trackElement.querySelector('.license-info');
                            licenseInfo.classList.toggle('d-none');
                        }
                    });
                    
                    // Add track element to the list
                    tracksList.appendChild(trackElement);
                });
            })
            .catch(error => {
                console.error('Error loading music tracks:', error);
                tracksList.innerHTML = `
                    <div class="text-center p-5">
                        <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
                        <p class="mt-2">Failed to load music tracks. Please try again later.</p>
                    </div>
                `;
            });
    }

    function renderWaveform(container, waveformData) {
        // Simple waveform visualization rendering
        const canvas = document.createElement('canvas');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        container.appendChild(canvas);
        
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#0d6efd';
        
        // Draw simplified waveform if we have data
        if (waveformData && waveformData.data && waveformData.data.length > 0) {
            const data = waveformData.data;
            const width = canvas.width;
            const height = canvas.height;
            const barWidth = width / data.length;
            
            ctx.clearRect(0, 0, width, height);
            
            for (let i = 0; i < data.length; i++) {
                const amplitude = data[i] * height * 0.8;
                const x = i * barWidth;
                const y = (height - amplitude) / 2;
                
                ctx.fillRect(x, y, barWidth * 0.8, amplitude);
            }
        } else {
            // Draw a placeholder waveform
            const width = canvas.width;
            const height = canvas.height;
            const barCount = 50;
            const barWidth = width / barCount;
            
            ctx.clearRect(0, 0, width, height);
            
            for (let i = 0; i < barCount; i++) {
                const amplitude = Math.random() * height * 0.6 + height * 0.2;
                const x = i * barWidth;
                const y = (height - amplitude) / 2;
                
                ctx.fillRect(x, y, barWidth * 0.8, amplitude);
            }
        }
    }

    function togglePlayTrack(trackId, buttonElement) {
        const isPlaying = buttonElement.querySelector('i').classList.contains('bi-pause-fill');
        
        // Reset all play buttons first
        document.querySelectorAll('.btn-play i').forEach(icon => {
            icon.classList.remove('bi-pause-fill');
            icon.classList.add('bi-play-fill');
        });
        
        if (!isPlaying) {
            // Play this track
            buttonElement.querySelector('i').classList.remove('bi-play-fill');
            buttonElement.querySelector('i').classList.add('bi-pause-fill');
            
            // Fetch and play the audio file
            fetch(`/api/music/preview/${trackId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.preview_url) {
                        const audio = new Audio(data.preview_url);
                        window.currentAudio = audio;
                        audio.play();
                        
                        audio.onended = function() {
                            buttonElement.querySelector('i').classList.remove('bi-pause-fill');
                            buttonElement.querySelector('i').classList.add('bi-play-fill');
                        };
                    }
                });
        } else {
            // Stop playing
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }
        }
    }

    function selectMusicTrack(track) {
        // Highlight the selected track
        document.querySelectorAll('.music-track').forEach(el => {
            el.classList.remove('bg-light');
        });
        
        const trackElement = event.target.closest('.music-track');
        if (trackElement) {
            trackElement.classList.add('bg-light');
        }
        
        // Store selected track data and update UI
        window.selectedMusicTrack = track;
        document.dispatchEvent(new CustomEvent('musicTrackSelected', { detail: track }));
        
        // Show confirmation toast
        const toast = new bootstrap.Toast(document.getElementById('selectionToast'));
        document.getElementById('selectionToastBody').textContent = `Selected "${track.title}" by ${track.artist}`;
        toast.show();
    }
    </script>

    <!-- Toast for selection confirmation -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="selectionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-music-note-beamed me-2 text-primary"></i>
                <strong class="me-auto">Track Selected</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="selectionToastBody">
                Music track selected successfully.
            </div>
        </div>
    </div>

    <!-- Style Preset Selector Section -->
    <section class="container mt-5" id="stylePresetSelector">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h4 class="mb-0">Video Style Presets</h4>
            </div>
            <div class="card-body">
                <div class="row row-cols-1 row-cols-md-3 g-4" id="stylePresetsContainer">
                    <!-- Vlog Style -->
                    <div class="col">
                        <div class="card h-100 preset-card" data-preset="vlog">
                            <img src="/static/images/presets/vlog-preset.jpg" class="card-img-top" alt="Vlog Style">
                            <div class="card-body">
                                <h5 class="card-title">Vlog Style</h5>
                                <p class="card-text">Clean transitions with simple text overlays. Perfect for storytelling and personal content.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                    </div>
                                    <small class="text-muted">Popular on YouTube</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hype Style -->
                    <div class="col">
                        <div class="card h-100 preset-card" data-preset="hype">
                            <img src="/static/images/presets/hype-preset.jpg" class="card-img-top" alt="Hype Style">
                            <div class="card-body">
                                <h5 class="card-title">Hype Style</h5>
                                <p class="card-text">Fast-paced cuts with zoom effects and bold text. Great for energetic music and action content.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                    </div>
                                    <small class="text-muted">Trending on TikTok</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chill Style -->
                    <div class="col">
                        <div class="card h-100 preset-card" data-preset="chill">
                            <img src="/static/images/presets/chill-preset.jpg" class="card-img-top" alt="Chill Style">
                            <div class="card-body">
                                <h5 class="card-title">Chill Style</h5>
                                <p class="card-text">Smooth slow transitions with minimal text. Ideal for relaxing music and aesthetic content.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                    </div>
                                    <small class="text-muted">Popular on Instagram</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cinematic Style -->
                    <div class="col">
                        <div class="card h-100 preset-card" data-preset="cinematic">
                            <img src="/static/images/presets/cinematic-preset.jpg" class="card-img-top" alt="Cinematic Style">
                            <div class="card-body">
                                <h5 class="card-title">Cinematic Style</h5>
                                <p class="card-text">Film-like color grading with letterbox format. Perfect for dramatic and emotional content.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                    </div>
                                    <small class="text-muted">Professional look</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Minimal Style -->
                    <div class="col">
                        <div class="card h-100 preset-card" data-preset="minimal">
                            <img src="/static/images/presets/minimal-preset.jpg" class="card-img-top" alt="Minimal Style">
                            <div class="card-body">
                                <h5 class="card-title">Minimal Style</h5>
                                <p class="card-text">Clean, minimalist design with subtle animations. Great for tutorials and informational content.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                    </div>
                                    <small class="text-muted">Easy to customize</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Retro Style -->
                    <div class="col">
                        <div class="card h-100 preset-card" data-preset="retro">
                            <img src="/static/images/presets/retro-preset.jpg" class="card-img-top" alt="Retro Style">
                            <div class="card-body">
                                <h5 class="card-title">Retro Style</h5>
                                <p class="card-text">Vintage filters with VHS effects and classic fonts. Perfect for nostalgic and throwback content.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                    </div>
                                    <small class="text-muted">Nostalgic appeal</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Style Preview Modal -->
    <div class="modal fade" id="stylePreviewModal" tabindex="-1" aria-labelledby="stylePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stylePreviewModalLabel">Style Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="ratio ratio-16x9">
                        <video id="stylePreviewVideo" controls>
                            <source src="" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="selectFromPreviewBtn">Select This Style</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script for Style Preset Selection -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initStylePresetSelector();
    });

    function initStylePresetSelector() {
        const presetCards = document.querySelectorAll('.preset-card');
        const previewModal = new bootstrap.Modal(document.getElementById('stylePreviewModal'));
        const previewVideo = document.getElementById('stylePreviewVideo');
        const selectFromPreviewBtn = document.getElementById('selectFromPreviewBtn');
        
        // Preview videos for each preset
        const previewUrls = {
            'vlog': '/static/videos/previews/vlog-preview.mp4',
            'hype': '/static/videos/previews/hype-preview.mp4',
            'chill': '/static/videos/previews/chill-preview.mp4',
            'cinematic': '/static/videos/previews/cinematic-preview.mp4',
            'minimal': '/static/videos/previews/minimal-preview.mp4',
            'retro': '/static/videos/previews/retro-preview.mp4'
        };
        
        // Handle select preset button clicks
        document.querySelectorAll('.select-preset-btn').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.preset-card');
                selectPreset(card);
            });
        });
        
        // Handle preview button clicks
        document.querySelectorAll('.preview-preset-btn').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.preset-card');
                const preset = card.dataset.preset;
                
                // Set the title in the modal
                document.getElementById('stylePreviewModalLabel').textContent = 
                    `${card.querySelector('.card-title').textContent} Preview`;
                
                // Set the video source and load it
                if (previewUrls[preset]) {
                    previewVideo.src = previewUrls[preset];
                    previewVideo.load();
                    
                    // Store the preset in the select button
                    selectFromPreviewBtn.dataset.preset = preset;
                    
                    // Show the modal
                    previewModal.show();
                } else {
                    alert('Preview not available for this style.');
                }
            });
        });
        
        // Handle selecting from preview
        selectFromPreviewBtn.addEventListener('click', function() {
            const preset = this.dataset.preset;
            const card = document.querySelector(`.preset-card[data-preset="${preset}"]`);
            
            // Close the modal
            previewModal.hide();
            
            // Select the preset
            selectPreset(card);
        });
        
        // Handle modal close (stop video)
        document.getElementById('stylePreviewModal').addEventListener('hidden.bs.modal', function() {
            previewVideo.pause();
        });
        
        // Function to select a preset
        function selectPreset(card) {
            // Remove selected class from all cards
            presetCards.forEach(c => c.classList.remove('selected'));
            
            // Add selected class to the clicked card
            card.classList.add('selected');
            
            // Store the selected preset
            const preset = card.dataset.preset;
            window.selectedStylePreset = preset;
            
            // Dispatch event for other components
            document.dispatchEvent(new CustomEvent('stylePresetSelected', { 
                detail: { 
                    preset: preset,
                    name: card.querySelector('.card-title').textContent
                } 
            }));
            
            // Show toast notification
            const toast = new bootstrap.Toast(document.getElementById('styleToast'));
            document.getElementById('styleToastBody').textContent = 
                `Selected "${card.querySelector('.card-title').textContent}" style`;
            toast.show();
        }
    }
    </script>

    <!-- Toast for style selection confirmation -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="styleToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-palette me-2 text-primary"></i>
                <strong class="me-auto">Style Selected</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="styleToastBody">
                Video style selected successfully.
            </div>
        </div>
    </div>

    <!-- Celery Progress Section -->
    <section class="container mt-5 d-none" id="celeryProgressSection">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Video Generation Progress</h4>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="showLogBtn">
                            <i class="bi bi-terminal"></i> Show Log
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="progressContainer">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fs-6 fw-bold" id="taskStatusText">Initializing...</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" 
                                 role="progressbar" 
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <div>
                            <small class="text-muted">Task ID: <span id="taskIdText">Not started</span></small>
                        </div>
                        <div>
                            <small class="text-muted">Elapsed time: <span id="elapsedTimeText">00:00</span></small>
                        </div>
                    </div>
                    
                    <!-- Sub-tasks progress -->
                    <div class="mt-4" id="subTasksContainer">
                        <h6 class="fw-bold">Processing Steps:</h6>
                        <ul class="list-group list-group-flush" id="subTasksList">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Analyzing audio file <small class="text-muted">(Librosa)</small></span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Extracting beat markers</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Processing image files</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Running RunwayML AI</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Generating video with FFMPEG</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Creating final output</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="mt-4 text-center" id="cancelButtonContainer">
                        <button type="button" class="btn btn-danger" id="cancelTaskBtn">
                            <i class="bi bi-x-circle"></i> Cancel Task
                        </button>
                    </div>
                </div>
                
                <!-- Success state -->
                <div class="text-center py-4 d-none" id="successState">
                    <div class="mb-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h4>Video Generated Successfully!</h4>
                    <p class="text-muted">Your video is now ready for preview and publishing.</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="viewVideoBtn">
                            <i class="bi bi-play-circle"></i> Preview Video
                        </button>
                        <button class="btn btn-outline-primary ms-2" id="startOverBtn">
                            <i class="bi bi-arrow-repeat"></i> Generate Another Video
                        </button>
                    </div>
                </div>
                
                <!-- Error state -->
                <div class="text-center py-4 d-none" id="errorState">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <h4>Video Generation Failed</h4>
                    <p class="text-muted" id="errorMessage">An error occurred during video generation.</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="retryBtn">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                        <button class="btn btn-outline-secondary ms-2" id="errorDetailsBtn" data-bs-toggle="modal" data-bs-target="#errorDetailsModal">
                            <i class="bi bi-info-circle"></i> Error Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Log Modal -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalLabel">Task Execution Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;" id="taskLog">Waiting for log data...</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="copyLogBtn">
                        <i class="bi bi-clipboard"></i> Copy Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Details Modal -->
    <div class="modal fade" id="errorDetailsModal" tabindex="-1" aria-labelledby="errorDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorDetailsModalLabel">Error Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="errorDetailText">
                        Error information will be shown here.
                    </div>
                    <h6>Troubleshooting Suggestions:</h6>
                    <ul id="troubleshootingList">
                        <li>Check your internet connection</li>
                        <li>Ensure your files were uploaded correctly</li>
                        <li>Try selecting a different style preset</li>
                        <li>Refresh the page and try again</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="contactSupportBtn">
                        <i class="bi bi-envelope"></i> Contact Support
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Celery Progress JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initCeleryProgress();
    });

    let taskInterval;
    let startTime;
    let currentTaskId;

    function initCeleryProgress() {
        const showLogBtn = document.getElementById('showLogBtn');
        const copyLogBtn = document.getElementById('copyLogBtn');
        const cancelTaskBtn = document.getElementById('cancelTaskBtn');
        const retryBtn = document.getElementById('retryBtn');
        const viewVideoBtn = document.getElementById('viewVideoBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        
        showLogBtn.addEventListener('click', function() {
            const logModal = new bootstrap.Modal(document.getElementById('logModal'));
            logModal.show();
            // Fetch the latest logs for the current task
            fetchTaskLog(currentTaskId);
        });
        
        copyLogBtn.addEventListener('click', function() {
            const logText = document.getElementById('taskLog').textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('Log copied to clipboard!');
            });
        });
        
        cancelTaskBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this task? This action cannot be undone.')) {
                cancelTask(currentTaskId);
            }
        });
        
        retryBtn.addEventListener('click', function() {
            retryTask();
        });
        
        viewVideoBtn.addEventListener('click', function() {
            // This should open a modal or navigate to a page where the generated video can be previewed
            // For now, we'll just show a message
            alert('Video preview functionality will be implemented here.');
        });
        
        startOverBtn.addEventListener('click', function() {
            resetProgressUI();
            document.getElementById('celeryProgressSection').classList.add('d-none');
            // Scroll to the top of the page or to the file upload section
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
    }

    function showProgressSection() {
        const progressSection = document.getElementById('celeryProgressSection');
        progressSection.classList.remove('d-none');
        
        // Scroll to the progress section
        progressSection.scrollIntoView({behavior: 'smooth'});
        
        // Reset the UI
        resetProgressUI();
    }

    function resetProgressUI() {
        // Reset progress bar
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').setAttribute('aria-valuenow', '0');
        document.getElementById('progressPercentage').textContent = '0%';
        
        // Reset status text
        document.getElementById('taskStatusText').textContent = 'Initializing...';
        document.getElementById('taskIdText').textContent = 'Not started';
        document.getElementById('elapsedTimeText').textContent = '00:00';
        
        // Reset subtasks status
        const subTasksList = document.getElementById('subTasksList');
        const badges = subTasksList.querySelectorAll('.badge');
        badges.forEach(badge => {
            badge.className = 'badge bg-secondary rounded-pill';
            badge.textContent = 'Waiting';
        });
        
        // Show progress container, hide success and error states
        document.getElementById('progressContainer').classList.remove('d-none');
        document.getElementById('successState').classList.add('d-none');
        document.getElementById('errorState').classList.add('d-none');
        
        // Clear any existing interval
        if (taskInterval) {
            clearInterval(taskInterval);
            taskInterval = null;
        }
    }

    function startTaskTracking(taskId) {
        resetProgressUI();
        
        // Set the task ID
        currentTaskId = taskId;
        document.getElementById('taskIdText').textContent = taskId;
        
        // Record start time
        startTime = new Date();
        
        // Start the elapsed time counter
        taskInterval = setInterval(updateElapsedTime, 1000);
        
        // Start polling for task status
        pollTaskStatus(taskId);
    }

    function updateElapsedTime() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('elapsedTimeText').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function pollTaskStatus(taskId) {
        fetch(`/api/tasks/${taskId}/status`)
            .then(response => response.json())
            .then(data => {
                updateProgressUI(data);
                
                // Continue polling if the task is still in progress
                if (!['SUCCESS', 'FAILURE', 'REVOKED'].includes(data.status)) {
                    setTimeout(() => pollTaskStatus(taskId), 2000);
                } else {
                    // Task is complete (success or failure)
                    clearInterval(taskInterval);
                    
                    if (data.status === 'SUCCESS') {
                        showSuccessState(data);
                    } else {
                        showErrorState(data);
                    }
                }
            })
            .catch(error => {
                console.error('Error polling task status:', error);
                // Continue polling despite error unless max retries reached
                setTimeout(() => pollTaskStatus(taskId), 5000);
            });
    }

    function updateProgressUI(data) {
        // Update the progress bar
        const progress = data.progress || 0;
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        document.getElementById('progressPercentage').textContent = `${progress}%`;
        
        // Update the status text
        document.getElementById('taskStatusText').textContent = data.status_message || data.status;
        
        // Update subtasks status
        if (data.subtasks) {
            updateSubtasks(data.subtasks);
        }
    }

    function updateSubtasks(subtasks) {
        const subTasksList = document.getElementById('subTasksList');
        const listItems = subTasksList.querySelectorAll('li');
        
        subtasks.forEach((subtask, index) => {
            if (index < listItems.length) {
                const badge = listItems[index].querySelector('.badge');
                
                switch (subtask.status) {
                    case 'PENDING':
                        badge.className = 'badge bg-secondary rounded-pill';
                        badge.textContent = 'Waiting';
                        break;
                    case 'STARTED':
                        badge.className = 'badge bg-primary rounded-pill';
                        badge.textContent = 'In Progress';
                        break;
                    case 'SUCCESS':
                        badge.className = 'badge bg-success rounded-pill';
                        badge.textContent = 'Complete';
                        break;
                    case 'FAILURE':
                        badge.className = 'badge bg-danger rounded-pill';
                        badge.textContent = 'Failed';
                        break;
                    default:
                        badge.className = 'badge bg-secondary rounded-pill';
                        badge.textContent = subtask.status;
                }
            }
        });
    }

    function showSuccessState(data) {
        document.getElementById('progressContainer').classList.add('d-none');
        document.getElementById('successState').classList.remove('d-none');
        
        // Store the result data for later use
        window.taskResult = data.result;
    }

    function showErrorState(data) {
        document.getElementById('progressContainer').classList.add('d-none');
        document.getElementById('errorState').classList.remove('d-none');
        
        // Set error message
        document.getElementById('errorMessage').textContent = data.error_message || 'An error occurred during video generation.';
        
        // Set detailed error
        document.getElementById('errorDetailText').textContent = data.traceback || data.error_message || 'No detailed error information available.';
        
        // Update troubleshooting list based on the error
        updateTroubleshootingSuggestions(data);
    }

    function updateTroubleshootingSuggestions(data) {
        const troubleshootingList = document.getElementById('troubleshootingList');
        troubleshootingList.innerHTML = '';
        
        // Default suggestions
        const suggestions = [
            'Check your internet connection',
            'Ensure your files were uploaded correctly',
            'Try selecting a different style preset',
            'Refresh the page and try again'
        ];
        
        // Add specific suggestions based on error type
        if (data.error_type) {
            switch (data.error_type) {
                case 'FileNotFoundError':
                    suggestions.unshift('The uploaded file could not be found. Try uploading again.');
                    break;
                case 'APIError':
                    suggestions.unshift('There was an issue with the external API. Try again later.');
                    break;
                case 'ProcessingError':
                    suggestions.unshift('Try using a different format or smaller file size.');
                    break;
            }
        }
        
        // Add suggestions to the list
        suggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.textContent = suggestion;
            troubleshootingList.appendChild(li);
        });
    }

    function fetchTaskLog(taskId) {
        document.getElementById('taskLog').textContent = 'Fetching logs...';
        
        fetch(`/api/tasks/${taskId}/log`)
            .then(response => response.json())
            .then(data => {
                if (data.log) {
                    document.getElementById('taskLog').textContent = data.log;
                } else {
                    document.getElementById('taskLog').textContent = 'No logs available for this task.';
                }
            })
            .catch(error => {
                console.error('Error fetching task log:', error);
                document.getElementById('taskLog').textContent = 'Failed to fetch task logs. Please try again.';
            });
    }

    function cancelTask(taskId) {
        fetch(`/api/tasks/${taskId}/revoke`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clearInterval(taskInterval);
                    showErrorState({
                        error_message: 'Task was cancelled by user',
                        error_type: 'UserCancelled'
                    });
                } else {
                    alert('Failed to cancel task: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error cancelling task:', error);
                alert('Failed to cancel task due to a network error. Please try again.');
            });
    }

    function retryTask() {
        // This should recreate the same task with the same parameters
        // For now, we'll just reset the UI
        resetProgressUI();
        document.getElementById('celeryProgressSection').classList.add('d-none');
        
        // In a real implementation, this would restart the task with the same parameters
        alert('Retry functionality will be implemented here. This would restart the task with the same parameters.');
    }

    // Function to be called when starting a new video generation task
    function startVideoGenerationTask(videoParams) {
        showProgressSection();
        
        // Make API call to start the task
        fetch('/api/videos/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(videoParams)
        })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    startTaskTracking(data.task_id);
                } else {
                    showErrorState({
                        error_message: data.message || 'Failed to start task',
                        error_type: 'StartupError'
                    });
                }
            })
            .catch(error => {
                console.error('Error starting video generation task:', error);
                showErrorState({
                    error_message: 'Failed to start task due to a network error',
                    error_type: 'NetworkError'
                });
            });
    }

    // Expose this function globally so it can be called from other components
    window.startVideoGenerationTask = startVideoGenerationTask;
    </script>

    <!-- Video Preview Section -->
    <section class="container mt-5" id="videoPreviewSection">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Video Preview</h4>
                    <div class="btn-group" role="group" aria-label="Platform selector">
                        <input type="radio" class="btn-check" name="platformView" id="platformYouTube" value="youtube" checked>
                        <label class="btn btn-outline-danger" for="platformYouTube">
                            <i class="bi bi-youtube"></i> YouTube
                        </label>
                        
                        <input type="radio" class="btn-check" name="platformView" id="platformTikTok" value="tiktok">
                        <label class="btn btn-outline-dark" for="platformTikTok">
                            <i class="bi bi-tiktok"></i> TikTok
                        </label>
                        
                        <input type="radio" class="btn-check" name="platformView" id="platformInstagram" value="instagram">
                        <label class="btn btn-outline-primary" for="platformInstagram">
                            <i class="bi bi-instagram"></i> Instagram
                        </label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <!-- Video Preview Container -->
                        <div class="position-relative video-preview-container">
                            <!-- Platform specific frames -->
                            <div class="youtube-frame platform-frame active" id="youtubeFrame">
                                <div class="ratio ratio-9x16 video-container">
                                    <video id="previewVideo" controls muted>
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="platform-overlay youtube-overlay">
                                    <div class="youtube-header">
                                        <div class="d-flex align-items-center">
                                            <img src="/static/images/avatar.jpg" class="rounded-circle me-2" width="24" height="24">
                                            <span class="channel-name">Your Channel</span>
                                        </div>
                                        <button class="btn btn-sm btn-danger rounded-pill">Subscribe</button>
                                    </div>
                                    <div class="youtube-footer">
                                        <div class="video-title">Your video title here</div>
                                        <div class="d-flex mt-2">
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-hand-thumbs-up"></i> Like
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-hand-thumbs-down"></i> Dislike
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-chat-dots"></i> Comment
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0">
                                                <i class="bi bi-share"></i> Share
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tiktok-frame platform-frame" id="tiktokFrame">
                                <div class="ratio ratio-9x16 video-container">
                                    <video id="tiktokVideo" controls muted>
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="platform-overlay tiktok-overlay">
                                    <div class="tiktok-right-controls">
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-heart-fill"></i>
                                            <div>234K</div>
                                        </div>
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-chat-dots-fill"></i>
                                            <div>1.2K</div>
                                        </div>
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-bookmark-fill"></i>
                                            <div>55.6K</div>
                                        </div>
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-share-fill"></i>
                                            <div>Share</div>
                                        </div>
                                    </div>
                                    <div class="tiktok-footer">
                                        <div class="d-flex align-items-center">
                                            <img src="/static/images/avatar.jpg" class="rounded-circle me-2" width="40" height="40">
                                            <span class="tiktok-username">@yourusername</span>
                                            <button class="btn btn-sm btn-danger ms-2 rounded-pill">Follow</button>
                                        </div>
                                        <div class="tiktok-caption mt-2">
                                            Your video caption here #shorts #trending #viral
                                        </div>
                                        <div class="tiktok-sound mt-1">
                                            <i class="bi bi-music-note-beamed"></i> original sound - yourusername
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="instagram-frame platform-frame" id="instagramFrame">
                                <div class="ratio ratio-9x16 video-container">
                                    <video id="instagramVideo" controls muted>
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="platform-overlay instagram-overlay">
                                    <div class="instagram-header">
                                        <div class="d-flex align-items-center">
                                            <img src="/static/images/avatar.jpg" class="rounded-circle me-2" width="30" height="30">
                                            <span class="instagram-username">yourusername</span>
                                            <i class="bi bi-dot"></i>
                                            <span class="text-primary">Follow</span>
                                        </div>
                                    </div>
                                    <div class="instagram-footer">
                                        <div class="d-flex mb-2">
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-heart"></i>
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-chat"></i>
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0">
                                                <i class="bi bi-send"></i>
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 ms-auto">
                                                <i class="bi bi-bookmark"></i>
                                            </button>
                                        </div>
                                        <div class="instagram-likes">123,456 likes</div>
                                        <div class="instagram-caption">
                                            <span class="instagram-username">yourusername</span>
                                            Your video caption here #reels #trending #viral
                                        </div>
                                        <div class="instagram-comments mt-1">
                                            View all 1,234 comments
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="video-info-panel">
                            <h5 class="mb-3">Video Information</h5>
                            
                            <div class="mb-3">
                                <label for="videoTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="videoTitle" placeholder="Enter video title">
                            </div>
                            
                            <div class="mb-3">
                                <label for="videoDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="videoDescription" rows="3" placeholder="Enter video description"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="videoHashtags" class="form-label">Hashtags</label>
                                <input type="text" class="form-control" id="videoHashtags" placeholder="#shorts #trending #viral">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Publish To</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="publishYouTube" checked>
                                        <label class="form-check-label" for="publishYouTube">YouTube Shorts</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="publishTikTok">
                                        <label class="form-check-label" for="publishTikTok">TikTok</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="publishInstagram">
                                        <label class="form-check-label" for="publishInstagram">Instagram Reels</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button type="button" class="btn btn-success w-100" id="generateAIMetadataBtn">
                                    <i class="bi bi-magic"></i> Generate with AI
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button type="button" class="btn btn-primary btn-lg" id="publishVideoBtn">
                        <i class="bi bi-cloud-upload"></i> Publish Now
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-lg ms-2" id="scheduleVideoBtn">
                        <i class="bi bi-calendar-plus"></i> Schedule for Later
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Video Scheduling Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">Schedule Video Publishing</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="scheduleDatetime" class="form-label">Select Date and Time</label>
                        <input type="datetime-local" class="form-control" id="scheduleDatetime">
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useOptimalTime">
                            <label class="form-check-label" for="useOptimalTime">
                                Use AI-recommended optimal time for maximum engagement
                            </label>
                        </div>
                    </div>
                    
                    <div class="optimal-time-suggestions d-none" id="optimalTimeSuggestions">
                        <div class="alert alert-info mb-3">
                            <h6 class="alert-heading">Recommended publishing times:</h6>
                            <ul class="mb-0">
                                <li><strong>YouTube Shorts:</strong> Tuesday, 3:00 PM - 6:00 PM (your local time)</li>
                                <li><strong>TikTok:</strong> Thursday, 7:00 PM - 9:00 PM (your local time)</li>
                                <li><strong>Instagram Reels:</strong> Monday, 6:00 PM - 8:00 PM (your local time)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Publishing Platforms</label>
                        <div class="platform-schedule-list">
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scheduleYouTube" checked>
                                        <label class="form-check-label d-flex justify-content-between w-100" for="scheduleYouTube">
                                            <span><i class="bi bi-youtube text-danger"></i> YouTube Shorts</span>
                                            <small class="text-muted">Highest engagement</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scheduleTikTok">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="scheduleTikTok">
                                            <span><i class="bi bi-tiktok"></i> TikTok</span>
                                            <small class="text-muted">Trending platform</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scheduleInstagram">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="scheduleInstagram">
                                            <span><i class="bi bi-instagram text-primary"></i> Instagram Reels</span>
                                            <small class="text-muted">Good for brand building</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmScheduleBtn">Schedule Video</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Preview JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initVideoPreview();
    });

    function initVideoPreview() {
        // Platform view toggle
        const platformRadios = document.querySelectorAll('input[name="platformView"]');
        platformRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updatePlatformView(this.value);
            });
        });
        
        // Schedule button
        const scheduleVideoBtn = document.getElementById('scheduleVideoBtn');
        const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        
        scheduleVideoBtn.addEventListener('click', function() {
            // Set default scheduled time to tomorrow at current time
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateTimeString = tomorrow.toISOString().slice(0, 16);
            document.getElementById('scheduleDatetime').value = dateTimeString;
            
            // Update platform checkboxes based on publish selection
            document.getElementById('scheduleYouTube').checked = document.getElementById('publishYouTube').checked;
            document.getElementById('scheduleTikTok').checked = document.getElementById('publishTikTok').checked;
            document.getElementById('scheduleInstagram').checked = document.getElementById('publishInstagram').checked;
            
            scheduleModal.show();
        });
        
        // Optimal time checkbox
        const useOptimalTime = document.getElementById('useOptimalTime');
        const optimalTimeSuggestions = document.getElementById('optimalTimeSuggestions');
        
        useOptimalTime.addEventListener('change', function() {
            if (this.checked) {
                optimalTimeSuggestions.classList.remove('d-none');
            } else {
                optimalTimeSuggestions.classList.add('d-none');
            }
        });
        
        // Confirm schedule button
        const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
        
        confirmScheduleBtn.addEventListener('click', function() {
            const scheduleDatetime = document.getElementById('scheduleDatetime').value;
            const useOptimal = document.getElementById('useOptimalTime').checked;
            
            const platforms = [];
            if (document.getElementById('scheduleYouTube').checked) platforms.push('youtube');
            if (document.getElementById('scheduleTikTok').checked) platforms.push('tiktok');
            if (document.getElementById('scheduleInstagram').checked) platforms.push('instagram');
            
            if (!scheduleDatetime && !useOptimal) {
                alert('Please select a date and time or use the optimal time option.');
                return;
            }
            
            if (platforms.length === 0) {
                alert('Please select at least one platform to publish to.');
                return;
            }
            
            // In a real implementation, this would call an API to schedule the video
            console.log('Scheduling video for:', scheduleDatetime);
            console.log('Use optimal time:', useOptimal);
            console.log('Platforms:', platforms);
            
            // Close the modal and show a success message
            scheduleModal.hide();
            alert('Your video has been scheduled successfully!');
        });
        
        // Generate AI metadata button
        const generateAIMetadataBtn = document.getElementById('generateAIMetadataBtn');
        
        generateAIMetadataBtn.addEventListener('click', function() {
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
            this.disabled = true;
            
            // Simulate API call delay
            setTimeout(() => {
                // Update fields with AI-generated content
                document.getElementById('videoTitle').value = 'This Beat Drop Will Give You Chills!  #shorts';
                document.getElementById('videoDescription').value = 'Watch how this music-responsive visual transforms with every beat! Created using AI technology. Like and subscribe for more amazing content like this!';
                document.getElementById('videoHashtags').value = '#shorts #musicvisualization #beatdrop #viral #trending #musicproduction';
                
                // Update preview title and caption in the platform views
                updatePlatformPreviewText();
                
                // Reset button
                this.innerHTML = '<i class="bi bi-magic"></i> Generate with AI';
                this.disabled = false;
                
                // Show success toast
                const toast = new bootstrap.Toast(document.getElementById('aiGeneratedToast'));
                toast.show();
            }, 2000);
        });
        
        // Update text fields for video info
        const videoTitle = document.getElementById('videoTitle');
        const videoDescription = document.getElementById('videoDescription');
        const videoHashtags = document.getElementById('videoHashtags');
        
        [videoTitle, videoDescription, videoHashtags].forEach(element => {
            element.addEventListener('input', updatePlatformPreviewText);
        });
        
        // Initialize with default video source
        // In a real implementation, this would be updated when a video is generated
        setPreviewVideo('/static/videos/sample-preview.mp4');
        
        // Initialize with YouTube as default platform view
        updatePlatformView('youtube');
    }

    function updatePlatformView(platform) {
        // Hide all platform frames
        document.querySelectorAll('.platform-frame').forEach(frame => {
            frame.classList.remove('active');
        });
        
        // Show the selected platform frame
        let frameId;
        switch (platform) {
            case 'tiktok':
                frameId = 'tiktokFrame';
                break;
            case 'instagram':
                frameId = 'instagramFrame';
                break;
            default:
                frameId = 'youtubeFrame';
        }
        
        document.getElementById(frameId).classList.add('active');
        
        // Update platform-specific content
        updatePlatformPreviewText();
    }

    function updatePlatformPreviewText() {
        const title = document.getElementById('videoTitle').value || 'Your video title here';
        const description = document.getElementById('videoDescription').value || 'Your video description here';
        const hashtags = document.getElementById('videoHashtags').value || '#shorts #trending #viral';
        
        // Update YouTube elements
        document.querySelector('.youtube-footer .video-title').textContent = title;
        
        // Update TikTok elements
        document.querySelector('.tiktok-caption').textContent = `${description} ${hashtags}`;
        
        // Update Instagram elements
        document.querySelector('.instagram-caption').textContent = '';
        document.querySelector('.instagram-caption').innerHTML = 
            `<span class="instagram-username">yourusername</span> ${description} ${hashtags}`;
    }

    function setPreviewVideo(videoUrl) {
        // Set the source for all platform videos
        document.getElementById('previewVideo').src = videoUrl;
        document.getElementById('tiktokVideo').src = videoUrl;
        document.getElementById('instagramVideo').src = videoUrl;
        
        // Load the videos
        document.getElementById('previewVideo').load();
        document.getElementById('tiktokVideo').load();
        document.getElementById('instagramVideo').load();
    }

    // Function to be called when a new video has been generated
    function updateVideoPreview(videoData) {
        // Show the video preview section
        document.getElementById('videoPreviewSection').classList.remove('d-none');
        
        // Scroll to the preview section
        document.getElementById('videoPreviewSection').scrollIntoView({behavior: 'smooth'});
        
        // Set the video source
        if (videoData && videoData.video_url) {
            setPreviewVideo(videoData.video_url);
        }
        
        // Update metadata if available
        if (videoData && videoData.metadata) {
            if (videoData.metadata.title) {
                document.getElementById('videoTitle').value = videoData.metadata.title;
            }
            
            if (videoData.metadata.description) {
                document.getElementById('videoDescription').value = videoData.metadata.description;
            }
            
            if (videoData.metadata.hashtags) {
                document.getElementById('videoHashtags').value = videoData.metadata.hashtags.join(' ');
            }
            
            // Update platform preview text
            updatePlatformPreviewText();
        }
    }

    // Expose this function globally so it can be called from other components
    window.updateVideoPreview = updateVideoPreview;
    </script>

    <!-- AI Generated Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="aiGeneratedToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-magic me-2 text-primary"></i>
                <strong class="me-auto">AI Generated Content</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                AI has successfully generated title, description, and hashtags for your video.
            </div>
        </div>
    </div>

    <!-- Main Integration Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initMainApp();
    });

    // Global state
    const appState = {
        selectedMusicTrack: null,
        selectedStylePreset: null,
        selectedImages: [],
        generatedVideoId: null,
        generatedTaskId: null
    };

    function initMainApp() {
        // Hook up the generate video button
        const generateButton = document.getElementById('generateVideoBtn');
        if (generateButton) {
            generateButton.addEventListener('click', function() {
                generateMusicResponsiveVideo();
            });
        }
        
        // Hook up the publish button
        const publishButton = document.getElementById('publishVideoBtn');
        if (publishButton) {
            publishButton.addEventListener('click', function() {
                publishGeneratedVideo(false);
            });
        }
        
        // Listen for music track selection
        document.addEventListener('musicTrackSelected', function(event) {
            appState.selectedMusicTrack = event.detail;
            updateGenerateButtonState();
        });
        
        // Listen for style preset selection
        document.addEventListener('stylePresetSelected', function(event) {
            appState.selectedStylePreset = event.detail;
            updateGenerateButtonState();
        });
        
        // Initially hide video preview until a video is generated
        const videoPreviewSection = document.getElementById('videoPreviewSection');
        if (videoPreviewSection) {
            videoPreviewSection.classList.add('d-none');
        }
        
        // Initially hide progress section
        const progressSection = document.getElementById('celeryProgressSection');
        if (progressSection) {
            progressSection.classList.add('d-none');
        }
    }

    function updateGenerateButtonState() {
        const generateButton = document.getElementById('generateVideoBtn');
        if (generateButton) {
            // Enable the button only if both a music track and style preset are selected
            const canGenerate = appState.selectedMusicTrack && appState.selectedStylePreset;
            generateButton.disabled = !canGenerate;
        }
    }

    function generateMusicResponsiveVideo() {
        // Validate that we have the required selections
        if (!appState.selectedMusicTrack || !appState.selectedStylePreset) {
            alert('Please select both a music track and a style preset.');
            return;
        }
        
        // Collect image paths (in a real implementation, these would be collected from the UI)
        // For now, we'll use mock data
        const imagePaths = appState.selectedImages.length > 0 ? 
            appState.selectedImages : 
            ['/static/images/sample1.jpg', '/static/images/sample2.jpg', '/static/images/sample3.jpg'];
        
        // Prepare the video generation parameters
        const params = {
            music_track_id: appState.selectedMusicTrack.id,
            style_preset: appState.selectedStylePreset.preset,
            images: imagePaths,
            video_clips: [],
            captions_enabled: true,
            target_platforms: ["youtube"]
        };
        
        // Start the video generation task using our global function
        window.startVideoGenerationTask(params);
        
        // In a real implementation, the startVideoGenerationTask function would make an API call
        // When the task is complete, it would call updateVideoPreview with the result
        
        // For demonstration, we'll simulate a successful generation after a delay
        setTimeout(() => {
            const mockVideoData = {
                video_id: "video_" + Math.random().toString(36).substr(2, 9),
                video_url: '/static/videos/sample-preview.mp4',
                metadata: {
                    title: 'Amazing Music-Responsive Video',
                    description: 'Check out this awesome video generated with Nova Sounds Shorts Machine!',
                    hashtags: ['#shorts', '#musicvideo', '#novamachine']
                }
            };
            
            // Update the video preview
            window.updateVideoPreview(mockVideoData);
            
            // Store the generated video ID
            appState.generatedVideoId = mockVideoData.video_id;
        }, 15000); // Simulate 15 seconds of processing
    }

    function publishGeneratedVideo(schedule = false) {
        // Validate that we have a generated video
        if (!appState.generatedVideoId) {
            alert('Please generate a video first.');
            return;
        }
        
        // Get metadata from the form
        const title = document.getElementById('videoTitle').value;
        const description = document.getElementById('videoDescription').value;
        const hashtags = document.getElementById('videoHashtags').value;
        
        // Get selected platforms
        const platforms = [];
        if (document.getElementById('publishYouTube').checked) platforms.push('youtube');
        if (document.getElementById('publishTikTok').checked) platforms.push('tiktok');
        if (document.getElementById('publishInstagram').checked) platforms.push('instagram');
        
        if (platforms.length === 0) {
            alert('Please select at least one platform to publish to.');
            return;
        }
        
        // Prepare metadata
        const metadata = {
            title: title,
            description: description,
            hashtags: hashtags.split(' ').filter(tag => tag.startsWith('#'))
        };
        
        if (schedule) {
            // Show the schedule modal
            document.getElementById('scheduleVideoBtn').click();
        } else {
            // Publish immediately
            publishToSelectedPlatforms(appState.generatedVideoId, platforms, metadata);
        }
    }

    function publishToSelectedPlatforms(videoId, platforms, metadata) {
        // In a real implementation, this would make API calls to publish the video
        console.log('Publishing video:', videoId);
        console.log('To platforms:', platforms);
        console.log('With metadata:', metadata);
        
        // Show a loading indicator
        const publishButton = document.getElementById('publishVideoBtn');
        const originalText = publishButton.innerHTML;
        publishButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Publishing...';
        publishButton.disabled = true;
        
        // Simulate API call delay
        setTimeout(() => {
            // Reset the button
            publishButton.innerHTML = originalText;
            publishButton.disabled = false;
            
            // Show success message
            alert('Your video has been successfully published to ' + platforms.join(', ') + '!');
        }, 3000);
    }

    // Connect the schedule confirmation button to the publishing function
    document.addEventListener('DOMContentLoaded', function() {
        const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
        if (confirmScheduleBtn) {
            confirmScheduleBtn.addEventListener('click', function() {
                // Get scheduling info from the modal
                const scheduleDatetime = document.getElementById('scheduleDatetime').value;
                const useOptimal = document.getElementById('useOptimalTime').checked;
                
                // Get selected platforms
                const platforms = [];
                if (document.getElementById('scheduleYouTube').checked) platforms.push('youtube');
                if (document.getElementById('scheduleTikTok').checked) platforms.push('tiktok');
                if (document.getElementById('scheduleInstagram').checked) platforms.push('instagram');
                
                // Get metadata from the form
                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;
                const hashtags = document.getElementById('videoHashtags').value;
                
                // Prepare request data
                const scheduleData = {
                    video_id: appState.generatedVideoId,
                    platforms: platforms,
                    scheduled_datetime: scheduleDatetime,
                    use_optimal_time: useOptimal,
                    metadata: {
                        title: title,
                        description: description,
                        hashtags: hashtags.split(' ').filter(tag => tag.startsWith('#'))
                    }
                };
                
                // Make API call to schedule the video
                fetch('/api/scheduler/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Close the modal
                            const scheduleModal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                            scheduleModal.hide();
                            
                            // Show success message
                            alert('Your video has been scheduled successfully!');
                        } else {
                            alert('Error scheduling video: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error scheduling video:', error);
                        alert('Error scheduling video. Please try again.');
                    });
            });
        }
    });
    </script>

    <!-- Add a "Generate Video" button at the appropriate location -->
    <div class="container mt-4 text-center">
        <button type="button" class="btn btn-primary btn-lg" id="generateVideoBtn" disabled>
            <i class="bi bi-gear-wide-connected"></i> Generate Music-Responsive Video
        </button>
    </div>
    
    <!-- FullCalendar Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    
    <!-- Chart.js for analytics dashboards -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <!-- Scheduling Calendar Component -->
    <script src="/static/js/scheduler.js"></script>
    
    <!-- Analytics Dashboard JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize scheduling calendar when the schedule tab is shown
            const scheduleTab = document.getElementById('schedule-tab');
            if (scheduleTab) {
                scheduleTab.addEventListener('shown.bs.tab', function (e) {
                    // Initialize the calendar if it doesn't exist yet
                    if (!window.schedulerCalendar) {
                        window.schedulerCalendar = new SchedulerCalendar('schedulingCalendar', {
                            onScheduleSave: function(scheduleData) {
                                // Send the schedule data to the API
                                fetch('/api/scheduler/publish', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(scheduleData)
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'success') {
                                        alert('Your content has been scheduled successfully!');
                                        // Reload the calendar events
                                        window.schedulerCalendar.loadSchedules();
                                    } else {
                                        alert('Error scheduling content: ' + data.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error scheduling content:', error);
                                    alert('Error scheduling content. Please try again.');
                                });
                            }
                        });
                    }
                });
            }
            
            // Initialize music browser functionality
            initMusicBrowser();
            
            // Initialize analytics dashboard
            initAnalyticsDashboard();
        });
        
        // Analytics dashboard initialization
        function initAnalyticsDashboard() {
            // Only initialize if the tab exists
            if (!document.getElementById('analytics-tab')) return;
            
            // Show loading state when analytics tab is clicked
            document.getElementById('analytics-tab').addEventListener('shown.bs.tab', function() {
                loadAnalyticsData();
            });
            
            // Show loading state
            document.getElementById('analytics-loading').style.display = 'block';
            document.getElementById('analytics-error').style.display = 'none';
            document.getElementById('analytics-content').style.display = 'none';
            
            // Set up refresh event handler
            document.getElementById('refreshVideosBtn').addEventListener('click', function() {
                loadGeneratedVideos();
            });
            
            // Set up retry button
            document.getElementById('retry-analytics-btn').addEventListener('click', function() {
                loadAnalyticsData();
            });
        }
        
        // Load all analytics data
        async function loadAnalyticsData() {
            try {
                // Fetch analytics data from API
                const response = await fetch('/api/dashboard/analytics');
                
                if (!response.ok) {
                    throw new Error('Failed to load analytics data');
                }
                
                const data = await response.json();
                
                // Update dashboard metrics
                updateDashboardMetrics(data);
                
                // Load generated videos
                loadGeneratedVideos();
                
                // Initialize charts
                initializePlatformViewsChart(data.platform_views);
                
                // Update top tracks table
                updateTopTracksTable(data.top_tracks);
                
                // Update affiliate stats
                updateAffiliateStats(data.affiliate_stats);
                
                // Hide loading, show content
                document.getElementById('analytics-loading').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
            } catch (error) {
                console.error('Error loading analytics data:', error);
                document.getElementById('analytics-loading').style.display = 'none';
                document.getElementById('analytics-error').style.display = 'block';
            }
        }
        
        // Update dashboard metric cards
        function updateDashboardMetrics(data) {
            document.getElementById('totalViewsValue').textContent = formatNumber(data.total_views || 0);
            document.getElementById('totalLikesValue').textContent = formatNumber(data.total_likes || 0);
            document.getElementById('videosGeneratedValue').textContent = formatNumber(data.videos_generated || 0);
            document.getElementById('engagementRateValue').textContent = `${(data.engagement_rate || 0).toFixed(1)}%`;
            
            document.getElementById('viewsTrendValue').textContent = (data.views_trend || 0).toFixed(1);
            document.getElementById('likesTrendValue').textContent = (data.likes_trend || 0).toFixed(1);
            document.getElementById('videosTrendValue').textContent = (data.videos_trend || 0).toFixed(1);
            document.getElementById('engagementTrendValue').textContent = (data.engagement_trend || 0).toFixed(1);
        }
        
        // Load generated videos
        async function loadGeneratedVideos() {
            const videosList = document.getElementById('generatedVideosList');
            videosList.innerHTML = '<tr><td colspan="7" class="text-center py-4">Loading your videos...</td></tr>';
            
            try {
                // Fetch videos from API
                const response = await fetch('/api/videos/generated');
                
                if (!response.ok) {
                    throw new Error('Failed to load generated videos');
                }
                
                const data = await response.json();
                
                if (!data.videos || data.videos.length === 0) {
                    videosList.innerHTML = '<tr><td colspan="7" class="text-center py-4">No videos generated yet</td></tr>';
                    return;
                }
                
                // Clear the table
                videosList.innerHTML = '';
                
                // Add videos to the table
                data.videos.forEach(video => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    const createdDate = new Date(video.created_at);
                    const formattedDate = createdDate.toLocaleDateString();
                    
                    // Platform badges
                    const platformBadges = video.platforms.map(platform => {
                        const badgeClass = getPlatformBadgeClass(platform);
                        const platformIcon = getPlatformIcon(platform);
                        return `<span class="badge ${badgeClass} me-1">${platformIcon} ${platform}</span>`;
                    }).join('');
                    
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="video-thumbnail me-2" style="width: 120px; height: 67px; overflow: hidden; border-radius: 4px;">
                                    <img src="${video.thumbnail_url || '/static/img/placeholder-thumbnail.jpg'}" 
                                         class="w-100 h-100" style="object-fit: cover;" alt="Video thumbnail">
                                </div>
                                <div class="video-info small">
                                    <div class="text-truncate" style="max-width: 150px;">ID: ${video.video_id}</div>
                                    <div class="text-muted">Style: ${video.style || 'Standard'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${video.title || 'Untitled'}</td>
                        <td>${platformBadges}</td>
                        <td>${formattedDate}</td>
                        <td>${formatNumber(video.views || 0)}</td>
                        <td>${formatNumber(video.likes || 0)}</td>
                        <td>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary preview-video-btn" 
                                        data-video-id="${video.video_id}" data-video-url="${video.video_url}">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary edit-metadata-btn"
                                        data-video-id="${video.video_id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success republish-video-btn"
                                        data-video-id="${video.video_id}">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    videosList.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.preview-video-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const videoId = this.dataset.videoId;
                        const videoUrl = this.dataset.videoUrl;
                        previewVideo(videoId, videoUrl);
                    });
                });
                
                document.querySelectorAll('.edit-metadata-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const videoId = this.dataset.videoId;
                        editVideoMetadata(videoId);
                    });
                });
                
                document.querySelectorAll('.republish-video-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const videoId = this.dataset.videoId;
                        republishVideo(videoId);
                    });
                });
            } catch (error) {
                console.error('Error loading generated videos:', error);
                videosList.innerHTML = '<tr><td colspan="7" class="text-center py-4">Error loading videos</td></tr>';
            }
        }
        
        // Initialize platform views chart
        function initializePlatformViewsChart(platformViews) {
            const ctx = document.getElementById('platformViewsChart').getContext('2d');
            
            // Extract data for chart
            const labels = Object.keys(platformViews || {});
            const data = labels.map(platform => platformViews[platform] || 0);
            const colors = labels.map(platform => getPlatformColor(platform));
            
            // Create chart
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(p => p.charAt(0).toUpperCase() + p.slice(1)),
                    datasets: [{
                        label: 'Views',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c + '80'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Update top tracks table
        function updateTopTracksTable(topTracks) {
            const table = document.getElementById('topTracksTable');
            
            if (!topTracks || topTracks.length === 0) {
                table.innerHTML = '<tr><td colspan="5" class="text-center py-4">No data available</td></tr>';
                return;
            }
            
            table.innerHTML = '';
            
            topTracks.forEach((track, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="track-icon me-2">
                                <i class="bi bi-music-note"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${track.title || 'Unknown Track'}</div>
                                <div class="small text-muted">${track.artist || 'Unknown Artist'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${track.genre || 'Unknown'}</td>
                    <td>${track.video_count || 0}</td>
                    <td>${formatNumber(track.total_views || 0)}</td>
                `;
                
                table.appendChild(row);
            });
        }
        
        // Update affiliate stats
        function updateAffiliateStats(stats) {
            if (!stats) return;
            
            document.getElementById('dashboardReferralsValue').textContent = stats.total_referrals || 0;
            document.getElementById('dashboardEarningsValue').textContent = `$${(stats.total_earnings || 0).toFixed(2)}`;
            document.getElementById('dashboardConversionRateValue').textContent = `${(stats.conversion_rate || 0).toFixed(1)}%`;
        }
        
        // Helper: Format numbers with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Helper: Get platform badge class
        function getPlatformBadgeClass(platform) {
            const classes = {
                youtube: 'bg-danger',
                tiktok: 'bg-dark',
                instagram: 'bg-purple',
                facebook: 'bg-primary',
                default: 'bg-secondary'
            };
            
            return classes[platform.toLowerCase()] || classes.default;
        }
        
        // Helper: Get platform icon
        function getPlatformIcon(platform) {
            const icons = {
                youtube: '<i class="bi bi-youtube"></i>',
                tiktok: '<i class="bi bi-tiktok"></i>',
                instagram: '<i class="bi bi-instagram"></i>',
                facebook: '<i class="bi bi-facebook"></i>',
                default: '<i class="bi bi-camera-video"></i>'
            };
            
            return icons[platform.toLowerCase()] || icons.default;
        }
        
        // Helper: Get platform color
        function getPlatformColor(platform) {
            const colors = {
                youtube: '#FF0000',
                tiktok: '#000000',
                instagram: '#C13584',
                facebook: '#4267B2',
                default: '#6c757d'
            };
            
            return colors[platform.toLowerCase()] || colors.default;
        }
        
        // Preview video in modal
        function previewVideo(videoId, videoUrl) {
            // Implementation will depend on your video modal
            console.log('Preview video:', videoId, videoUrl);
            
            // Example implementation:
            // const modal = new bootstrap.Modal(document.getElementById('videoPreviewModal'));
            // document.getElementById('previewVideoPlayer').src = videoUrl;
            // modal.show();
        }
        
        // Edit video metadata
        function editVideoMetadata(videoId) {
            // Implementation will depend on your editing UI
            console.log('Edit metadata for video:', videoId);
            
            // Example implementation:
            // window.location.href = `/edit-video/${videoId}`;
        }
        
        // Republish video
        function republishVideo(videoId) {
            // Implementation will depend on your republishing flow
            console.log('Republish video:', videoId);
            
            // Example implementation:
            // window.location.href = `/republish-video/${videoId}`;
        }
        
        function initMusicBrowser() {
            // Track loading and filtering functionality will be implemented here
            const applyFilters = document.getElementById('applyFilters');
            const resetFilters = document.getElementById('resetFilters');
            
            applyFilters.addEventListener('click', function() {
                loadMusicTracks();
            });
            
            resetFilters.addEventListener('click', function() {
                document.getElementById('genreFilter').selectedIndex = -1;
                document.getElementById('moodFilter').selectedIndex = -1;
                document.getElementById('bpmMin').value = '';
                document.getElementById('bpmMax').value = '';
                document.getElementById('licenseFilter').selectedIndex = 0;
            });
            
            // Initial load of music tracks
            loadMusicTracks();
        }
    </script>

    <!-- Toast for style selection confirmation -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="styleToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-palette me-2 text-primary"></i>
                <strong class="me-auto">Style Selected</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="styleToastBody">
                Video style selected successfully.
            </div>
        </div>
    </div>

    <!-- Celery Progress Section -->
    <section class="container mt-5 d-none" id="celeryProgressSection">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Video Generation Progress</h4>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="showLogBtn">
                            <i class="bi bi-terminal"></i> Show Log
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="progressContainer">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fs-6 fw-bold" id="taskStatusText">Initializing...</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" 
                                 role="progressbar" 
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <div>
                            <small class="text-muted">Task ID: <span id="taskIdText">Not started</span></small>
                        </div>
                        <div>
                            <small class="text-muted">Elapsed time: <span id="elapsedTimeText">00:00</span></small>
                        </div>
                    </div>
                    
                    <!-- Sub-tasks progress -->
                    <div class="mt-4" id="subTasksContainer">
                        <h6 class="fw-bold">Processing Steps:</h6>
                        <ul class="list-group list-group-flush" id="subTasksList">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Analyzing audio file <small class="text-muted">(Librosa)</small></span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Extracting beat markers</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Processing image files</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Running RunwayML AI</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Generating video with FFMPEG</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Creating final output</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="mt-4 text-center" id="cancelButtonContainer">
                        <button type="button" class="btn btn-danger" id="cancelTaskBtn">
                            <i class="bi bi-x-circle"></i> Cancel Task
                        </button>
                    </div>
                </div>
                
                <!-- Success state -->
                <div class="text-center py-4 d-none" id="successState">
                    <div class="mb-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h4>Video Generated Successfully!</h4>
                    <p class="text-muted">Your video is now ready for preview and publishing.</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="viewVideoBtn">
                            <i class="bi bi-play-circle"></i> Preview Video
                        </button>
                        <button class="btn btn-outline-primary ms-2" id="startOverBtn">
                            <i class="bi bi-arrow-repeat"></i> Generate Another Video
                        </button>
                    </div>
                </div>
                
                <!-- Error state -->
                <div class="text-center py-4 d-none" id="errorState">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <h4>Video Generation Failed</h4>
                    <p class="text-muted" id="errorMessage">An error occurred during video generation.</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="retryBtn">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                        <button class="btn btn-outline-secondary ms-2" id="errorDetailsBtn" data-bs-toggle="modal" data-bs-target="#errorDetailsModal">
                            <i class="bi bi-info-circle"></i> Error Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Log Modal -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalLabel">Task Execution Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;" id="taskLog">Waiting for log data...</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="copyLogBtn">
                        <i class="bi bi-clipboard"></i> Copy Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Details Modal -->
    <div class="modal fade" id="errorDetailsModal" tabindex="-1" aria-labelledby="errorDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorDetailsModalLabel">Error Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="errorDetailText">
                        Error information will be shown here.
                    </div>
                    <h6>Troubleshooting Suggestions:</h6>
                    <ul id="troubleshootingList">
                        <li>Check your internet connection</li>
                        <li>Ensure your files were uploaded correctly</li>
                        <li>Try selecting a different style preset</li>
                        <li>Refresh the page and try again</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="contactSupportBtn">
                        <i class="bi bi-envelope"></i> Contact Support
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Celery Progress JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initCeleryProgress();
    });

    let taskInterval;
    let startTime;
    let currentTaskId;

    function initCeleryProgress() {
        const showLogBtn = document.getElementById('showLogBtn');
        const copyLogBtn = document.getElementById('copyLogBtn');
        const cancelTaskBtn = document.getElementById('cancelTaskBtn');
        const retryBtn = document.getElementById('retryBtn');
        const viewVideoBtn = document.getElementById('viewVideoBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        
        showLogBtn.addEventListener('click', function() {
            const logModal = new bootstrap.Modal(document.getElementById('logModal'));
            logModal.show();
            // Fetch the latest logs for the current task
            fetchTaskLog(currentTaskId);
        });
        
        copyLogBtn.addEventListener('click', function() {
            const logText = document.getElementById('taskLog').textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('Log copied to clipboard!');
            });
        });
        
        cancelTaskBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this task? This action cannot be undone.')) {
                cancelTask(currentTaskId);
            }
        });
        
        retryBtn.addEventListener('click', function() {
            retryTask();
        });
        
        viewVideoBtn.addEventListener('click', function() {
            // This should open a modal or navigate to a page where the generated video can be previewed
            // For now, we'll just show a message
            alert('Video preview functionality will be implemented here.');
        });
        
        startOverBtn.addEventListener('click', function() {
            resetProgressUI();
            document.getElementById('celeryProgressSection').classList.add('d-none');
            // Scroll to the top of the page or to the file upload section
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
    }

    function showProgressSection() {
        const progressSection = document.getElementById('celeryProgressSection');
        progressSection.classList.remove('d-none');
        
        // Scroll to the progress section
        progressSection.scrollIntoView({behavior: 'smooth'});
        
        // Reset the UI
        resetProgressUI();
    }

    function resetProgressUI() {
        // Reset progress bar
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').setAttribute('aria-valuenow', '0');
        document.getElementById('progressPercentage').textContent = '0%';
        
        // Reset status text
        document.getElementById('taskStatusText').textContent = 'Initializing...';
        document.getElementById('taskIdText').textContent = 'Not started';
        document.getElementById('elapsedTimeText').textContent = '00:00';
        
        // Reset subtasks status
        const subTasksList = document.getElementById('subTasksList');
        const badges = subTasksList.querySelectorAll('.badge');
        badges.forEach(badge => {
            badge.className = 'badge bg-secondary rounded-pill';
            badge.textContent = 'Waiting';
        });
        
        // Show progress container, hide success and error states
        document.getElementById('progressContainer').classList.remove('d-none');
        document.getElementById('successState').classList.add('d-none');
        document.getElementById('errorState').classList.add('d-none');
        
        // Clear any existing interval
        if (taskInterval) {
            clearInterval(taskInterval);
            taskInterval = null;
        }
    }

    function startTaskTracking(taskId) {
        resetProgressUI();
        
        // Set the task ID
        currentTaskId = taskId;
        document.getElementById('taskIdText').textContent = taskId;
        
        // Record start time
        startTime = new Date();
        
        // Start the elapsed time counter
        taskInterval = setInterval(updateElapsedTime, 1000);
        
        // Start polling for task status
        pollTaskStatus(taskId);
    }

    function updateElapsedTime() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('elapsedTimeText').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function pollTaskStatus(taskId) {
        fetch(`/api/tasks/${taskId}/status`)
            .then(response => response.json())
            .then(data => {
                updateProgressUI(data);
                
                // Continue polling if the task is still in progress
                if (!['SUCCESS', 'FAILURE', 'REVOKED'].includes(data.status)) {
                    setTimeout(() => pollTaskStatus(taskId), 2000);
                } else {
                    // Task is complete (success or failure)
                    clearInterval(taskInterval);
                    
                    if (data.status === 'SUCCESS') {
                        showSuccessState(data);
                    } else {
                        showErrorState(data);
                    }
                }
            })
            .catch(error => {
                console.error('Error polling task status:', error);
                // Continue polling despite error unless max retries reached
                setTimeout(() => pollTaskStatus(taskId), 5000);
            });
    }

    function updateProgressUI(data) {
        // Update the progress bar
        const progress = data.progress || 0;
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        document.getElementById('progressPercentage').textContent = `${progress}%`;
        
        // Update the status text
        document.getElementById('taskStatusText').textContent = data.status_message || data.status;
        
        // Update subtasks status
        if (data.subtasks) {
            updateSubtasks(data.subtasks);
        }
    }

    function updateSubtasks(subtasks) {
        const subTasksList = document.getElementById('subTasksList');
        const listItems = subTasksList.querySelectorAll('li');
        
        subtasks.forEach((subtask, index) => {
            if (index < listItems.length) {
                const badge = listItems[index].querySelector('.badge');
                
                switch (subtask.status) {
                    case 'PENDING':
                        badge.className = 'badge bg-secondary rounded-pill';
                        badge.textContent = 'Waiting';
                        break;
                    case 'STARTED':
                        badge.className = 'badge bg-primary rounded-pill';
                        badge.textContent = 'In Progress';
                        break;
                    case 'SUCCESS':
                        badge.className = 'badge bg-success rounded-pill';
                        badge.textContent = 'Complete';
                        break;
                    case 'FAILURE':
                        badge.className = 'badge bg-danger rounded-pill';
                        badge.textContent = 'Failed';
                        break;
                    default:
                        badge.className = 'badge bg-secondary rounded-pill';
                        badge.textContent = subtask.status;
                }
            }
        });
    }

    function showSuccessState(data) {
        document.getElementById('progressContainer').classList.add('d-none');
        document.getElementById('successState').classList.remove('d-none');
        
        // Store the result data for later use
        window.taskResult = data.result;
    }

    function showErrorState(data) {
        document.getElementById('progressContainer').classList.add('d-none');
        document.getElementById('errorState').classList.remove('d-none');
        
        // Set error message
        document.getElementById('errorMessage').textContent = data.error_message || 'An error occurred during video generation.';
        
        // Set detailed error
        document.getElementById('errorDetailText').textContent = data.traceback || data.error_message || 'No detailed error information available.';
        
        // Update troubleshooting list based on the error
        updateTroubleshootingSuggestions(data);
    }

    function updateTroubleshootingSuggestions(data) {
        const troubleshootingList = document.getElementById('troubleshootingList');
        troubleshootingList.innerHTML = '';
        
        // Default suggestions
        const suggestions = [
            'Check your internet connection',
            'Ensure your files were uploaded correctly',
            'Try selecting a different style preset',
            'Refresh the page and try again'
        ];
        
        // Add specific suggestions based on error type
        if (data.error_type) {
            switch (data.error_type) {
                case 'FileNotFoundError':
                    suggestions.unshift('The uploaded file could not be found. Try uploading again.');
                    break;
                case 'APIError':
                    suggestions.unshift('There was an issue with the external API. Try again later.');
                    break;
                case 'ProcessingError':
                    suggestions.unshift('Try using a different format or smaller file size.');
                    break;
            }
        }
        
        // Add suggestions to the list
        suggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.textContent = suggestion;
            troubleshootingList.appendChild(li);
        });
    }

    function fetchTaskLog(taskId) {
        document.getElementById('taskLog').textContent = 'Fetching logs...';
        
        fetch(`/api/tasks/${taskId}/log`)
            .then(response => response.json())
            .then(data => {
                if (data.log) {
                    document.getElementById('taskLog').textContent = data.log;
                } else {
                    document.getElementById('taskLog').textContent = 'No logs available for this task.';
                }
            })
            .catch(error => {
                console.error('Error fetching task log:', error);
                document.getElementById('taskLog').textContent = 'Failed to fetch task logs. Please try again.';
            });
    }

    function cancelTask(taskId) {
        fetch(`/api/tasks/${taskId}/revoke`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clearInterval(taskInterval);
                    showErrorState({
                        error_message: 'Task was cancelled by user',
                        error_type: 'UserCancelled'
                    });
                } else {
                    alert('Failed to cancel task: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error cancelling task:', error);
                alert('Failed to cancel task due to a network error. Please try again.');
            });
    }

    function retryTask() {
        // This should recreate the same task with the same parameters
        // For now, we'll just reset the UI
        resetProgressUI();
        document.getElementById('celeryProgressSection').classList.add('d-none');
        
        // In a real implementation, this would restart the task with the same parameters
        alert('Retry functionality will be implemented here. This would restart the task with the same parameters.');
    }

    // Function to be called when starting a new video generation task
    function startVideoGenerationTask(videoParams) {
        showProgressSection();
        
        // Make API call to start the task
        fetch('/api/videos/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(videoParams)
        })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    startTaskTracking(data.task_id);
                } else {
                    showErrorState({
                        error_message: data.message || 'Failed to start task',
                        error_type: 'StartupError'
                    });
                }
            })
            .catch(error => {
                console.error('Error starting video generation task:', error);
                showErrorState({
                    error_message: 'Failed to start task due to a network error',
                    error_type: 'NetworkError'
                });
            });
    }

    // Expose this function globally so it can be called from other components
    window.startVideoGenerationTask = startVideoGenerationTask;
    </script>

    <!-- Video Preview Section -->
    <section class="container mt-5" id="videoPreviewSection">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Video Preview</h4>
                    <div class="btn-group" role="group" aria-label="Platform selector">
                        <input type="radio" class="btn-check" name="platformView" id="platformYouTube" value="youtube" checked>
                        <label class="btn btn-outline-danger" for="platformYouTube">
                            <i class="bi bi-youtube"></i> YouTube
                        </label>
                        
                        <input type="radio" class="btn-check" name="platformView" id="platformTikTok" value="tiktok">
                        <label class="btn btn-outline-dark" for="platformTikTok">
                            <i class="bi bi-tiktok"></i> TikTok
                        </label>
                        
                        <input type="radio" class="btn-check" name="platformView" id="platformInstagram" value="instagram">
                        <label class="btn btn-outline-primary" for="platformInstagram">
                            <i class="bi bi-instagram"></i> Instagram
                        </label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <!-- Video Preview Container -->
                        <div class="position-relative video-preview-container">
                            <!-- Platform specific frames -->
                            <div class="youtube-frame platform-frame active" id="youtubeFrame">
                                <div class="ratio ratio-9x16 video-container">
                                    <video id="previewVideo" controls muted>
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="platform-overlay youtube-overlay">
                                    <div class="youtube-header">
                                        <div class="d-flex align-items-center">
                                            <img src="/static/images/avatar.jpg" class="rounded-circle me-2" width="24" height="24">
                                            <span class="channel-name">Your Channel</span>
                                        </div>
                                        <button class="btn btn-sm btn-danger rounded-pill">Subscribe</button>
                                    </div>
                                    <div class="youtube-footer">
                                        <div class="video-title">Your video title here</div>
                                        <div class="d-flex mt-2">
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-hand-thumbs-up"></i> Like
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-hand-thumbs-down"></i> Dislike
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-chat-dots"></i> Comment
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0">
                                                <i class="bi bi-share"></i> Share
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tiktok-frame platform-frame" id="tiktokFrame">
                                <div class="ratio ratio-9x16 video-container">
                                    <video id="tiktokVideo" controls muted>
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="platform-overlay tiktok-overlay">
                                    <div class="tiktok-right-controls">
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-heart-fill"></i>
                                            <div>234K</div>
                                        </div>
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-chat-dots-fill"></i>
                                            <div>1.2K</div>
                                        </div>
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-bookmark-fill"></i>
                                            <div>55.6K</div>
                                        </div>
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-share-fill"></i>
                                            <div>Share</div>
                                        </div>
                                    </div>
                                    <div class="tiktok-footer">
                                        <div class="d-flex align-items-center">
                                            <img src="/static/images/avatar.jpg" class="rounded-circle me-2" width="40" height="40">
                                            <span class="tiktok-username">@yourusername</span>
                                            <button class="btn btn-sm btn-danger ms-2 rounded-pill">Follow</button>
                                        </div>
                                        <div class="tiktok-caption mt-2">
                                            Your video caption here #shorts #trending #viral
                                        </div>
                                        <div class="tiktok-sound mt-1">
                                            <i class="bi bi-music-note-beamed"></i> original sound - yourusername
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="instagram-frame platform-frame" id="instagramFrame">
                                <div class="ratio ratio-9x16 video-container">
                                    <video id="instagramVideo" controls muted>
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="platform-overlay instagram-overlay">
                                    <div class="instagram-header">
                                        <div class="d-flex align-items-center">
                                            <img src="/static/images/avatar.jpg" class="rounded-circle me-2" width="30" height="30">
                                            <span class="instagram-username">yourusername</span>
                                            <i class="bi bi-dot"></i>
                                            <span class="text-primary">Follow</span>
                                        </div>
                                    </div>
                                    <div class="instagram-footer">
                                        <div class="d-flex mb-2">
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-heart"></i>
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-chat"></i>
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0">
                                                <i class="bi bi-send"></i>
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 ms-auto">
                                                <i class="bi bi-bookmark"></i>
                                            </button>
                                        </div>
                                        <div class="instagram-likes">123,456 likes</div>
                                        <div class="instagram-caption">
                                            <span class="instagram-username">yourusername</span>
                                            Your video caption here #reels #trending #viral
                                        </div>
                                        <div class="instagram-comments mt-1">
                                            View all 1,234 comments
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="video-info-panel">
                            <h5 class="mb-3">Video Information</h5>
                            
                            <div class="mb-3">
                                <label for="videoTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="videoTitle" placeholder="Enter video title">
                            </div>
                            
                            <div class="mb-3">
                                <label for="videoDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="videoDescription" rows="3" placeholder="Enter video description"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="videoHashtags" class="form-label">Hashtags</label>
                                <input type="text" class="form-control" id="videoHashtags" placeholder="#shorts #trending #viral">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Publish To</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="publishYouTube" checked>
                                        <label class="form-check-label" for="publishYouTube">YouTube Shorts</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="publishTikTok">
                                        <label class="form-check-label" for="publishTikTok">TikTok</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="publishInstagram">
                                        <label class="form-check-label" for="publishInstagram">Instagram Reels</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button type="button" class="btn btn-success w-100" id="generateAIMetadataBtn">
                                    <i class="bi bi-magic"></i> Generate with AI
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button type="button" class="btn btn-primary btn-lg" id="publishVideoBtn">
                        <i class="bi bi-cloud-upload"></i> Publish Now
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-lg ms-2" id="scheduleVideoBtn">
                        <i class="bi bi-calendar-plus"></i> Schedule for Later
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Video Scheduling Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">Schedule Video Publishing</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="scheduleDatetime" class="form-label">Select Date and Time</label>
                        <input type="datetime-local" class="form-control" id="scheduleDatetime">
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useOptimalTime">
                            <label class="form-check-label" for="useOptimalTime">
                                Use AI-recommended optimal time for maximum engagement
                            </label>
                        </div>
                    </div>
                    
                    <div class="optimal-time-suggestions d-none" id="optimalTimeSuggestions">
                        <div class="alert alert-info mb-3">
                            <h6 class="alert-heading">Recommended publishing times:</h6>
                            <ul class="mb-0">
                                <li><strong>YouTube Shorts:</strong> Tuesday, 3:00 PM - 6:00 PM (your local time)</li>
                                <li><strong>TikTok:</strong> Thursday, 7:00 PM - 9:00 PM (your local time)</li>
                                <li><strong>Instagram Reels:</strong> Monday, 6:00 PM - 8:00 PM (your local time)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Publishing Platforms</label>
                        <div class="platform-schedule-list">
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scheduleYouTube" checked>
                                        <label class="form-check-label d-flex justify-content-between w-100" for="scheduleYouTube">
                                            <span><i class="bi bi-youtube text-danger"></i> YouTube Shorts</span>
                                            <small class="text-muted">Highest engagement</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scheduleTikTok">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="scheduleTikTok">
                                            <span><i class="bi bi-tiktok"></i> TikTok</span>
                                            <small class="text-muted">Trending platform</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scheduleInstagram">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="scheduleInstagram">
                                            <span><i class="bi bi-instagram text-primary"></i> Instagram Reels</span>
                                            <small class="text-muted">Good for brand building</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmScheduleBtn">Schedule Video</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Preview JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initVideoPreview();
    });

    function initVideoPreview() {
        // Platform view toggle
        const platformRadios = document.querySelectorAll('input[name="platformView"]');
        platformRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updatePlatformView(this.value);
            });
        });
        
        // Schedule button
        const scheduleVideoBtn = document.getElementById('scheduleVideoBtn');
        const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        
        scheduleVideoBtn.addEventListener('click', function() {
            // Set default scheduled time to tomorrow at current time
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateTimeString = tomorrow.toISOString().slice(0, 16);
            document.getElementById('scheduleDatetime').value = dateTimeString;
            
            // Update platform checkboxes based on publish selection
            document.getElementById('scheduleYouTube').checked = document.getElementById('publishYouTube').checked;
            document.getElementById('scheduleTikTok').checked = document.getElementById('publishTikTok').checked;
            document.getElementById('scheduleInstagram').checked = document.getElementById('publishInstagram').checked;
            
            scheduleModal.show();
        });
        
        // Optimal time checkbox
        const useOptimalTime = document.getElementById('useOptimalTime');
        const optimalTimeSuggestions = document.getElementById('optimalTimeSuggestions');
        
        useOptimalTime.addEventListener('change', function() {
            if (this.checked) {
                optimalTimeSuggestions.classList.remove('d-none');
            } else {
                optimalTimeSuggestions.classList.add('d-none');
            }
        });
        
        // Confirm schedule button
        const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
        
        confirmScheduleBtn.addEventListener('click', function() {
            const scheduleDatetime = document.getElementById('scheduleDatetime').value;
            const useOptimal = document.getElementById('useOptimalTime').checked;
            
            const platforms = [];
            if (document.getElementById('scheduleYouTube').checked) platforms.push('youtube');
            if (document.getElementById('scheduleTikTok').checked) platforms.push('tiktok');
            if (document.getElementById('scheduleInstagram').checked) platforms.push('instagram');
            
            if (!scheduleDatetime && !useOptimal) {
                alert('Please select a date and time or use the optimal time option.');
                return;
            }
            
            if (platforms.length === 0) {
                alert('Please select at least one platform to publish to.');
                return;
            }
            
            // In a real implementation, this would call an API to schedule the video
            console.log('Scheduling video for:', scheduleDatetime);
            console.log('Use optimal time:', useOptimal);
            console.log('Platforms:', platforms);
            
            // Close the modal and show a success message
            scheduleModal.hide();
            alert('Your video has been scheduled successfully!');
        });
        
        // Generate AI metadata button
        const generateAIMetadataBtn = document.getElementById('generateAIMetadataBtn');
        
        generateAIMetadataBtn.addEventListener('click', function() {
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
            this.disabled = true;
            
            // Simulate API call delay
            setTimeout(() => {
                // Update fields with AI-generated content
                document.getElementById('videoTitle').value = 'This Beat Drop Will Give You Chills!  #shorts';
                document.getElementById('videoDescription').value = 'Watch how this music-responsive visual transforms with every beat! Created using AI technology. Like and subscribe for more amazing content like this!';
                document.getElementById('videoHashtags').value = '#shorts #musicvisualization #beatdrop #viral #trending #musicproduction';
                
                // Update preview title and caption in the platform views
                updatePlatformPreviewText();
                
                // Reset button
                this.innerHTML = '<i class="bi bi-magic"></i> Generate with AI';
                this.disabled = false;
                
                // Show success toast
                const toast = new bootstrap.Toast(document.getElementById('aiGeneratedToast'));
                toast.show();
            }, 2000);
        });
        
        // Update text fields for video info
        const videoTitle = document.getElementById('videoTitle');
        const videoDescription = document.getElementById('videoDescription');
        const videoHashtags = document.getElementById('videoHashtags');
        
        [videoTitle, videoDescription, videoHashtags].forEach(element => {
            element.addEventListener('input', updatePlatformPreviewText);
        });
        
        // Initialize with default video source
        // In a real implementation, this would be updated when a video is generated
        setPreviewVideo('/static/videos/sample-preview.mp4');
        
        // Initialize with YouTube as default platform view
        updatePlatformView('youtube');
    }

    function updatePlatformView(platform) {
        // Hide all platform frames
        document.querySelectorAll('.platform-frame').forEach(frame => {
            frame.classList.remove('active');
        });
        
        // Show the selected platform frame
        let frameId;
        switch (platform) {
            case 'tiktok':
                frameId = 'tiktokFrame';
                break;
            case 'instagram':
                frameId = 'instagramFrame';
                break;
            default:
                frameId = 'youtubeFrame';
        }
        
        document.getElementById(frameId).classList.add('active');
        
        // Update platform-specific content
        updatePlatformPreviewText();
    }

    function updatePlatformPreviewText() {
        const title = document.getElementById('videoTitle').value || 'Your video title here';
        const description = document.getElementById('videoDescription').value || 'Your video description here';
        const hashtags = document.getElementById('videoHashtags').value || '#shorts #trending #viral';
        
        // Update YouTube elements
        document.querySelector('.youtube-footer .video-title').textContent = title;
        
        // Update TikTok elements
        document.querySelector('.tiktok-caption').textContent = `${description} ${hashtags}`;
        
        // Update Instagram elements
        document.querySelector('.instagram-caption').textContent = '';
        document.querySelector('.instagram-caption').innerHTML = 
            `<span class="instagram-username">yourusername</span> ${description} ${hashtags}`;
    }

    function setPreviewVideo(videoUrl) {
        // Set the source for all platform videos
        document.getElementById('previewVideo').src = videoUrl;
        document.getElementById('tiktokVideo').src = videoUrl;
        document.getElementById('instagramVideo').src = videoUrl;
        
        // Load the videos
        document.getElementById('previewVideo').load();
        document.getElementById('tiktokVideo').load();
        document.getElementById('instagramVideo').load();
    }

    // Function to be called when a new video has been generated
    function updateVideoPreview(videoData) {
        // Show the video preview section
        document.getElementById('videoPreviewSection').classList.remove('d-none');
        
        // Scroll to the preview section
        document.getElementById('videoPreviewSection').scrollIntoView({behavior: 'smooth'});
        
        // Set the video source
        if (videoData && videoData.video_url) {
            setPreviewVideo(videoData.video_url);
        }
        
        // Update metadata if available
        if (videoData && videoData.metadata) {
            if (videoData.metadata.title) {
                document.getElementById('videoTitle').value = videoData.metadata.title;
            }
            
            if (videoData.metadata.description) {
                document.getElementById('videoDescription').value = videoData.metadata.description;
            }
            
            if (videoData.metadata.hashtags) {
                document.getElementById('videoHashtags').value = videoData.metadata.hashtags.join(' ');
            }
            
            // Update platform preview text
            updatePlatformPreviewText();
        }
    }

    // Expose this function globally so it can be called from other components
    window.updateVideoPreview = updateVideoPreview;
    </script>

    <!-- AI Generated Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="aiGeneratedToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-magic me-2 text-primary"></i>
                <strong class="me-auto">AI Generated Content</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                AI has successfully generated title, description, and hashtags for your video.
            </div>
        </div>
    </div>

    <!-- Main Integration Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initMainApp();
    });

    // Global state
    const appState = {
        selectedMusicTrack: null,
        selectedStylePreset: null,
        selectedImages: [],
        generatedVideoId: null,
        generatedTaskId: null
    };

    function initMainApp() {
        // Hook up the generate video button
        const generateButton = document.getElementById('generateVideoBtn');
        if (generateButton) {
            generateButton.addEventListener('click', function() {
                generateMusicResponsiveVideo();
            });
        }
        
        // Hook up the publish button
        const publishButton = document.getElementById('publishVideoBtn');
        if (publishButton) {
            publishButton.addEventListener('click', function() {
                publishGeneratedVideo(false);
            });
        }
        
        // Listen for music track selection
        document.addEventListener('musicTrackSelected', function(event) {
            appState.selectedMusicTrack = event.detail;
            updateGenerateButtonState();
        });
        
        // Listen for style preset selection
        document.addEventListener('stylePresetSelected', function(event) {
            appState.selectedStylePreset = event.detail;
            updateGenerateButtonState();
        });
        
        // Initially hide video preview until a video is generated
        const videoPreviewSection = document.getElementById('videoPreviewSection');
        if (videoPreviewSection) {
            videoPreviewSection.classList.add('d-none');
        }
        
        // Initially hide progress section
        const progressSection = document.getElementById('celeryProgressSection');
        if (progressSection) {
            progressSection.classList.add('d-none');
        }
    }

    function updateGenerateButtonState() {
        const generateButton = document.getElementById('generateVideoBtn');
        if (generateButton) {
            // Enable the button only if both a music track and style preset are selected
            const canGenerate = appState.selectedMusicTrack && appState.selectedStylePreset;
            generateButton.disabled = !canGenerate;
        }
    }

    function generateMusicResponsiveVideo() {
        // Validate that we have the required selections
        if (!appState.selectedMusicTrack || !appState.selectedStylePreset) {
            alert('Please select both a music track and a style preset.');
            return;
        }
        
        // Collect image paths (in a real implementation, these would be collected from the UI)
        // For now, we'll use mock data
        const imagePaths = appState.selectedImages.length > 0 ? 
            appState.selectedImages : 
            ['/static/images/sample1.jpg', '/static/images/sample2.jpg', '/static/images/sample3.jpg'];
        
        // Prepare the video generation parameters
        const params = {
            music_track_id: appState.selectedMusicTrack.id,
            style_preset: appState.selectedStylePreset.preset,
            images: imagePaths,
            video_clips: [],
            captions_enabled: true,
            target_platforms: ["youtube"]
        };
        
        // Start the video generation task using our global function
        window.startVideoGenerationTask(params);
        
        // In a real implementation, the startVideoGenerationTask function would make an API call
        // When the task is complete, it would call updateVideoPreview with the result
        
        // For demonstration, we'll simulate a successful generation after a delay
        setTimeout(() => {
            const mockVideoData = {
                video_id: "video_" + Math.random().toString(36).substr(2, 9),
                video_url: '/static/videos/sample-preview.mp4',
                metadata: {
                    title: 'Amazing Music-Responsive Video',
                    description: 'Check out this awesome video generated with Nova Sounds Shorts Machine!',
                    hashtags: ['#shorts', '#musicvideo', '#novamachine']
                }
            };
            
            // Update the video preview
            window.updateVideoPreview(mockVideoData);
            
            // Store the generated video ID
            appState.generatedVideoId = mockVideoData.video_id;
        }, 15000); // Simulate 15 seconds of processing
    }

    function publishGeneratedVideo(schedule = false) {
        // Validate that we have a generated video
        if (!appState.generatedVideoId) {
            alert('Please generate a video first.');
            return;
        }
        
        // Get metadata from the form
        const title = document.getElementById('videoTitle').value;
        const description = document.getElementById('videoDescription').value;
        const hashtags = document.getElementById('videoHashtags').value;
        
        // Get selected platforms
        const platforms = [];
        if (document.getElementById('publishYouTube').checked) platforms.push('youtube');
        if (document.getElementById('publishTikTok').checked) platforms.push('tiktok');
        if (document.getElementById('publishInstagram').checked) platforms.push('instagram');
        
        if (platforms.length === 0) {
            alert('Please select at least one platform to publish to.');
            return;
        }
        
        // Prepare metadata
        const metadata = {
            title: title,
            description: description,
            hashtags: hashtags.split(' ').filter(tag => tag.startsWith('#'))
        };
        
        if (schedule) {
            // Show the schedule modal
            document.getElementById('scheduleVideoBtn').click();
        } else {
            // Publish immediately
            publishToSelectedPlatforms(appState.generatedVideoId, platforms, metadata);
        }
    }

    function publishToSelectedPlatforms(videoId, platforms, metadata) {
        // In a real implementation, this would make API calls to publish the video
        console.log('Publishing video:', videoId);
        console.log('To platforms:', platforms);
        console.log('With metadata:', metadata);
        
        // Show a loading indicator
        const publishButton = document.getElementById('publishVideoBtn');
        const originalText = publishButton.innerHTML;
        publishButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Publishing...';
        publishButton.disabled = true;
        
        // Simulate API call delay
        setTimeout(() => {
            // Reset the button
            publishButton.innerHTML = originalText;
            publishButton.disabled = false;
            
            // Show success message
            alert('Your video has been successfully published to ' + platforms.join(', ') + '!');
        }, 3000);
    }

    // Connect the schedule confirmation button to the publishing function
    document.addEventListener('DOMContentLoaded', function() {
        const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
        if (confirmScheduleBtn) {
            confirmScheduleBtn.addEventListener('click', function() {
                // Get scheduling info from the modal
                const scheduleDatetime = document.getElementById('scheduleDatetime').value;
                const useOptimal = document.getElementById('useOptimalTime').checked;
                
                // Get selected platforms
                const platforms = [];
                if (document.getElementById('scheduleYouTube').checked) platforms.push('youtube');
                if (document.getElementById('scheduleTikTok').checked) platforms.push('tiktok');
                if (document.getElementById('scheduleInstagram').checked) platforms.push('instagram');
                
                // Get metadata from the form
                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;
                const hashtags = document.getElementById('videoHashtags').value;
                
                // Prepare request data
                const scheduleData = {
                    video_id: appState.generatedVideoId,
                    platforms: platforms,
                    scheduled_datetime: scheduleDatetime,
                    use_optimal_time: useOptimal,
                    metadata: {
                        title: title,
                        description: description,
                        hashtags: hashtags.split(' ').filter(tag => tag.startsWith('#'))
                    }
                };
                
                // Make API call to schedule the video
                fetch('/api/scheduler/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Close the modal
                            const scheduleModal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                            scheduleModal.hide();
                            
                            // Show success message
                            alert('Your video has been scheduled successfully!');
                        } else {
                            alert('Error scheduling video: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error scheduling video:', error);
                        alert('Error scheduling video. Please try again.');
                    });
            });
        }
    });
    </script>

    <!-- Add a "Generate Video" button at the appropriate location -->
    <div class="container mt-4 text-center">
        <button type="button" class="btn btn-primary btn-lg" id="generateVideoBtn" disabled>
            <i class="bi bi-gear-wide-connected"></i> Generate Music-Responsive Video
        </button>
    </div>
    
    <!-- FullCalendar Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    
    <!-- Chart.js for analytics dashboards -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    
    <!-- Scheduling Calendar Component -->
    <script src="/static/js/scheduler.js"></script>
    
    <!-- Analytics Dashboard JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize scheduling calendar when the schedule tab is shown
            const scheduleTab = document.getElementById('schedule-tab');
            if (scheduleTab) {
                scheduleTab.addEventListener('shown.bs.tab', function (e) {
                    // Initialize the calendar if it doesn't exist yet
                    if (!window.schedulerCalendar) {
                        window.schedulerCalendar = new SchedulerCalendar('schedulingCalendar', {
                            onScheduleSave: function(scheduleData) {
                                // Send the schedule data to the API
                                fetch('/api/scheduler/publish', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(scheduleData)
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'success') {
                                        alert('Your content has been scheduled successfully!');
                                        // Reload the calendar events
                                        window.schedulerCalendar.loadSchedules();
                                    } else {
                                        alert('Error scheduling content: ' + data.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error scheduling content:', error);
                                    alert('Error scheduling content. Please try again.');
                                });
                            }
                        });
                    }
                });
            }
            
            // Initialize music browser functionality
            initMusicBrowser();
            
            // Initialize analytics dashboard
            initAnalyticsDashboard();
        });
        
        // Analytics dashboard initialization
        function initAnalyticsDashboard() {
            // Only initialize if the tab exists
            if (!document.getElementById('analytics-tab')) return;
            
            // Show loading state when analytics tab is clicked
            document.getElementById('analytics-tab').addEventListener('shown.bs.tab', function() {
                loadAnalyticsData();
            });
            
            // Show loading state
            document.getElementById('analytics-loading').style.display = 'block';
            document.getElementById('analytics-error').style.display = 'none';
            document.getElementById('analytics-content').style.display = 'none';
            
            // Set up refresh event handler
            document.getElementById('refreshVideosBtn').addEventListener('click', function() {
                loadGeneratedVideos();
            });
            
            // Set up retry button
            document.getElementById('retry-analytics-btn').addEventListener('click', function() {
                loadAnalyticsData();
            });
        }
        
        // Load all analytics data
        async function loadAnalyticsData() {
            try {
                // Fetch analytics data from API
                const response = await fetch('/api/dashboard/analytics');
                
                if (!response.ok) {
                    throw new Error('Failed to load analytics data');
                }
                
                const data = await response.json();
                
                // Update dashboard metrics
                updateDashboardMetrics(data);
                
                // Load generated videos
                loadGeneratedVideos();
                
                // Initialize charts
                initializePlatformViewsChart(data.platform_views);
                
                // Update top tracks table
                updateTopTracksTable(data.top_tracks);
                
                // Update affiliate stats
                updateAffiliateStats(data.affiliate_stats);
                
                // Hide loading, show content
                document.getElementById('analytics-loading').style.display = 'none';
                document.getElementById('analytics-content').style.display = 'block';
            } catch (error) {
                console.error('Error loading analytics data:', error);
                document.getElementById('analytics-loading').style.display = 'none';
                document.getElementById('analytics-error').style.display = 'block';
            }
        }
        
        // Update dashboard metric cards
        function updateDashboardMetrics(data) {
            document.getElementById('totalViewsValue').textContent = formatNumber(data.total_views || 0);
            document.getElementById('totalLikesValue').textContent = formatNumber(data.total_likes || 0);
            document.getElementById('videosGeneratedValue').textContent = formatNumber(data.videos_generated || 0);
            document.getElementById('engagementRateValue').textContent = `${(data.engagement_rate || 0).toFixed(1)}%`;
            
            document.getElementById('viewsTrendValue').textContent = (data.views_trend || 0).toFixed(1);
            document.getElementById('likesTrendValue').textContent = (data.likes_trend || 0).toFixed(1);
            document.getElementById('videosTrendValue').textContent = (data.videos_trend || 0).toFixed(1);
            document.getElementById('engagementTrendValue').textContent = (data.engagement_trend || 0).toFixed(1);
        }
        
        // Load generated videos
        async function loadGeneratedVideos() {
            const videosList = document.getElementById('generatedVideosList');
            videosList.innerHTML = '<tr><td colspan="7" class="text-center py-4">Loading your videos...</td></tr>';
            
            try {
                // Fetch videos from API
                const response = await fetch('/api/videos/generated');
                
                if (!response.ok) {
                    throw new Error('Failed to load generated videos');
                }
                
                const data = await response.json();
                
                if (!data.videos || data.videos.length === 0) {
                    videosList.innerHTML = '<tr><td colspan="7" class="text-center py-4">No videos generated yet</td></tr>';
                    return;
                }
                
                // Clear the table
                videosList.innerHTML = '';
                
                // Add videos to the table
                data.videos.forEach(video => {
                    const row = document.createElement('tr');
                    
                    // Format date
                    const createdDate = new Date(video.created_at);
                    const formattedDate = createdDate.toLocaleDateString();
                    
                    // Platform badges
                    const platformBadges = video.platforms.map(platform => {
                        const badgeClass = getPlatformBadgeClass(platform);
                        const platformIcon = getPlatformIcon(platform);
                        return `<span class="badge ${badgeClass} me-1">${platformIcon} ${platform}</span>`;
                    }).join('');
                    
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="video-thumbnail me-2" style="width: 120px; height: 67px; overflow: hidden; border-radius: 4px;">
                                    <img src="${video.thumbnail_url || '/static/img/placeholder-thumbnail.jpg'}" 
                                         class="w-100 h-100" style="object-fit: cover;" alt="Video thumbnail">
                                </div>
                                <div class="video-info small">
                                    <div class="text-truncate" style="max-width: 150px;">ID: ${video.video_id}</div>
                                    <div class="text-muted">Style: ${video.style || 'Standard'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${video.title || 'Untitled'}</td>
                        <td>${platformBadges}</td>
                        <td>${formattedDate}</td>
                        <td>${formatNumber(video.views || 0)}</td>
                        <td>${formatNumber(video.likes || 0)}</td>
                        <td>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary preview-video-btn" 
                                        data-video-id="${video.video_id}" data-video-url="${video.video_url}">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary edit-metadata-btn"
                                        data-video-id="${video.video_id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success republish-video-btn"
                                        data-video-id="${video.video_id}">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    videosList.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.preview-video-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const videoId = this.dataset.videoId;
                        const videoUrl = this.dataset.videoUrl;
                        previewVideo(videoId, videoUrl);
                    });
                });
                
                document.querySelectorAll('.edit-metadata-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const videoId = this.dataset.videoId;
                        editVideoMetadata(videoId);
                    });
                });
                
                document.querySelectorAll('.republish-video-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const videoId = this.dataset.videoId;
                        republishVideo(videoId);
                    });
                });
            } catch (error) {
                console.error('Error loading generated videos:', error);
                videosList.innerHTML = '<tr><td colspan="7" class="text-center py-4">Error loading videos</td></tr>';
            }
        }
        
        // Initialize platform views chart
        function initializePlatformViewsChart(platformViews) {
            const ctx = document.getElementById('platformViewsChart').getContext('2d');
            
            // Extract data for chart
            const labels = Object.keys(platformViews || {});
            const data = labels.map(platform => platformViews[platform] || 0);
            const colors = labels.map(platform => getPlatformColor(platform));
            
            // Create chart
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(p => p.charAt(0).toUpperCase() + p.slice(1)),
                    datasets: [{
                        label: 'Views',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c + '80'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Update top tracks table
        function updateTopTracksTable(topTracks) {
            const table = document.getElementById('topTracksTable');
            
            if (!topTracks || topTracks.length === 0) {
                table.innerHTML = '<tr><td colspan="5" class="text-center py-4">No data available</td></tr>';
                return;
            }
            
            table.innerHTML = '';
            
            topTracks.forEach((track, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="track-icon me-2">
                                <i class="bi bi-music-note"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${track.title || 'Unknown Track'}</div>
                                <div class="small text-muted">${track.artist || 'Unknown Artist'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${track.genre || 'Unknown'}</td>
                    <td>${track.video_count || 0}</td>
                    <td>${formatNumber(track.total_views || 0)}</td>
                `;
                
                table.appendChild(row);
            });
        }
        
        // Update affiliate stats
        function updateAffiliateStats(stats) {
            if (!stats) return;
            
            document.getElementById('dashboardReferralsValue').textContent = stats.total_referrals || 0;
            document.getElementById('dashboardEarningsValue').textContent = `$${(stats.total_earnings || 0).toFixed(2)}`;
            document.getElementById('dashboardConversionRateValue').textContent = `${(stats.conversion_rate || 0).toFixed(1)}%`;
        }
        
        // Helper: Format numbers with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Helper: Get platform badge class
        function getPlatformBadgeClass(platform) {
            const classes = {
                youtube: 'bg-danger',
                tiktok: 'bg-dark',
                instagram: 'bg-purple',
                facebook: 'bg-primary',
                default: 'bg-secondary'
            };
            
            return classes[platform.toLowerCase()] || classes.default;
        }
        
        // Helper: Get platform icon
        function getPlatformIcon(platform) {
            const icons = {
                youtube: '<i class="bi bi-youtube"></i>',
                tiktok: '<i class="bi bi-tiktok"></i>',
                instagram: '<i class="bi bi-instagram"></i>',
                facebook: '<i class="bi bi-facebook"></i>',
                default: '<i class="bi bi-camera-video"></i>'
            };
            
            return icons[platform.toLowerCase()] || icons.default;
        }
        
        // Helper: Get platform color
        function getPlatformColor(platform) {
            const colors = {
                youtube: '#FF0000',
                tiktok: '#000000',
                instagram: '#C13584',
                facebook: '#4267B2',
                default: '#6c757d'
            };
            
            return colors[platform.toLowerCase()] || colors.default;
        }
        
        // Preview video in modal
        function previewVideo(videoId, videoUrl) {
            // Implementation will depend on your video modal
            console.log('Preview video:', videoId, videoUrl);
            
            // Example implementation:
            // const modal = new bootstrap.Modal(document.getElementById('videoPreviewModal'));
            // document.getElementById('previewVideoPlayer').src = videoUrl;
            // modal.show();
        }
        
        // Edit video metadata
        function editVideoMetadata(videoId) {
            // Implementation will depend on your editing UI
            console.log('Edit metadata for video:', videoId);
            
            // Example implementation:
            // window.location.href = `/edit-video/${videoId}`;
        }
        
        // Republish video
        function republishVideo(videoId) {
            // Implementation will depend on your republishing flow
            console.log('Republish video:', videoId);
            
            // Example implementation:
            // window.location.href = `/republish-video/${videoId}`;
        }
        
        function initMusicBrowser() {
            // Track loading and filtering functionality will be implemented here
            const applyFilters = document.getElementById('applyFilters');
            const resetFilters = document.getElementById('resetFilters');
            
            applyFilters.addEventListener('click', function() {
                loadMusicTracks();
            });
            
            resetFilters.addEventListener('click', function() {
                document.getElementById('genreFilter').selectedIndex = -1;
                document.getElementById('moodFilter').selectedIndex = -1;
                document.getElementById('bpmMin').value = '';
                document.getElementById('bpmMax').value = '';
                document.getElementById('licenseFilter').selectedIndex = 0;
            });
            
            // Initial load of music tracks
            loadMusicTracks();
        }
    </script>

    <!-- Toast for style selection confirmation -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="styleToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-palette me-2 text-primary"></i>
                <strong class="me-auto">Style Selected</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="styleToastBody">
                Video style selected successfully.
            </div>
        </div>
    </div>

    <!-- Celery Progress Section -->
    <section class="container mt-5 d-none" id="celeryProgressSection">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Video Generation Progress</h4>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="showLogBtn">
                            <i class="bi bi-terminal"></i> Show Log
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="progressContainer">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fs-6 fw-bold" id="taskStatusText">Initializing...</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" 
                                 role="progressbar" 
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <div>
                            <small class="text-muted">Task ID: <span id="taskIdText">Not started</span></small>
                        </div>
                        <div>
                            <small class="text-muted">Elapsed time: <span id="elapsedTimeText">00:00</span></small>
                        </div>
                    </div>
                    
                    <!-- Sub-tasks progress -->
                    <div class="mt-4" id="subTasksContainer">
                        <h6 class="fw-bold">Processing Steps:</h6>
                        <ul class="list-group list-group-flush" id="subTasksList">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Analyzing audio file <small class="text-muted">(Librosa)</small></span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Extracting beat markers</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Processing image files</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Running RunwayML AI</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Generating video with FFMPEG</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Creating final output</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="mt-4 text-center" id="cancelButtonContainer">
                        <button type="button" class="btn btn-danger" id="cancelTaskBtn">
                            <i class="bi bi-x-circle"></i> Cancel Task
                        </button>
                    </div>
                </div>
                
                <!-- Success state -->
                <div class="text-center py-4 d-none" id="successState">
                    <div class="mb-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h4>Video Generated Successfully!</h4>
                    <p class="text-muted">Your video is now ready for preview and publishing.</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="viewVideoBtn">
                            <i class="bi bi-play-circle"></i> Preview Video
                        </button>
                        <button class="btn btn-outline-primary ms-2" id="startOverBtn">
                            <i class="bi bi-arrow-repeat"></i> Generate Another Video
                        </button>
                    </div>
                </div>
                
                <!-- Error state -->
                <div class="text-center py-4 d-none" id="errorState">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <h4>Video Generation Failed</h4>
                    <p class="text-muted" id="errorMessage">An error occurred during video generation.</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="retryBtn">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                        <button class="btn btn-outline-secondary ms-2" id="errorDetailsBtn" data-bs-toggle="modal" data-bs-target="#errorDetailsModal">
                            <i class="bi bi-info-circle"></i> Error Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Log Modal -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalLabel">Task Execution Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;" id="taskLog">Waiting for log data...</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="copyLogBtn">
                        <i class="bi bi-clipboard"></i> Copy Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Details Modal -->
    <div class="modal fade" id="errorDetailsModal" tabindex="-1" aria-labelledby="errorDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorDetailsModalLabel">Error Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="errorDetailText">
                        Error information will be shown here.
                    </div>
                    <h6>Troubleshooting Suggestions:</h6>
                    <ul id="troubleshootingList">
                        <li>Check your internet connection</li>
                        <li>Ensure your files were uploaded correctly</li>
                        <li>Try selecting a different style preset</li>
                        <li>Refresh the page and try again</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="contactSupportBtn">
                        <i class="bi bi-envelope"></i> Contact Support
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Celery Progress JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initCeleryProgress();
    });

    let taskInterval;
    let startTime;
    let currentTaskId;

    function initCeleryProgress() {
        const showLogBtn = document.getElementById('showLogBtn');
        const copyLogBtn = document.getElementById('copyLogBtn');
        const cancelTaskBtn = document.getElementById('cancelTaskBtn');
        const retryBtn = document.getElementById('retryBtn');
        const viewVideoBtn = document.getElementById('viewVideoBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        
        showLogBtn.addEventListener('click', function() {
            const logModal = new bootstrap.Modal(document.getElementById('logModal'));
            logModal.show();
            // Fetch the latest logs for the current task
            fetchTaskLog(currentTaskId);
        });
        
        copyLogBtn.addEventListener('click', function() {
            const logText = document.getElementById('taskLog').textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('Log copied to clipboard!');
            });
        });
        
        cancelTaskBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this task? This action cannot be undone.')) {
                cancelTask(currentTaskId);
            }
        });
        
        retryBtn.addEventListener('click', function() {
            retryTask();
        });
        
        viewVideoBtn.addEventListener('click', function() {
            // This should open a modal or navigate to a page where the generated video can be previewed
            // For now, we'll just show a message
            alert('Video preview functionality will be implemented here.');
        });
        
        startOverBtn.addEventListener('click', function() {
            resetProgressUI();
            document.getElementById('celeryProgressSection').classList.add('d-none');
            // Scroll to the top of the page or to the file upload section
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
    }

    function showProgressSection() {
        const progressSection = document.getElementById('celeryProgressSection');
        progressSection.classList.remove('d-none');
        
        // Scroll to the progress section
        progressSection.scrollIntoView({behavior: 'smooth'});
        
        // Reset the UI
        resetProgressUI();
    }

    function resetProgressUI() {
        // Reset progress bar
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').setAttribute('aria-valuenow', '0');
        document.getElementById('progressPercentage').textContent = '0%';
        
        // Reset status text
        document.getElementById('taskStatusText').textContent = 'Initializing...';
        document.getElementById('taskIdText').textContent = 'Not started';
        document.getElementById('elapsedTimeText').textContent = '00:00';
        
        // Reset subtasks status
        const subTasksList = document.getElementById('subTasksList');
        const badges = subTasksList.querySelectorAll('.badge');
        badges.forEach(badge => {
            badge.className = 'badge bg-secondary rounded-pill';
            badge.textContent = 'Waiting';
        });
        
        // Show progress container, hide success and error states
        document.getElementById('progressContainer').classList.remove('d-none');
        document.getElementById('successState').classList.add('d-none');
        document.getElementById('errorState').classList.add('d-none');
        
        // Clear any existing interval
        if (taskInterval) {
            clearInterval(taskInterval);
            taskInterval = null;
        }
    }

    function startTaskTracking(taskId) {
        resetProgressUI();
        
        // Set the task ID
        currentTaskId = taskId;
        document.getElementById('taskIdText').textContent = taskId;
        
        // Record start time
        startTime = new Date();
        
        // Start the elapsed time counter
        taskInterval = setInterval(updateElapsedTime, 1000);
        
        // Start polling for task status
        pollTaskStatus(taskId);
    }

    function updateElapsedTime() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('elapsedTimeText').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function pollTaskStatus(taskId) {
        fetch(`/api/tasks/${taskId}/status`)
            .then(response => response.json())
            .then(data => {
                updateProgressUI(data);
                
                // Continue polling if the task is still in progress
                if (!['SUCCESS', 'FAILURE', 'REVOKED'].includes(data.status)) {
                    setTimeout(() => pollTaskStatus(taskId), 2000);
                } else {
                    // Task is complete (success or failure)
                    clearInterval(taskInterval);
                    
                    if (data.status === 'SUCCESS') {
                        showSuccessState(data);
                    } else {
                        showErrorState(data);
                    }
                }
            })
            .catch(error => {
                console.error('Error polling task status:', error);
                // Continue polling despite error unless max retries reached
                setTimeout(() => pollTaskStatus(taskId), 5000);
            });
    }

    function updateProgressUI(data) {
        // Update the progress bar
        const progress = data.progress || 0;
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        document.getElementById('progressPercentage').textContent = `${progress}%`;
        
        // Update the status text
        document.getElementById('taskStatusText').textContent = data.status_message || data.status;
        
        // Update subtasks status
        if (data.subtasks) {
            updateSubtasks(data.subtasks);
        }
    }

    function updateSubtasks(subtasks) {
        const subTasksList = document.getElementById('subTasksList');
        const listItems = subTasksList.querySelectorAll('li');
        
        subtasks.forEach((subtask, index) => {
            if (index < listItems.length) {
                const badge = listItems[index].querySelector('.badge');
                
                switch (subtask.status) {
                    case 'PENDING':
                        badge.className = 'badge bg-secondary rounded-pill';
                        badge.textContent = 'Waiting';
                        break;
                    case 'STARTED':
                        badge.className = 'badge bg-primary rounded-pill';
                        badge.textContent = 'In Progress';
                        break;
                    case 'SUCCESS':
                        badge.className = 'badge bg-success rounded-pill';
                        badge.textContent = 'Complete';
                        break;
                    case 'FAILURE':
                        badge.className = 'badge bg-danger rounded-pill';
                        badge.textContent = 'Failed';
                        break;
                    default:
                        badge.className = 'badge bg-secondary rounded-pill';
                        badge.textContent = subtask.status;
                }
            }
        });
    }

    function showSuccessState(data) {
        document.getElementById('progressContainer').classList.add('d-none');
        document.getElementById('successState').classList.remove('d-none');
        
        // Store the result data for later use
        window.taskResult = data.result;
    }

    function showErrorState(data) {
        document.getElementById('progressContainer').classList.add('d-none');
        document.getElementById('errorState').classList.remove('d-none');
        
        // Set error message
        document.getElementById('errorMessage').textContent = data.error_message || 'An error occurred during video generation.';
        
        // Set detailed error
        document.getElementById('errorDetailText').textContent = data.traceback || data.error_message || 'No detailed error information available.';
        
        // Update troubleshooting list based on the error
        updateTroubleshootingSuggestions(data);
    }

    function updateTroubleshootingSuggestions(data) {
        const troubleshootingList = document.getElementById('troubleshootingList');
        troubleshootingList.innerHTML = '';
        
        // Default suggestions
        const suggestions = [
            'Check your internet connection',
            'Ensure your files were uploaded correctly',
            'Try selecting a different style preset',
            'Refresh the page and try again'
        ];
        
        // Add specific suggestions based on error type
        if (data.error_type) {
            switch (data.error_type) {
                case 'FileNotFoundError':
                    suggestions.unshift('The uploaded file could not be found. Try uploading again.');
                    break;
                case 'APIError':
                    suggestions.unshift('There was an issue with the external API. Try again later.');
                    break;
                case 'ProcessingError':
                    suggestions.unshift('Try using a different format or smaller file size.');
                    break;
            }
        }
        
        // Add suggestions to the list
        suggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.textContent = suggestion;
            troubleshootingList.appendChild(li);
        });
    }

    function fetchTaskLog(taskId) {
        document.getElementById('taskLog').textContent = 'Fetching logs...';
        
        fetch(`/api/tasks/${taskId}/log`)
            .then(response => response.json())
            .then(data => {
                if (data.log) {
                    document.getElementById('taskLog').textContent = data.log;
                } else {
                    document.getElementById('taskLog').textContent = 'No logs available for this task.';
                }
            })
            .catch(error => {
                console.error('Error fetching task log:', error);
                document.getElementById('taskLog').textContent = 'Failed to fetch task logs. Please try again.';
            });
    }

    function cancelTask(taskId) {
        fetch(`/api/tasks/${taskId}/revoke`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clearInterval(taskInterval);
                    showErrorState({
                        error_message: 'Task was cancelled by user',
                        error_type: 'UserCancelled'
                    });
                } else {
                    alert('Failed to cancel task: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error cancelling task:', error);
                alert('Failed to cancel task due to a network error. Please try again.');
            });
    }

    function retryTask() {
        // This should recreate the same task with the same parameters
        // For now, we'll just reset the UI
        resetProgressUI();
        document.getElementById('celeryProgressSection').classList.add('d-none');
        
        // In a real implementation, this would restart the task with the same parameters
        alert('Retry functionality will be implemented here. This would restart the task with the same parameters.');
    }

    // Function to be called when starting a new video generation task
    function startVideoGenerationTask(videoParams) {
        showProgressSection();
        
        // Make API call to start the task
        fetch('/api/videos/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(videoParams)
        })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    startTaskTracking(data.task_id);
                } else {
                    showErrorState({
                        error_message: data.message || 'Failed to start task',
                        error_type: 'StartupError'
                    });
                }
            })
            .catch(error => {
                console.error('Error starting video generation task:', error);
                showErrorState({
                    error_message: 'Failed to start task due to a network error',
                    error_type: 'NetworkError'
                });
            });
    }

    // Expose this function globally so it can be called from other components
    window.startVideoGenerationTask = startVideoGenerationTask;
    </script>

    <!-- Video Preview Section -->
    <section class="container mt-5" id="videoPreviewSection">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Video Preview</h4>
                    <div class="btn-group" role="group" aria-label="Platform selector">
                        <input type="radio" class="btn-check" name="platformView" id="platformYouTube" value="youtube" checked>
                        <label class="btn btn-outline-danger" for="platformYouTube">
                            <i class="bi bi-youtube"></i> YouTube
                        </label>
                        
                        <input type="radio" class="btn-check" name="platformView" id="platformTikTok" value="tiktok">
                        <label class="btn btn-outline-dark" for="platformTikTok">
                            <i class="bi bi-tiktok"></i> TikTok
                        </label>
                        
                        <input type="radio" class="btn-check" name="platformView" id="platformInstagram" value="instagram">
                        <label class="btn btn-outline-primary" for="platformInstagram">
                            <i class="bi bi-instagram"></i> Instagram
                        </label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <!-- Video Preview Container -->
                        <div class="position-relative video-preview-container">
                            <!-- Platform specific frames -->
                            <div class="youtube-frame platform-frame active" id="youtubeFrame">
                                <div class="ratio ratio-9x16 video-container">
                                    <video id="previewVideo" controls muted>
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="platform-overlay youtube-overlay">
                                    <div class="youtube-header">
                                        <div class="d-flex align-items-center">
                                            <img src="/static/images/avatar.jpg" class="rounded-circle me-2" width="24" height="24">
                                            <span class="channel-name">Your Channel</span>
                                        </div>
                                        <button class="btn btn-sm btn-danger rounded-pill">Subscribe</button>
                                    </div>
                                    <div class="youtube-footer">
                                        <div class="video-title">Your video title here</div>
                                        <div class="d-flex mt-2">
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-hand-thumbs-up"></i> Like
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-hand-thumbs-down"></i> Dislike
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-chat-dots"></i> Comment
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0">
                                                <i class="bi bi-share"></i> Share
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tiktok-frame platform-frame" id="tiktokFrame">
                                <div class="ratio ratio-9x16 video-container">
                                    <video id="tiktokVideo" controls muted>
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="platform-overlay tiktok-overlay">
                                    <div class="tiktok-right-controls">
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-heart-fill"></i>
                                            <div>234K</div>
                                        </div>
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-chat-dots-fill"></i>
                                            <div>1.2K</div>
                                        </div>
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-bookmark-fill"></i>
                                            <div>55.6K</div>
                                        </div>
                                        <div class="tiktok-control-item">
                                            <i class="bi bi-share-fill"></i>
                                            <div>Share</div>
                                        </div>
                                    </div>
                                    <div class="tiktok-footer">
                                        <div class="d-flex align-items-center">
                                            <img src="/static/images/avatar.jpg" class="rounded-circle me-2" width="40" height="40">
                                            <span class="tiktok-username">@yourusername</span>
                                            <button class="btn btn-sm btn-danger ms-2 rounded-pill">Follow</button>
                                        </div>
                                        <div class="tiktok-caption mt-2">
                                            Your video caption here #shorts #trending #viral
                                        </div>
                                        <div class="tiktok-sound mt-1">
                                            <i class="bi bi-music-note-beamed"></i> original sound - yourusername
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="instagram-frame platform-frame" id="instagramFrame">
                                <div class="ratio ratio-9x16 video-container">
                                    <video id="instagramVideo" controls muted>
                                        <source src="" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="platform-overlay instagram-overlay">
                                    <div class="instagram-header">
                                        <div class="d-flex align-items-center">
                                            <img src="/static/images/avatar.jpg" class="rounded-circle me-2" width="30" height="30">
                                            <span class="instagram-username">yourusername</span>
                                            <i class="bi bi-dot"></i>
                                            <span class="text-primary">Follow</span>
                                        </div>
                                    </div>
                                    <div class="instagram-footer">
                                        <div class="d-flex mb-2">
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-heart"></i>
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 me-3">
                                                <i class="bi bi-chat"></i>
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0">
                                                <i class="bi bi-send"></i>
                                            </button>
                                            <button class="btn btn-sm btn-link text-light p-0 ms-auto">
                                                <i class="bi bi-bookmark"></i>
                                            </button>
                                        </div>
                                        <div class="instagram-likes">123,456 likes</div>
                                        <div class="instagram-caption">
                                            <span class="instagram-username">yourusername</span>
                                            Your video caption here #reels #trending #viral
                                        </div>
                                        <div class="instagram-comments mt-1">
                                            View all 1,234 comments
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="video-info-panel">
                            <h5 class="mb-3">Video Information</h5>
                            
                            <div class="mb-3">
                                <label for="videoTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="videoTitle" placeholder="Enter video title">
                            </div>
                            
                            <div class="mb-3">
                                <label for="videoDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="videoDescription" rows="3" placeholder="Enter video description"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="videoHashtags" class="form-label">Hashtags</label>
                                <input type="text" class="form-control" id="videoHashtags" placeholder="#shorts #trending #viral">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Publish To</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="publishYouTube" checked>
                                        <label class="form-check-label" for="publishYouTube">YouTube Shorts</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="publishTikTok">
                                        <label class="form-check-label" for="publishTikTok">TikTok</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="publishInstagram">
                                        <label class="form-check-label" for="publishInstagram">Instagram Reels</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button type="button" class="btn btn-success w-100" id="generateAIMetadataBtn">
                                    <i class="bi bi-magic"></i> Generate with AI
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button type="button" class="btn btn-primary btn-lg" id="publishVideoBtn">
                        <i class="bi bi-cloud-upload"></i> Publish Now
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-lg ms-2" id="scheduleVideoBtn">
                        <i class="bi bi-calendar-plus"></i> Schedule for Later
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Video Scheduling Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalLabel">Schedule Video Publishing</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="scheduleDatetime" class="form-label">Select Date and Time</label>
                        <input type="datetime-local" class="form-control" id="scheduleDatetime">
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useOptimalTime">
                            <label class="form-check-label" for="useOptimalTime">
                                Use AI-recommended optimal time for maximum engagement
                            </label>
                        </div>
                    </div>
                    
                    <div class="optimal-time-suggestions d-none" id="optimalTimeSuggestions">
                        <div class="alert alert-info mb-3">
                            <h6 class="alert-heading">Recommended publishing times:</h6>
                            <ul class="mb-0">
                                <li><strong>YouTube Shorts:</strong> Tuesday, 3:00 PM - 6:00 PM (your local time)</li>
                                <li><strong>TikTok:</strong> Thursday, 7:00 PM - 9:00 PM (your local time)</li>
                                <li><strong>Instagram Reels:</strong> Monday, 6:00 PM - 8:00 PM (your local time)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Publishing Platforms</label>
                        <div class="platform-schedule-list">
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scheduleYouTube" checked>
                                        <label class="form-check-label d-flex justify-content-between w-100" for="scheduleYouTube">
                                            <span><i class="bi bi-youtube text-danger"></i> YouTube Shorts</span>
                                            <small class="text-muted">Highest engagement</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scheduleTikTok">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="scheduleTikTok">
                                            <span><i class="bi bi-tiktok"></i> TikTok</span>
                                            <small class="text-muted">Trending platform</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scheduleInstagram">
                                        <label class="form-check-label d-flex justify-content-between w-100" for="scheduleInstagram">
                                            <span><i class="bi bi-instagram text-primary"></i> Instagram Reels</span>
                                            <small class="text-muted">Popular among creators</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="scheduleVideoBtn">Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Licensing functionality -->
    <script src="/static/js/licensing.js"></script>
</body>
            
            <!-- Analytics Dashboard Tab -->
            <div class="tab-pane fade" id="analytics" role="tabpanel" aria-labelledby="analytics-tab">
                <!-- Loading and Error States -->
                <div id="analytics-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading analytics data...</p>
                </div>
                
                <div id="analytics-error" class="error-container my-5" style="display: none;">
                    <div class="error-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <h4 class="mb-3">Unable to load analytics data</h4>
                    <p class="mb-4">We encountered an error while trying to fetch your analytics data. Please try again later.</p>
                    <button id="retry-analytics-btn" class="btn btn-primary">Retry</button>
                </div>
                
                <!-- Main Dashboard Content -->
                <div id="analytics-content" class="container-fluid py-4" style="display: none;">
                    <!-- Performance Overview Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card metric-card metric-primary">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-0">Total Views</p>
                                            <h3 class="metric-value mb-0" id="totalViewsValue">0</h3>
                                        </div>
                                        <div class="metric-icon">
                                            <i class="bi bi-eye fs-1 text-primary opacity-50"></i>
                                        </div>
                                    </div>
                                    <div class="metric-trend">
                                        <span class="trend-up"><i class="bi bi-arrow-up"></i> <span id="viewsTrendValue">0</span>%</span> from last month
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card metric-success">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-0">Total Likes</p>
                                            <h3 class="metric-value mb-0" id="totalLikesValue">0</h3>
                                        </div>
                                        <div class="metric-icon">
                                            <i class="bi bi-hand-thumbs-up fs-1 text-success opacity-50"></i>
                                        </div>
                                    </div>
                                    <div class="metric-trend">
                                        <span class="trend-up"><i class="bi bi-arrow-up"></i> <span id="likesTrendValue">0</span>%</span> from last month
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card metric-info">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-0">Videos Generated</p>
                                            <h3 class="metric-value mb-0" id="videosGeneratedValue">0</h3>
                                        </div>
                                        <div class="metric-icon">
                                            <i class="bi bi-film fs-1 text-info opacity-50"></i>
                                        </div>
                                    </div>
                                    <div class="metric-trend">
                                        <span class="trend-up"><i class="bi bi-arrow-up"></i> <span id="videosTrendValue">0</span>%</span> from last month
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card metric-card metric-warning">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <p class="text-muted mb-0">Engagement Rate</p>
                                            <h3 class="metric-value mb-0" id="engagementRateValue">0%</h3>
                                        </div>
                                        <div class="metric-icon">
                                            <i class="bi bi-graph-up-arrow fs-1 text-warning opacity-50"></i>
                                        </div>
                                    </div>
                                    <div class="metric-trend">
                                        <span class="trend-up"><i class="bi bi-arrow-up"></i> <span id="engagementTrendValue">0</span>%</span> from last month
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Previously Generated Videos -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Your Generated Videos</h5>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="refreshVideosBtn">
                                                <i class="bi bi-arrow-clockwise"></i> Refresh
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#filterVideosModal">
                                                <i class="bi bi-funnel"></i> Filter
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 30%">Video</th>
                                                    <th>Title</th>
                                                    <th>Platform</th>
                                                    <th>Created</th>
                                                    <th>Views</th>
                                                    <th>Likes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="generatedVideosList">
                                                <!-- Generated videos will be populated here -->
                                                <tr>
                                                    <td colspan="7" class="text-center py-4">Loading your videos...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer bg-white">
                                    <nav aria-label="Video pagination">
                                        <ul class="pagination justify-content-center mb-0">
                                            <li class="page-item disabled">
                                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                                            </li>
                                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                                            <li class="page-item">
                                                <a class="page-link" href="#">Next</a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Views by Platform</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="platformViewsChart" class="chart-container"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Top Performing Music Tracks</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Track</th>
                                                    <th>Genre</th>
                                                    <th>Videos</th>
                                                    <th>Total Views</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topTracksTable">
                                                <!-- Top tracks will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Affiliate Stats -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Affiliate Performance</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body text-center">
                                                    <h6 class="text-muted">Total Referrals</h6>
                                                    <h2 class="display-5 fw-bold text-primary" id="dashboardReferralsValue">0</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body text-center">
                                                    <h6 class="text-muted">Total Earnings</h6>
                                                    <h2 class="display-5 fw-bold text-success" id="dashboardEarningsValue">$0.00</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body text-center">
                                                    <h6 class="text-muted">Conversion Rate</h6>
                                                    <h2 class="display-5 fw-bold text-info" id="dashboardConversionRateValue">0%</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <a href="/affiliate-dashboard" class="btn btn-outline-primary">View Full Affiliate Dashboard</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Platform Distribution Tab -->
            <div class="tab-pane fade" id="platforms" role="tabpanel" aria-labelledby="platforms-tab">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Platform Distribution</h5>
                                <canvas id="platformDistributionChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Success Rate by Platform</h5>
                                <canvas id="platformSuccessChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Recent Platform Distributions</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover" id="platformDistributionsTable">
                                        <thead>
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>Platform</th>
                                                <th>Status</th>
                                                <th>Processing Time</th>
                                                <th>File Size</th>
                                                <th>Resolution</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Dynamically populated -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trends & Insights Tab -->
            <div class="tab-pane fade" id="trends" role="tabpanel" aria-labelledby="trends-tab">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Trending Presets</h5>
                                <canvas id="trendingPresetsChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Trending Effects</h5>
                                <canvas id="trendingEffectsChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Content Recommendations</h5>
                                <div id="recommendationsContainer" class="row">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Prediction Tab -->
            <div class="tab-pane fade" id="predictions" role="tabpanel" aria-labelledby="predictions-tab">
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Predict Performance</h5>
                                <p class="card-text">Estimate how well your video will perform before publishing it.</p>
                                
                                <form id="predictionForm" class="mt-4">
                                    <div class="mb-3">
                                        <label for="predictionDuration" class="form-label">Video Duration (seconds)</label>
                                        <input type="range" class="form-range" min="15" max="300" step="15" id="predictionDuration" value="60">
                                        <div class="d-flex justify-content-between">
                                            <span>15s</span>
                                            <span id="durationValue">60s</span>
                                            <span>300s</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="predictionPreset" class="form-label">Style Preset</label>
                                        <select class="form-select" id="predictionPreset">
                                            <option value="standard">Standard</option>
                                            <option value="subtle">Subtle</option>
                                            <option value="energetic">Energetic</option>
                                            <option value="dramatic">Dramatic</option>
                                            <option value="cinematic">Cinematic</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Effects (select all that apply)</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="pulse" id="effectPulse">
                                                    <label class="form-check-label" for="effectPulse">Pulse</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="zoom" id="effectZoom">
                                                    <label class="form-check-label" for="effectZoom">Zoom</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="shake" id="effectShake">
                                                    <label class="form-check-label" for="effectShake">Shake</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="flash" id="effectFlash">
                                                    <label class="form-check-label" for="effectFlash">Flash</label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="color_shift" id="effectColorShift">
                                                    <label class="form-check-label" for="effectColorShift">Color Shift</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="blur" id="effectBlur">
                                                    <label class="form-check-label" for="effectBlur">Blur</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="warp" id="effectWarp">
                                                    <label class="form-check-label" for="effectWarp">Warp</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input prediction-effect" type="checkbox" value="glitch" id="effectGlitch">
                                                    <label class="form-check-label" for="effectGlitch">Glitch</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="predictionTempo" class="form-label">Music Tempo (BPM): <span id="tempoValue">120</span></label>
                                        <input type="range" class="form-range" min="60" max="180" step="5" id="predictionTempo" value="120">
                                        <div class="d-flex justify-content-between">
                                            <span>Slow (60)</span>
                                            <span>Medium (120)</span>
                                            <span>Fast (180)</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label for="predictionEnergy" class="form-label">Music Energy Level: <span id="energyValue">Medium</span></label>
                                        <input type="range" class="form-range" min="1" max="10" step="1" id="predictionEnergy" value="5">
                                        <div class="d-flex justify-content-between">
                                            <span>Calm</span>
                                            <span>Medium</span>
                                            <span>Intense</span>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">Predict Performance</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Prediction Results</h5>
                                
                                <div id="noPrediction" class="text-center py-5">
                                    <i class="bi bi-graph-up-arrow" style="font-size: 3rem; color: #6c757d;"></i>
                                    <p class="mt-3">Fill out the form and click "Predict Performance" to see engagement predictions.</p>
                                </div>
                                
                                <div id="predictionResults" class="d-none">
                                    <div class="text-center mb-4">
                                        <h2 class="display-4" id="engagementScore">0.0</h2>
                                        <p class="lead" id="performanceCategory">Calculating...</p>
                                        <div class="progress mt-3" style="height: 20px;">
                                            <div id="engagementBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="10"></div>
                                        </div>
                                        <p class="text-muted mt-2">
                                            Prediction confidence: <span id="predictionConfidence">0%</span>
                                        </p>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6 class="card-subtitle mb-3">Recommendations to Improve Performance</h6>
                                        <ul id="recommendationsList" class="list-group">
                                            <li class="list-group-item">Loading recommendations...</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                                            <button id="applyRecommendationsBtn" class="btn btn-outline-primary">Apply Recommendations</button>
                                            <button id="generateWithCurrentSettingsBtn" class="btn btn-primary">Generate with Current Settings</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">A/B Testing</h5>
                                <p class="card-text">Create multiple variants of your video with different settings to test performance.</p>
                                
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Create Variants</h6>
                                        <form id="abTestForm">
                                            <div class="mb-3">
                                                <label class="form-label">Parameters to Test</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="preset" id="testPreset" checked>
                                                    <label class="form-check-label" for="testPreset">Style Preset</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="effects" id="testEffects" checked>
                                                    <label class="form-check-label" for="testEffects">Effects</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="intensity" id="testIntensity">
                                                    <label class="form-check-label" for="testIntensity">Effect Intensity</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="transitions" id="testTransitions">
                                                    <label class="form-check-label" for="testTransitions">Transition Style</label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="variantCount" class="form-label">Number of Variants</label>
                                                <select class="form-select" id="variantCount">
                                                    <option value="2">2 variants</option>
                                                    <option value="3">3 variants</option>
                                                    <option value="4">4 variants</option>
                                                </select>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary">Generate Variants</button>
                                        </form>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Test Results</h6>
                                        <div id="noABTest" class="text-center py-5">
                                            <i class="bi bi-bar-chart" style="font-size: 3rem; color: #6c757d;"></i>
                                            <p class="mt-3">Generate variants to see performance comparison.</p>
                                        </div>
                                        
                                        <div id="abTestResults" class="d-none">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Variant</th>
                                                            <th>Changes</th>
                                                            <th>Score</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="variantsTableBody">
                                                        <!-- Dynamically populated -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Licensing Tab -->
            <div class="tab-pane fade" id="licensing" role="tabpanel" aria-labelledby="licensing-tab">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- License Information Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">License Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info" id="licenseStatusAlert">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span id="licenseStatusMessage">Your Professional license is active until December 31, 2023</span>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">License Type</label>
                                            <p id="licenseType">Professional</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Expiration Date</label>
                                            <p id="licenseExpiration">December 31, 2023</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">License Key</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="licenseKey" value="XXXX-XXXX-XXXX-XXXX" readonly>
                                                <button class="btn btn-outline-secondary" type="button" id="viewLicenseKeyBtn">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Registered To</label>
                                            <p id="licenseOwner">John Doe (john.doe@example.com)</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Active Devices</label>
                                            <p id="activeDevices">2 of 3 allowed</p>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Project Exports</label>
                                            <p id="projectExports">Unlimited</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button class="btn btn-primary me-2" id="renewLicenseBtn">
                                        <i class="bi bi-arrow-repeat me-1"></i> Renew License
                                    </button>
                                    <button class="btn btn-outline-primary me-2" id="upgradeLicenseBtn">
                                        <i class="bi bi-arrow-up-circle me-1"></i> Upgrade License
                                    </button>
                                    <button class="btn btn-outline-secondary" id="transferLicenseBtn">
                                        <i class="bi bi-person-plus me-1"></i> Transfer License
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Music Rights Management Card (NEW) -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Music Rights Management</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning mb-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <span>Proper music licensing is essential for monetization on platforms like YouTube and TikTok.</span>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Track</th>
                                                <th>License Type</th>
                                                <th>Platforms</th>
                                                <th>Manage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="musicRightsTableBody">
                                            <tr>
                                                <td>Summer Vibes</td>
                                                <td><span class="badge bg-success">Commercial</span></td>
                                                <td>All Platforms</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" data-track="Summer Vibes">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Urban Beats</td>
                                                <td><span class="badge bg-warning text-dark">Attribution</span></td>
                                                <td>YouTube, TikTok</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" data-track="Urban Beats">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Cinematic Orchestra</td>
                                                <td><span class="badge bg-danger">Personal</span></td>
                                                <td>Non-Commercial Only</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" data-track="Cinematic Orchestra">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-3">
                                    <button class="btn btn-primary" id="importMusicRightsBtn">
                                        <i class="bi bi-cloud-arrow-up me-1"></i> Import Rights Metadata
                                    </button>
                                    <button class="btn btn-outline-primary" id="exportMusicRightsBtn">
                                        <i class="bi bi-cloud-arrow-down me-1"></i> Export Rights Database
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- License Features Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">License Features</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Feature</th>
                                                <th>Status</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Video Exports</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Unlimited exports in up to 4K resolution</td>
                                            </tr>
                                            <tr>
                                                <td>Advanced Effects</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Access to all premium effects and transitions</td>
                                            </tr>
                                            <tr>
                                                <td>Commercial Usage</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Licensed for commercial projects</td>
                                            </tr>
                                            <tr>
                                                <td>Batch Processing</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Process up to 10 videos simultaneously</td>
                                            </tr>
                                            <tr>
                                                <td>Extended Analysis</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Access to advanced analytics and insights</td>
                                            </tr>
                                            <tr>
                                                <td>API Access</td>
                                                <td><span class="badge bg-warning">Limited</span></td>
                                                <td>500 API calls per day (upgrade for more)</td>
                                            </tr>
                                            <!-- New feature for music rights -->
                                            <tr>
                                                <td>Sync Licensing</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Generate and export metadata for all tracks</td>
                                            </tr>
                                            <!-- New feature for watermarking -->
                                            <tr>
                                                <td>Watermark Removal</td>
                                                <td><span class="badge bg-success">Enabled</span></td>
                                                <td>Remove Nova Sounds branding from exports</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- License History Card -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">License History</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Action</th>
                                                <th>Details</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Jan 15, 2023</td>
                                                <td>License Purchased</td>
                                                <td>Professional Plan - 1 Year</td>
                                            </tr>
                                            <tr>
                                                <td>Jan 16, 2023</td>
                                                <td>Device Activated</td>
                                                <td>MacBook Pro (John's Laptop)</td>
                                            </tr>
                                            <tr>
                                                <td>Mar 20, 2023</td>
                                                <td>Device Activated</td>
                                                <td>Mac Studio (Office)</td>
                                            </tr>
                                            <tr>
                                                <td>Apr 10, 2023</td>
                                                <td>License Feature Added</td>
                                                <td>Added Batch Processing capability</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Affiliate Program Card (NEW) -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Affiliate Program <span class="badge bg-light text-success ms-2">NEW</span></h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6>Your Affiliate Stats</h6>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="fs-4 fw-bold text-success">0</div>
                                            <div class="small text-muted">Referrals</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-4 fw-bold text-success">$0</div>
                                            <div class="small text-muted">Earned</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fs-4 fw-bold text-success">20%</div>
                                            <div class="small text-muted">Commission</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-success py-2">
                                    <small><i class="bi bi-info-circle me-1"></i> Earn 20% commission on every referral who subscribes!</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Your Referral Link</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" value="https://novasounds.ai/?ref=johndoe" readonly id="referralLink">
                                        <button class="btn btn-outline-secondary" type="button" id="copyReferralBtn">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Share this link to earn commissions</small>
                                </div>
                                
                                <div class="d-grid mt-3">
                                    <button class="btn btn-success" id="affiliateDashboardBtn">
                                        <i class="bi bi-graph-up me-1"></i> Affiliate Dashboard
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- License Tag Manager Card (NEW) -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">License Tag Manager</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text small mb-3">Define custom license tags for your music tracks to streamline rights management.</p>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autoTagToggle" checked>
                                        <label class="form-check-label" for="autoTagToggle">
                                            Auto-tag tracks on import
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="list-group mb-3">
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        Commercial Use
                                        <span class="badge bg-success rounded-pill">15</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        Attribution Required
                                        <span class="badge bg-warning text-dark rounded-pill">8</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        Personal Use Only
                                        <span class="badge bg-danger rounded-pill">3</span>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                        YouTube Monetizable
                                        <span class="badge bg-primary rounded-pill">12</span>
                                    </a>
                                </div>
                                
                                <button class="btn btn-outline-primary w-100" id="manageLicenseTagsBtn">
                                    <i class="bi bi-tags me-1"></i> Manage Custom Tags
                                </button>
                            </div>
                        </div>
                        
                        <!-- Compare Plans Card -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Compare Plans</h5>
                            </div>
                            <div class="card-body">
                                <div class="list-group">
                                    <a href="#" class="list-group-item list-group-item-action" aria-current="true">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">Basic</h5>
                                            <span class="badge bg-secondary">$99/year</span>
                                        </div>
                                        <p class="mb-1">Essential features for personal use</p>
                                        <small>720p exports, basic effects, 1 device</small>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action active">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">Professional</h5>
                                            <span class="badge bg-light text-dark">$199/year</span>
                                        </div>
                                        <p class="mb-1">Full features for professional creators</p>
                                        <small class="text-white">4K exports, all effects, 3 devices, commercial use</small>
                                    </a>
                                    <a href="#" class="list-group-item list-group-item-action">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">Enterprise</h5>
                                            <span class="badge bg-primary">$499/year</span>
                                        </div>
                                        <p class="mb-1">Advanced features for teams</p>
                                        <small>Unlimited everything, 10 devices, priority support</small>
                                    </a>
                                </div>
                                
                                <div class="d-grid mt-3">
                                    <button class="btn btn-success" id="viewAllPlansBtn">View All Plans</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Content Calendar Tab -->
            <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                <div class="container-fluid py-4">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-1">Content Calendar</h3>
                                    <p class="text-muted">Schedule and manage your video publishing for maximum engagement</p>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#batchScheduleModal">
                                        <i class="bi bi-calendar-plus"></i> Batch Schedule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Calendar View (Left Side) -->
                        <div class="col-lg-8">
                            <div class="card mb-4">
                                <div class="card-header bg-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="bi bi-calendar-event text-primary me-2"></i>Publishing Calendar</h5>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" id="calendarViewMonthBtn">Month</button>
                                            <button class="btn btn-sm btn-outline-primary" id="calendarViewWeekBtn">Week</button>
                                            <button class="btn btn-sm btn-outline-primary" id="calendarViewListBtn">List</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="schedulingCalendar" class="scheduling-calendar-container"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sidebar (Right Side) -->
                        <div class="col-lg-4">
                            <!-- Time Selector Card -->
                            <div class="card mb-4">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0"><i class="bi bi-clock text-primary me-2"></i>Scheduling Details</h5>
                                </div>
                                <div class="card-body">
                                    <div class="selected-date-info mb-3">
                                        <label class="form-label fw-bold">Selected Date</label>
                                        <div id="schedule-selected-date" class="selected-date-display p-2 border rounded">
                                            <span class="text-muted">Select a date from the calendar</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Time Slots</label>
                                        <div id="schedule-time-slots" class="time-slots-grid">
                                            <div class="text-muted small p-2">Please select a date first</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Platform Selection</label>
                                        <div class="platform-selection">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="platform-youtube" checked>
                                                <label class="form-check-label" for="platform-youtube">
                                                    <i class="bi bi-youtube text-danger"></i> YouTube
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="platform-tiktok">
                                                <label class="form-check-label" for="platform-tiktok">
                                                    <i class="bi bi-tiktok"></i> TikTok
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="platform-instagram">
                                                <label class="form-check-label" for="platform-instagram">
                                                    <i class="bi bi-instagram text-purple"></i> Instagram
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="optimal-time-switch">
                                            <label class="form-check-label" for="optimal-time-switch">
                                                Use AI-recommended optimal time
                                            </label>
                                        </div>
                                        <div class="form-text text-muted small">
                                            Our AI analyzes your audience activity patterns to find the best publishing times.
                                        </div>
                                    </div>
                                    
                                    <div id="optimal-time-recommendations" class="mb-3 p-2 border rounded bg-light" style="display: none;">
                                        <h6 class="mb-2">Recommended Times:</h6>
                                        <ul class="list-unstyled mb-0">
                                            <li><i class="bi bi-youtube text-danger me-1"></i> YouTube: <strong>5:30 PM</strong> (91% audience activity)</li>
                                            <li><i class="bi bi-tiktok me-1"></i> TikTok: <strong>7:15 PM</strong> (87% audience activity)</li>
                                            <li><i class="bi bi-instagram text-purple me-1"></i> Instagram: <strong>8:00 PM</strong> (83% audience activity)</li>
                                        </ul>
                                    </div>
                                    
                                    <button id="schedule-save-btn" class="btn btn-primary w-100" disabled>
                                        <i class="bi bi-calendar-check"></i> Schedule Publishing
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Upcoming Publications Card -->
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0"><i class="bi bi-list-check text-primary me-2"></i>Upcoming Publications</h5>
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush" id="upcoming-publications-list">
                                        <li class="list-group-item text-center py-4">
                                            <i class="bi bi-calendar-x display-6 text-muted"></i>
                                            <p class="mt-2 text-muted">No scheduled publications</p>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // ... existing code ...
    </script>
    
    <!-- Licensing functionality -->
    <script src="/static/js/licensing.js"></script>

    <!-- Music Browser Section -->
    <section class="container mt-5" id="musicBrowser">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Music Browser</h4>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#musicFilters">
                            <i class="bi bi-funnel"></i> Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Music Filters -->
            <div class="collapse" id="musicFilters">
                <div class="card-body border-bottom">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="genreFilter" class="form-label">Genre</label>
                            <select class="form-select" id="genreFilter" multiple>
                                <option value="electronic">Electronic</option>
                                <option value="pop">Pop</option>
                                <option value="hip_hop">Hip Hop</option>
                                <option value="rock">Rock</option>
                                <option value="rnb">R&B</option>
                                <option value="jazz">Jazz</option>
                                <option value="classical">Classical</option>
                                <option value="ambient">Ambient</option>
                                <option value="lo_fi">Lo-Fi</option>
                                <option value="edm">EDM</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="moodFilter" class="form-label">Mood</label>
                            <select class="form-select" id="moodFilter" multiple>
                                <option value="happy">Happy</option>
                                <option value="energetic">Energetic</option>
                                <option value="calm">Calm</option>
                                <option value="melancholic">Melancholic</option>
                                <option value="dark">Dark</option>
                                <option value="uplifting">Uplifting</option>
                                <option value="dramatic">Dramatic</option>
                                <option value="chill">Chill</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="bpmRange" class="form-label">BPM Range</label>
                            <div class="d-flex gap-2">
                                <input type="number" class="form-control" id="bpmMin" placeholder="Min" min="60" max="200">
                                <input type="number" class="form-control" id="bpmMax" placeholder="Max" min="60" max="200">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="licenseFilter" class="form-label">License Type</label>
                            <select class="form-select" id="licenseFilter">
                                <option value="">All Licenses</option>
                                <option value="standard">Standard</option>
                                <option value="premium">Premium</option>
                                <option value="commercial">Commercial</option>
                                <option value="exclusive">Exclusive</option>
                                <option value="creative_commons">Creative Commons</option>
                                <option value="royalty_free">Royalty Free</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                        <button class="btn btn-outline-secondary" id="resetFilters">Reset</button>
                    </div>
                </div>
            </div>
            
            <!-- Music Tracks List with Waveform -->
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="musicTracksList">
                    <!-- Music tracks will be populated here via JavaScript -->
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading music tracks...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Music Track Item Template -->
    <template id="musicTrackTemplate">
        <div class="list-group-item music-track p-3">
            <div class="row align-items-center">
                <div class="col-auto">
                    <button class="btn btn-play btn-sm rounded-circle" data-action="play">
                        <i class="bi bi-play-fill"></i>
                    </button>
                </div>
                <div class="col">
                    <h6 class="mb-0 track-title">Track Title</h6>
                    <small class="text-muted track-artist">Artist Name</small>
                </div>
                <div class="col-md-4">
                    <div class="waveform-container" style="height: 60px;">
                        <!-- Waveform visualization will be inserted here -->
                    </div>
                </div>
                <div class="col-auto d-none d-md-block">
                    <span class="badge bg-primary me-1">Genre</span>
                    <span class="badge bg-secondary me-1">Mood</span>
                    <span class="small text-muted me-2"><i class="bi bi-music-note"></i> <span class="track-bpm">120</span> BPM</span>
                    <span class="small text-muted"><i class="bi bi-clock"></i> <span class="track-duration">0:30</span></span>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-primary" data-action="select">Select</button>
                </div>
            </div>
            <div class="mt-2 license-info small d-none">
                <div class="alert alert-info py-2">
                    <div class="row">
                        <div class="col-md-6">
                            <div><strong>License:</strong> <span class="license-type">Standard</span></div>
                            <div><strong>Attribution:</strong> <span class="attribution-required">Yes</span></div>
                        </div>
                        <div class="col-md-6">
                            <div><strong>Restrictions:</strong> <span class="license-restrictions">None</span></div>
                            <div><strong>Expires:</strong> <span class="license-expiration">Never</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Add JavaScript for the music browser -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize music browser functionality
        initMusicBrowser();
        
        // Initialize analytics dashboard
        initAnalyticsDashboard();
    });

    function initMusicBrowser() {
        // Track loading and filtering functionality will be implemented here
        const applyFilters = document.getElementById('applyFilters');
        const resetFilters = document.getElementById('resetFilters');
        
        applyFilters.addEventListener('click', function() {
            loadMusicTracks();
        });
        
        resetFilters.addEventListener('click', function() {
            document.getElementById('genreFilter').selectedIndex = -1;
            document.getElementById('moodFilter').selectedIndex = -1;
            document.getElementById('bpmMin').value = '';
            document.getElementById('bpmMax').value = '';
            document.getElementById('licenseFilter').selectedIndex = 0;
        });
        
        // Initial load of music tracks
        loadMusicTracks();
    }

    function loadMusicTracks() {
        const tracksList = document.getElementById('musicTracksList');
        const template = document.getElementById('musicTrackTemplate');
        
        // Show loading state
        tracksList.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading music tracks...</p>
            </div>
        `;
        
        // Get filter values
        const genres = Array.from(document.getElementById('genreFilter').selectedOptions).map(o => o.value);
        const moods = Array.from(document.getElementById('moodFilter').selectedOptions).map(o => o.value);
        const bpmMin = document.getElementById('bpmMin').value;
        const bpmMax = document.getElementById('bpmMax').value;
        const licenseType = document.getElementById('licenseFilter').value;
        
        // Build query parameters
        const params = new URLSearchParams();
        if (genres.length) params.append('genres', genres.join(','));
        if (moods.length) params.append('moods', moods.join(','));
        if (bpmMin) params.append('bpm_min', bpmMin);
        if (bpmMax) params.append('bpm_max', bpmMax);
        if (licenseType) params.append('license_type', licenseType);
        
        // Fetch music tracks with filters
        fetch(`/api/music/tracks?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                tracksList.innerHTML = '';
                
                if (data.length === 0) {
                    tracksList.innerHTML = `
                        <div class="text-center p-5">
                            <i class="bi bi-music-note-list fs-1 text-muted"></i>
                            <p class="mt-2">No music tracks found matching your filters.</p>
                        </div>
                    `;
                    return;
                }
                
                data.forEach(track => {
                    const trackElement = template.content.cloneNode(true);
                    
                    // Set track data
                    trackElement.querySelector('.track-title').textContent = track.title;
                    trackElement.querySelector('.track-artist').textContent = track.artist;
                    trackElement.querySelector('.track-bpm').textContent = track.bpm || 'N/A';
                    
                    // Format duration (seconds to MM:SS)
                    const minutes = Math.floor(track.duration / 60);
                    const seconds = track.duration % 60;
                    trackElement.querySelector('.track-duration').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Set license information
                    trackElement.querySelector('.license-type').textContent = track.license_type;
                    trackElement.querySelector('.attribution-required').textContent = 
                        track.attribution_required ? 'Required' : 'Not Required';
                    
                    // Add restrictions if any
                    if (track.license_restrictions && track.license_restrictions.length > 0) {
                        trackElement.querySelector('.license-restrictions').textContent = 
                            track.license_restrictions.join(', ');
                    }
                    
                    // Add expiration if any
                    if (track.license_expiration) {
                        trackElement.querySelector('.license-expiration').textContent = 
                            new Date(track.license_expiration).toLocaleDateString();
                    }
                    
                    // Create badges for genres and moods
                    const badgesContainer = trackElement.querySelector('.col-auto.d-none.d-md-block');
                    badgesContainer.innerHTML = '';
                    
                    if (track.genres && track.genres.length > 0) {
                        track.genres.slice(0, 2).forEach(genre => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-primary me-1';
                            badge.textContent = genre;
                            badgesContainer.appendChild(badge);
                        });
                    }
                    
                    if (track.moods && track.moods.length > 0) {
                        track.moods.slice(0, 2).forEach(mood => {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary me-1';
                            badge.textContent = mood;
                            badgesContainer.appendChild(badge);
                        });
                    }
                    
                    // Add BPM and duration
                    const bpmSpan = document.createElement('span');
                    bpmSpan.className = 'small text-muted me-2';
                    bpmSpan.innerHTML = `<i class="bi bi-music-note"></i> <span class="track-bpm">${track.bpm || 'N/A'}</span> BPM`;
                    badgesContainer.appendChild(bpmSpan);
                    
                    const durationSpan = document.createElement('span');
                    durationSpan.className = 'small text-muted';
                    durationSpan.innerHTML = `<i class="bi bi-clock"></i> <span class="track-duration">${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
                    badgesContainer.appendChild(durationSpan);
                    
                    // Set up waveform visualization
                    const waveformContainer = trackElement.querySelector('.waveform-container');
                    if (track.waveform_data) {
                        renderWaveform(waveformContainer, track.waveform_data);
                    } else {
                        waveformContainer.innerHTML = '<div class="text-center text-muted pt-3">Waveform not available</div>';
                    }
                    
                    // Setup play/pause functionality
                    const playButton = trackElement.querySelector('[data-action="play"]');
                    playButton.addEventListener('click', function() {
                        togglePlayTrack(track.id, playButton);
                    });
                    
                    // Setup select functionality
                    const selectButton = trackElement.querySelector('[data-action="select"]');
                    selectButton.addEventListener('click', function() {
                        selectMusicTrack(track);
                    });
                    
                    // Setup license info toggle
                    const trackRow = trackElement.querySelector('.row.align-items-center');
                    trackRow.addEventListener('click', function(e) {
                        if (!e.target.closest('[data-action]')) {
                            const licenseInfo = trackElement.querySelector('.license-info');
                            licenseInfo.classList.toggle('d-none');
                        }
                    });
                    
                    // Add track element to the list
                    tracksList.appendChild(trackElement);
                });
            })
            .catch(error => {
                console.error('Error loading music tracks:', error);
                tracksList.innerHTML = `
                    <div class="text-center p-5">
                        <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
                        <p class="mt-2">Failed to load music tracks. Please try again later.</p>
                    </div>
                `;
            });
    }

    function renderWaveform(container, waveformData) {
        // Simple waveform visualization rendering
        const canvas = document.createElement('canvas');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        container.appendChild(canvas);
        
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#0d6efd';
        
        // Draw simplified waveform if we have data
        if (waveformData && waveformData.data && waveformData.data.length > 0) {
            const data = waveformData.data;
            const width = canvas.width;
            const height = canvas.height;
            const barWidth = width / data.length;
            
            ctx.clearRect(0, 0, width, height);
            
            for (let i = 0; i < data.length; i++) {
                const amplitude = data[i] * height * 0.8;
                const x = i * barWidth;
                const y = (height - amplitude) / 2;
                
                ctx.fillRect(x, y, barWidth * 0.8, amplitude);
            }
        } else {
            // Draw a placeholder waveform
            const width = canvas.width;
            const height = canvas.height;
            const barCount = 50;
            const barWidth = width / barCount;
            
            ctx.clearRect(0, 0, width, height);
            
            for (let i = 0; i < barCount; i++) {
                const amplitude = Math.random() * height * 0.6 + height * 0.2;
                const x = i * barWidth;
                const y = (height - amplitude) / 2;
                
                ctx.fillRect(x, y, barWidth * 0.8, amplitude);
            }
        }
    }

    function togglePlayTrack(trackId, buttonElement) {
        const isPlaying = buttonElement.querySelector('i').classList.contains('bi-pause-fill');
        
        // Reset all play buttons first
        document.querySelectorAll('.btn-play i').forEach(icon => {
            icon.classList.remove('bi-pause-fill');
            icon.classList.add('bi-play-fill');
        });
        
        if (!isPlaying) {
            // Play this track
            buttonElement.querySelector('i').classList.remove('bi-play-fill');
            buttonElement.querySelector('i').classList.add('bi-pause-fill');
            
            // Fetch and play the audio file
            fetch(`/api/music/preview/${trackId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.preview_url) {
                        const audio = new Audio(data.preview_url);
                        window.currentAudio = audio;
                        audio.play();
                        
                        audio.onended = function() {
                            buttonElement.querySelector('i').classList.remove('bi-pause-fill');
                            buttonElement.querySelector('i').classList.add('bi-play-fill');
                        };
                    }
                });
        } else {
            // Stop playing
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }
        }
    }

    function selectMusicTrack(track) {
        // Highlight the selected track
        document.querySelectorAll('.music-track').forEach(el => {
            el.classList.remove('bg-light');
        });
        
        const trackElement = event.target.closest('.music-track');
        if (trackElement) {
            trackElement.classList.add('bg-light');
        }
        
        // Store selected track data and update UI
        window.selectedMusicTrack = track;
        document.dispatchEvent(new CustomEvent('musicTrackSelected', { detail: track }));
        
        // Show confirmation toast
        const toast = new bootstrap.Toast(document.getElementById('selectionToast'));
        document.getElementById('selectionToastBody').textContent = `Selected "${track.title}" by ${track.artist}`;
        toast.show();
    }
</script>

<!-- Toast for selection confirmation -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="selectionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-music-note-beamed me-2 text-primary"></i>
            <strong class="me-auto">Track Selected</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="selectionToastBody">
            Music track selected successfully.
        </div>
    </div>
</div>

<!-- Style Preset Selector Section -->
<section class="container mt-5" id="stylePresetSelector">
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h4 class="mb-0">Video Style Presets</h4>
        </div>
        <div class="card-body">
            <div class="row row-cols-1 row-cols-md-3 g-4" id="stylePresetsContainer">
                <!-- Vlog Style -->
                <div class="col">
                    <div class="card h-100 preset-card" data-preset="vlog">
                        <img src="/static/images/presets/vlog-preset.jpg" class="card-img-top" alt="Vlog Style">
                        <div class="card-body">
                            <h5 class="card-title">Vlog Style</h5>
                            <p class="card-text">Clean transitions with simple text overlays. Perfect for storytelling and personal content.</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                </div>
                                <small class="text-muted">Popular on YouTube</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hype Style -->
                <div class="col">
                    <div class="card h-100 preset-card" data-preset="hype">
                        <img src="/static/images/presets/hype-preset.jpg" class="card-img-top" alt="Hype Style">
                        <div class="card-body">
                            <h5 class="card-title">Hype Style</h5>
                            <p class="card-text">Fast-paced cuts with zoom effects and bold text. Great for energetic music and action content.</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                </div>
                                <small class="text-muted">Trending on TikTok</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chill Style -->
                <div class="col">
                    <div class="card h-100 preset-card" data-preset="chill">
                        <img src="/static/images/presets/chill-preset.jpg" class="card-img-top" alt="Chill Style">
                        <div class="card-body">
                            <h5 class="card-title">Chill Style</h5>
                            <p class="card-text">Smooth slow transitions with minimal text. Ideal for relaxing music and aesthetic content.</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                </div>
                                <small class="text-muted">Popular on Instagram</small>
                            </div>
                        </div>
                    </div>
                </div>
                    
                    <!-- Cinematic Style -->
                    <div class="col">
                        <div class="card h-100 preset-card" data-preset="cinematic">
                            <img src="/static/images/presets/cinematic-preset.jpg" class="card-img-top" alt="Cinematic Style">
                            <div class="card-body">
                                <h5 class="card-title">Cinematic Style</h5>
                                <p class="card-text">Film-like color grading with letterbox format. Perfect for dramatic and emotional content.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                    </div>
                                    <small class="text-muted">Professional look</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Minimal Style -->
                    <div class="col">
                        <div class="card h-100 preset-card" data-preset="minimal">
                            <img src="/static/images/presets/minimal-preset.jpg" class="card-img-top" alt="Minimal Style">
                            <div class="card-body">
                                <h5 class="card-title">Minimal Style</h5>
                                <p class="card-text">Clean, minimalist design with subtle animations. Great for tutorials and informational content.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                    </div>
                                    <small class="text-muted">Easy to customize</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Retro Style -->
                    <div class="col">
                        <div class="card h-100 preset-card" data-preset="retro">
                            <img src="/static/images/presets/retro-preset.jpg" class="card-img-top" alt="Retro Style">
                            <div class="card-body">
                                <h5 class="card-title">Retro Style</h5>
                                <p class="card-text">Vintage filters with VHS effects and classic fonts. Perfect for nostalgic and throwback content.</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary select-preset-btn">Select</button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary preview-preset-btn">Preview</button>
                                    </div>
                                    <small class="text-muted">Nostalgic appeal</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Style Preview Modal -->
    <div class="modal fade" id="stylePreviewModal" tabindex="-1" aria-labelledby="stylePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stylePreviewModalLabel">Style Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="ratio ratio-16x9">
                        <video id="stylePreviewVideo" controls>
                            <source src="" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="selectFromPreviewBtn">Select This Style</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script for Style Preset Selection -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initStylePresetSelector();
    });

    function initStylePresetSelector() {
        const presetCards = document.querySelectorAll('.preset-card');
        const previewModal = new bootstrap.Modal(document.getElementById('stylePreviewModal'));
        const previewVideo = document.getElementById('stylePreviewVideo');
        const selectFromPreviewBtn = document.getElementById('selectFromPreviewBtn');
        
        // Preview videos for each preset
        const previewUrls = {
            'vlog': '/static/videos/previews/vlog-preview.mp4',
            'hype': '/static/videos/previews/hype-preview.mp4',
            'chill': '/static/videos/previews/chill-preview.mp4',
            'cinematic': '/static/videos/previews/cinematic-preview.mp4',
            'minimal': '/static/videos/previews/minimal-preview.mp4',
            'retro': '/static/videos/previews/retro-preview.mp4'
        };
        
        // Handle select preset button clicks
        document.querySelectorAll('.select-preset-btn').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.preset-card');
                selectPreset(card);
            });
        });
        
        // Handle preview button clicks
        document.querySelectorAll('.preview-preset-btn').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.preset-card');
                const preset = card.dataset.preset;
                
                // Set the title in the modal
                document.getElementById('stylePreviewModalLabel').textContent = 
                    `${card.querySelector('.card-title').textContent} Preview`;
                
                // Set the video source and load it
                if (previewUrls[preset]) {
                    previewVideo.src = previewUrls[preset];
                    previewVideo.load();
                    
                    // Store the preset in the select button
                    selectFromPreviewBtn.dataset.preset = preset;
                    
                    // Show the modal
                    previewModal.show();
                } else {
                    alert('Preview not available for this style.');
                }
            });
        });
        
        // Handle selecting from preview
        selectFromPreviewBtn.addEventListener('click', function() {
            const preset = this.dataset.preset;
            const card = document.querySelector(`.preset-card[data-preset="${preset}"]`);
            
            // Close the modal
            previewModal.hide();
            
            // Select the preset
            selectPreset(card);
        });
        
        // Handle modal close (stop video)
        document.getElementById('stylePreviewModal').addEventListener('hidden.bs.modal', function() {
            previewVideo.pause();
        });
        
        // Function to select a preset
        function selectPreset(card) {
            // Remove selected class from all cards
            presetCards.forEach(c => c.classList.remove('selected'));
            
            // Add selected class to the clicked card
            card.classList.add('selected');
            
            // Store the selected preset
            const preset = card.dataset.preset;
            window.selectedStylePreset = preset;
            
            // Dispatch event for other components
            document.dispatchEvent(new CustomEvent('stylePresetSelected', { 
                detail: { 
                    preset: preset,
                    name: card.querySelector('.card-title').textContent
                } 
            }));
            
            // Show toast notification
            const toast = new bootstrap.Toast(document.getElementById('styleToast'));
            document.getElementById('styleToastBody').textContent = 
                `Selected "${card.querySelector('.card-title').textContent}" style`;
            toast.show();
        }
    }
    </script>

    <!-- Toast for style selection confirmation -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="styleToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-palette me-2 text-primary"></i>
                <strong class="me-auto">Style Selected</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="styleToastBody">
                Video style selected successfully.
            </div>
        </div>
    </div>

    <!-- Celery Progress Section -->
    <section class="container mt-5 d-none" id="celeryProgressSection">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Video Generation Progress</h4>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="showLogBtn">
                            <i class="bi bi-terminal"></i> Show Log
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="progressContainer">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fs-6 fw-bold" id="taskStatusText">Initializing...</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" 
                                 role="progressbar" 
                                 style="width: 0%"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <div>
                            <small class="text-muted">Task ID: <span id="taskIdText">Not started</span></small>
                        </div>
                        <div>
                            <small class="text-muted">Elapsed time: <span id="elapsedTimeText">00:00</span></small>
                        </div>
                    </div>
                    
                    <!-- Sub-tasks progress -->
                    <div class="mt-4" id="subTasksContainer">
                        <h6 class="fw-bold">Processing Steps:</h6>
                        <ul class="list-group list-group-flush" id="subTasksList">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Analyzing audio file <small class="text-muted">(Librosa)</small></span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Extracting beat markers</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Processing image files</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Running RunwayML AI</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Generating video with FFMPEG</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Creating final output</span>
                                <span class="badge bg-secondary rounded-pill">Waiting</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="mt-4 text-center" id="cancelButtonContainer">
                        <button type="button" class="btn btn-danger" id="cancelTaskBtn">
                            <i class="bi bi-x-circle"></i> Cancel Task
                        </button>
                    </div>
                </div>
                
                <!-- Success state -->
                <div class="text-center py-4 d-none" id="successState">
                    <div class="mb-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h4>Video Generated Successfully!</h4>
                    <p class="text-muted">Your video is now ready for preview and publishing.</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="viewVideoBtn">
                            <i class="bi bi-play-circle"></i> Preview Video
                        </button>
                        <button class="btn btn-outline-primary ms-2" id="startOverBtn">
                            <i class="bi bi-arrow-repeat"></i> Generate Another Video
                        </button>
                    </div>
                </div>
                
                <!-- Error state -->
                <div class="text-center py-4 d-none" id="errorState">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                    </div>
                    <h4>Video Generation Failed</h4>
                    <p class="text-muted" id="errorMessage">An error occurred during video generation.</p>
                    <div class="mt-3">
                        <button class="btn btn-primary" id="retryBtn">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                        <button class="btn btn-outline-secondary ms-2" id="errorDetailsBtn" data-bs-toggle="modal" data-bs-target="#errorDetailsModal">
                            <i class="bi bi-info-circle"></i> Error Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Log Modal -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalLabel">Task Execution Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre class="bg-dark text-light p-3" style="max-height: 400px; overflow-y: auto;" id="taskLog">Waiting for log data...</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="copyLogBtn">
                        <i class="bi bi-clipboard"></i> Copy Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Details Modal -->
    <div class="modal fade" id="errorDetailsModal" tabindex="-1" aria-labelledby="errorDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorDetailsModalLabel">Error Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" id="errorDetailText">
                        Error information will be shown here.
                    </div>
                    <h6>Troubleshooting Suggestions:</h6>
                    <ul id="troubleshootingList">
                        <li>Check your internet connection</li>
                        <li>Ensure your files were uploaded correctly</li>
                        <li>Try selecting a different style preset</li>
                        <li>Refresh the page and try again</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="contactSupportBtn">
                        <i class="bi bi-envelope"></i> Contact Support
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Celery Progress JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initCeleryProgress();
    });

    let taskInterval;
    let startTime;
    let currentTaskId;

    function initCeleryProgress() {
        const showLogBtn = document.getElementById('showLogBtn');
        const copyLogBtn = document.getElementById('copyLogBtn');
        const cancelTaskBtn = document.getElementById('cancelTaskBtn');
        const retryBtn = document.getElementById('retryBtn');
        const viewVideoBtn = document.getElementById('viewVideoBtn');
        const startOverBtn = document.getElementById('startOverBtn');
        
        showLogBtn.addEventListener('click', function() {
            const logModal = new bootstrap.Modal(document.getElementById('logModal'));
            logModal.show();
            // Fetch the latest logs for the current task
            fetchTaskLog(currentTaskId);
        });
        
        copyLogBtn.addEventListener('click', function() {
            const logText = document.getElementById('taskLog').textContent;
            navigator.clipboard.writeText(logText).then(() => {
                alert('Log copied to clipboard!');
            });
        });
        
        cancelTaskBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this task? This action cannot be undone.')) {
                cancelTask(currentTaskId);
            }
        });
        
        retryBtn.addEventListener('click', function() {
            retryTask();
        });
        
        viewVideoBtn.addEventListener('click', function() {
            // This should open a modal or navigate to a page where the generated video can be previewed
            // For now, we'll just show a message
            alert('Video preview functionality will be implemented here.');
        });
        
        startOverBtn.addEventListener('click', function() {
            resetProgressUI();
            document.getElementById('celeryProgressSection').classList.add('d-none');
            // Scroll to the top of the page or to the file upload section
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
    }

    function showProgressSection() {
        const progressSection = document.getElementById('celeryProgressSection');
        progressSection.classList.remove('d-none');
        
        // Scroll to the progress section
        progressSection.scrollIntoView({behavior: 'smooth'});
        
        // Reset the UI
        resetProgressUI();
    }

    function resetProgressUI() {
        // Reset progress bar
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').setAttribute('aria-valuenow', '0');
        document.getElementById('progressPercentage').textContent = '0%';
        
        // Reset status text
        document.getElementById('taskStatusText').textContent = 'Initializing...';
        document.getElementById('taskIdText').textContent = 'Not started';
        document.getElementById('elapsedTimeText').textContent = '00:00';
        
        // Reset subtasks status
        const subTasksList = document.getElementById('subTasksList');
        const badges = subTasksList.querySelectorAll('.badge');
        badges.forEach(badge => {
            badge.className = 'badge bg-secondary rounded-pill';
            badge.textContent = 'Waiting';
        });
        
        // Show progress container, hide success and error states
        document.getElementById('progressContainer').classList.remove('d-none');
        document.getElementById('successState').classList.add('d-none');
        document.getElementById('errorState').classList.add('d-none');
        
        // Clear any existing interval
        if (taskInterval) {
            clearInterval(taskInterval);
            taskInterval = null;
        }
    }

    function startTaskTracking(taskId) {
        resetProgressUI();
        
        // Set the task ID
        currentTaskId = taskId;
        document.getElementById('taskIdText').textContent = taskId;
        
        // Record start time
        startTime = new Date();
        
        // Start the elapsed time counter
        taskInterval = setInterval(updateElapsedTime, 1000);
        
        // Start polling for task status
        pollTaskStatus(taskId);
    }

    function updateElapsedTime() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('elapsedTimeText').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function pollTaskStatus(taskId) {
        fetch(`/api/tasks/${taskId}/status`)
            .then(response => response.json())
            .then(data => {
                updateProgressUI(data);
                
                // Continue polling if the task is still in progress
                if (!['SUCCESS', 'FAILURE', 'REVOKED'].includes(data.status)) {
                    setTimeout(() => pollTaskStatus(taskId), 2000);
                } else {
                    // Task is complete (success or failure)
                    clearInterval(taskInterval);
                    
                    if (data.status === 'SUCCESS') {
                        showSuccessState(data);
                    } else {
                        showErrorState(data);
                    }
                }
            })
            .catch(error => {
                console.error('Error polling task status:', error);
                // Continue polling despite error unless max retries reached
                setTimeout(() => pollTaskStatus(taskId), 5000);
            });
    }

    function updateProgressUI(data) {
        // Update the progress bar
        const progress = data.progress || 0;
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        document.getElementById('progressPercentage').textContent = `${progress}%`;
        
        // Update the status text
        document.getElementById('taskStatusText').textContent = data.status_message || data.status;
        
        // Update subtasks status
        if (data.subtasks) {
            updateSubtasks(data.subtasks);
        }
    }

    function updateSubtasks(subtasks) {
        const subTasksList = document.getElementById('subTasksList');
        const listItems = subTasksList.querySelectorAll('li');
        
        subtasks.forEach((subtask, index) => {
            if (index < listItems.length) {
                const badge = listItems[index].querySelector('.badge');
                
                switch (subtask.status) {
                    case 'PENDING':
                        badge.className = 'badge bg-secondary rounded-pill';
                        badge.textContent = 'Waiting';
                        break;
                    case 'STARTED':
                        badge.className = 'badge bg-primary rounded-pill';
                        badge.textContent = 'In Progress';
                        break;
                    case 'SUCCESS':
                        badge.className = 'badge bg-success rounded-pill';
                        badge.textContent = 'Complete';
                        break;
                    case 'FAILURE':
                        badge.className = 'badge bg-danger rounded-pill';
                        badge.textContent = 'Failed';
                        break;
                    default:
                        badge.className = 'badge bg-secondary rounded-pill';
                        badge.textContent = subtask.status;
                }
            }
        });
    }

    function showSuccessState(data) {
        document.getElementById('progressContainer').classList.add('d-none');
        document.getElementById('successState').classList.remove('d-none');
        
        // Store the result data for later use
        window.taskResult = data.result;
    }

    function showErrorState(data) {
        document.getElementById('progressContainer').classList.add('d-none');
        document.getElementById('errorState').classList.remove('d-none');
        
        // Set error message
        document.getElementById('errorMessage').textContent = data.error_message || 'An error occurred during video generation.';
        
        // Set detailed error
        document.getElementById('errorDetailText').textContent = data.traceback || data.error_message || 'No detailed error information available.';
        
        // Update troubleshooting list based on the error
        updateTroubleshootingSuggestions(data);
    }

    function updateTroubleshootingSuggestions(data) {
        const troubleshootingList = document.getElementById('troubleshootingList');
        troubleshootingList.innerHTML = '';
        
        // Default suggestions
        const suggestions = [
            'Check your internet connection',
            'Ensure your files were uploaded correctly',
            'Try selecting a different style preset',
            'Refresh the page and try again'
        ];
        
        // Add specific suggestions based on error type
        if (data.error_type) {
            switch (data.error_type) {
                case 'FileNotFoundError':
                    suggestions.unshift('The uploaded file could not be found. Try uploading again.');
                    break;
                case 'APIError':
                    suggestions.unshift('There was an issue with the external API. Try again later.');
                    break;
                case 'ProcessingError':
                    suggestions.unshift('Try using a different format or smaller file size.');
                    break;
            }
        }
        
        // Add suggestions to the list
        suggestions.forEach(suggestion => {
            const li = document.createElement('li');
            li.textContent = suggestion;
            troubleshootingList.appendChild(li);
        });
    }

    function fetchTaskLog(taskId) {
        document.getElementById('taskLog').textContent = 'Fetching logs...';
        
        fetch(`/api/tasks/${taskId}/log`)
            .then(response => response.json())
            .then(data => {
                if (data.log) {
                    document.getElementById('taskLog').textContent = data.log;
                } else {
                    document.getElementById('taskLog').textContent = 'No logs available for this task.';
                }
            })
            .catch(error => {
                console.error('Error fetching task log:', error);
                document.getElementById('taskLog').textContent = 'Failed to fetch task logs. Please try again.';
            });
    }

    function cancelTask(taskId) {
        fetch(`/api/tasks/${taskId}/revoke`, {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clearInterval(taskInterval);
                    showErrorState({
                        error_message: 'Task was cancelled by user',
                        error_type: 'UserCancelled'
                    });
                } else {
                    alert('Failed to cancel task: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error cancelling task:', error);
                alert('Failed to cancel task due to a network error. Please try again.');
            });
    }

    function retryTask() {
        // This should recreate the same task with the same parameters
        // For now, we'll just reset the UI
        resetProgressUI();
        document.getElementById('celeryProgressSection').classList.add('d-none');
        
        // In a real implementation, this would restart the task with the same parameters
        alert('Retry functionality will be implemented here. This would restart the task with the same parameters.');
    }

    // Function to be called when starting a new video generation task
    function startVideoGenerationTask(videoParams) {
        showProgressSection();
        
        // Make API call to start the task
        fetch('/api/videos/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(videoParams)
        })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    startTaskTracking(data.task_id);
                } else {
                    showErrorState({
                        error_message: data.message || 'Failed to start task',
                        error_type: 'StartupError'
                    });
                }
            })
            .catch(error => {
                console.error('Error starting video generation task:', error);
                showErrorState({
                    error_message: 'Failed to start task due to a network error',
                    error_type: 'NetworkError'
                });
            });
    }

    // Expose this function globally so it can be called from other components
    window.startVideoGenerationTask = startVideoGenerationTask;

    function initVideoPreview() {
        // Platform view toggle
        const platformRadios = document.querySelectorAll('input[name="platformView"]');
        platformRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                updatePlatformView(this.value);
            });
        });
        
        // Schedule button
        const scheduleVideoBtn = document.getElementById('scheduleVideoBtn');
        const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        
        scheduleVideoBtn.addEventListener('click', function() {
            // Set default scheduled time to tomorrow at current time
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateTimeString = tomorrow.toISOString().slice(0, 16);
            document.getElementById('scheduleDatetime').value = dateTimeString;
            
            // Update platform checkboxes based on publish selection
            document.getElementById('scheduleYouTube').checked = document.getElementById('publishYouTube').checked;
            document.getElementById('scheduleTikTok').checked = document.getElementById('publishTikTok').checked;
            document.getElementById('scheduleInstagram').checked = document.getElementById('publishInstagram').checked;
            
            scheduleModal.show();
        });
        
        // Optimal time checkbox
        const useOptimalTime = document.getElementById('useOptimalTime');
        const optimalTimeSuggestions = document.getElementById('optimalTimeSuggestions');
        
        useOptimalTime.addEventListener('change', function() {
            if (this.checked) {
                optimalTimeSuggestions.classList.remove('d-none');
            } else {
                optimalTimeSuggestions.classList.add('d-none');
            }
        });
        
        // Confirm schedule button
        const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
        
        confirmScheduleBtn.addEventListener('click', function() {
            const scheduleDatetime = document.getElementById('scheduleDatetime').value;
            const useOptimal = document.getElementById('useOptimalTime').checked;
            
            const platforms = [];
            if (document.getElementById('scheduleYouTube').checked) platforms.push('youtube');
            if (document.getElementById('scheduleTikTok').checked) platforms.push('tiktok');
            if (document.getElementById('scheduleInstagram').checked) platforms.push('instagram');
            
            if (!scheduleDatetime && !useOptimal) {
                alert('Please select a date and time or use the optimal time option.');
                return;
            }
            
            if (platforms.length === 0) {
                alert('Please select at least one platform to publish to.');
                return;
            }
            
            // In a real implementation, this would call an API to schedule the video
            console.log('Scheduling video for:', scheduleDatetime);
            console.log('Use optimal time:', useOptimal);
            console.log('Platforms:', platforms);
            
            // Close the modal and show a success message
            scheduleModal.hide();
            alert('Your video has been scheduled successfully!');
        });
        
        // Generate AI metadata button
        const generateAIMetadataBtn = document.getElementById('generateAIMetadataBtn');
        
        generateAIMetadataBtn.addEventListener('click', function() {
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
            this.disabled = true;
            
            // Simulate API call delay
            setTimeout(() => {
                // Update fields with AI-generated content
                document.getElementById('videoTitle').value = 'This Beat Drop Will Give You Chills!  #shorts';
                document.getElementById('videoDescription').value = 'Watch how this music-responsive visual transforms with every beat! Created using AI technology. Like and subscribe for more amazing content like this!';
                document.getElementById('videoHashtags').value = '#shorts #musicvisualization #beatdrop #viral #trending #musicproduction';
                
                // Update preview title and caption in the platform views
                updatePlatformPreviewText();
                
                // Reset button
                this.innerHTML = '<i class="bi bi-magic"></i> Generate with AI';
                this.disabled = false;
                
                // Show success toast
                const toast = new bootstrap.Toast(document.getElementById('aiGeneratedToast'));
                toast.show();
            }, 2000);
        });
        
        // Update text fields for video info
        const videoTitle = document.getElementById('videoTitle');
        const videoDescription = document.getElementById('videoDescription');
        const videoHashtags = document.getElementById('videoHashtags');
        
        [videoTitle, videoDescription, videoHashtags].forEach(element => {
            element.addEventListener('input', updatePlatformPreviewText);
        });
        
        // Initialize with default video source
        // In a real implementation, this would be updated when a video is generated
        setPreviewVideo('/static/videos/sample-preview.mp4');
        
        // Initialize with YouTube as default platform view
        updatePlatformView('youtube');
    }

    function updatePlatformView(platform) {
        // Hide all platform frames
        document.querySelectorAll('.platform-frame').forEach(frame => {
            frame.classList.remove('active');
        });
        
        // Show the selected platform frame
        let frameId;
        switch (platform) {
            case 'tiktok':
                frameId = 'tiktokFrame';
                break;
            case 'instagram':
                frameId = 'instagramFrame';
                break;
            default:
                frameId = 'youtubeFrame';
        }
        
        document.getElementById(frameId).classList.add('active');
        
        // Update platform-specific content
        updatePlatformPreviewText();
    }

    function updatePlatformPreviewText() {
        const title = document.getElementById('videoTitle').value || 'Your video title here';
        const description = document.getElementById('videoDescription').value || 'Your video description here';
        const hashtags = document.getElementById('videoHashtags').value || '#shorts #trending #viral';
        
        // Update YouTube elements
        document.querySelector('.youtube-footer .video-title').textContent = title;
        
        // Update TikTok elements
        document.querySelector('.tiktok-caption').textContent = `${description} ${hashtags}`;
        
        // Update Instagram elements
        document.querySelector('.instagram-caption').textContent = '';
        document.querySelector('.instagram-caption').innerHTML = 
            `<span class="instagram-username">yourusername</span> ${description} ${hashtags}`;
    }

    function setPreviewVideo(videoUrl) {
        // Set the source for all platform videos
        document.getElementById('previewVideo').src = videoUrl;
        document.getElementById('tiktokVideo').src = videoUrl;
        document.getElementById('instagramVideo').src = videoUrl;
        
        // Load the videos
        document.getElementById('previewVideo').load();
        document.getElementById('tiktokVideo').load();
        document.getElementById('instagramVideo').load();
    }

    // Function to be called when a new video has been generated
    function updateVideoPreview(videoData) {
        // Show the video preview section
        document.getElementById('videoPreviewSection').classList.remove('d-none');
        
        // Scroll to the preview section
        document.getElementById('videoPreviewSection').scrollIntoView({behavior: 'smooth'});
        
        // Set the video source
        if (videoData && videoData.video_url) {
            setPreviewVideo(videoData.video_url);
        }
        
        // Update metadata if available
        if (videoData && videoData.metadata) {
            if (videoData.metadata.title) {
                document.getElementById('videoTitle').value = videoData.metadata.title;
            }
            
            if (videoData.metadata.description) {
                document.getElementById('videoDescription').value = videoData.metadata.description;
            }
            
            if (videoData.metadata.hashtags) {
                document.getElementById('videoHashtags').value = videoData.metadata.hashtags.join(' ');
            }
            
            // Update platform preview text
            updatePlatformPreviewText();
        }
    }

    // Expose this function globally so it can be called from other components
    window.updateVideoPreview = updateVideoPreview;
    </script>

    <!-- AI Generated Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="aiGeneratedToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-magic me-2 text-primary"></i>
                <strong class="me-auto">AI Generated Content</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                AI has successfully generated title, description, and hashtags for your video.
            </div>
        </div>
    </div>

    <!-- Main Integration Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        initMainApp();
    });

    // Global state
    const appState = {
        selectedMusicTrack: null,
        selectedStylePreset: null,
        selectedImages: [],
        generatedVideoId: null,
        generatedTaskId: null
    };

    function initMainApp() {
        // Hook up the generate video button
        const generateButton = document.getElementById('generateVideoBtn');
        if (generateButton) {
            generateButton.addEventListener('click', function() {
                generateMusicResponsiveVideo();
            });
        }
        
        // Hook up the publish button
        const publishButton = document.getElementById('publishVideoBtn');
        if (publishButton) {
            publishButton.addEventListener('click', function() {
                publishGeneratedVideo(false);
            });
        }
        
        // Listen for music track selection
        document.addEventListener('musicTrackSelected', function(event) {
            appState.selectedMusicTrack = event.detail;
            updateGenerateButtonState();
        });
        
        // Listen for style preset selection
        document.addEventListener('stylePresetSelected', function(event) {
            appState.selectedStylePreset = event.detail;
            updateGenerateButtonState();
        });
        
        // Initially hide video preview until a video is generated
        const videoPreviewSection = document.getElementById('videoPreviewSection');
        if (videoPreviewSection) {
            videoPreviewSection.classList.add('d-none');
        }
        
        // Initially hide progress section
        const progressSection = document.getElementById('celeryProgressSection');
        if (progressSection) {
            progressSection.classList.add('d-none');
        }
    }

    function updateGenerateButtonState() {
        const generateButton = document.getElementById('generateVideoBtn');
        if (generateButton) {
            // Enable the button only if both a music track and style preset are selected
            const canGenerate = appState.selectedMusicTrack && appState.selectedStylePreset;
            generateButton.disabled = !canGenerate;
        }
    }

    function generateMusicResponsiveVideo() {
        // Validate that we have the required selections
        if (!appState.selectedMusicTrack || !appState.selectedStylePreset) {
            alert('Please select both a music track and a style preset.');
            return;
        }
        
        // Collect image paths (in a real implementation, these would be collected from the UI)
        // For now, we'll use mock data
        const imagePaths = appState.selectedImages.length > 0 ? 
            appState.selectedImages : 
            ['/static/images/sample1.jpg', '/static/images/sample2.jpg', '/static/images/sample3.jpg'];
        
        // Prepare the video generation parameters
        const params = {
            music_track_id: appState.selectedMusicTrack.id,
            style_preset: appState.selectedStylePreset.preset,
            images: imagePaths,
            video_clips: [],
            captions_enabled: true,
            target_platforms: ["youtube"]
        };
        
        // Start the video generation task using our global function
        window.startVideoGenerationTask(params);
        
        // In a real implementation, the startVideoGenerationTask function would make an API call
        // When the task is complete, it would call updateVideoPreview with the result
        
        // For demonstration, we'll simulate a successful generation after a delay
        setTimeout(() => {
            const mockVideoData = {
                video_id: "video_" + Math.random().toString(36).substr(2, 9),
                video_url: '/static/videos/sample-preview.mp4',
                metadata: {
                    title: 'Amazing Music-Responsive Video',
                    description: 'Check out this awesome video generated with Nova Sounds Shorts Machine!',
                    hashtags: ['#shorts', '#musicvideo', '#novamachine']
                }
            };
            
            // Update the video preview
            window.updateVideoPreview(mockVideoData);
            
            // Store the generated video ID
            appState.generatedVideoId = mockVideoData.video_id;
        }, 15000); // Simulate 15 seconds of processing
    }

    function publishGeneratedVideo(schedule = false) {
        // Validate that we have a generated video
        if (!appState.generatedVideoId) {
            alert('Please generate a video first.');
            return;
        }
        
        // Get metadata from the form
        const title = document.getElementById('videoTitle').value;
        const description = document.getElementById('videoDescription').value;
        const hashtags = document.getElementById('videoHashtags').value;
        
        // Get selected platforms
        const platforms = [];
        if (document.getElementById('publishYouTube').checked) platforms.push('youtube');
        if (document.getElementById('publishTikTok').checked) platforms.push('tiktok');
        if (document.getElementById('publishInstagram').checked) platforms.push('instagram');
        
        if (platforms.length === 0) {
            alert('Please select at least one platform to publish to.');
            return;
        }
        
        // Prepare metadata
        const metadata = {
            title: title,
            description: description,
            hashtags: hashtags.split(' ').filter(tag => tag.startsWith('#'))
        };
        
        if (schedule) {
            // Show the schedule modal
            document.getElementById('scheduleVideoBtn').click();
        } else {
            // Publish immediately
            publishToSelectedPlatforms(appState.generatedVideoId, platforms, metadata);
        }
    }

    function publishToSelectedPlatforms(videoId, platforms, metadata) {
        // In a real implementation, this would make API calls to publish the video
        console.log('Publishing video:', videoId);
        console.log('To platforms:', platforms);
        console.log('With metadata:', metadata);
        
        // Show a loading indicator
        const publishButton = document.getElementById('publishVideoBtn');
        const originalText = publishButton.innerHTML;
        publishButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Publishing...';
        publishButton.disabled = true;
        
        // Simulate API call delay
        setTimeout(() => {
            // Reset the button
            publishButton.innerHTML = originalText;
            publishButton.disabled = false;
            
            // Show success message
            alert('Your video has been successfully published to ' + platforms.join(', ') + '!');
        }, 3000);
    }

    // Connect the schedule confirmation button to the publishing function
    document.addEventListener('DOMContentLoaded', function() {
        const confirmScheduleBtn = document.getElementById('confirmScheduleBtn');
        if (confirmScheduleBtn) {
            confirmScheduleBtn.addEventListener('click', function() {
                // Get scheduling info from the modal
                const scheduleDatetime = document.getElementById('scheduleDatetime').value;
                const useOptimal = document.getElementById('useOptimalTime').checked;
                
                // Get selected platforms
                const platforms = [];
                if (document.getElementById('scheduleYouTube').checked) platforms.push('youtube');
                if (document.getElementById('scheduleTikTok').checked) platforms.push('tiktok');
                if (document.getElementById('scheduleInstagram').checked) platforms.push('instagram');
                
                // Get metadata from the form
                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;
                const hashtags = document.getElementById('videoHashtags').value;
                
                // Prepare request data
                const scheduleData = {
                    video_id: appState.generatedVideoId,
                    platforms: platforms,
                    scheduled_datetime: scheduleDatetime,
                    use_optimal_time: useOptimal,
                    metadata: {
                        title: title,
                        description: description,
                        hashtags: hashtags.split(' ').filter(tag => tag.startsWith('#'))
                    }
                };
                
                // Make API call to schedule the video
                fetch('/api/scheduler/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduleData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Close the modal
                            const scheduleModal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                            scheduleModal.hide();
                            
                            // Show success message
                            alert('Your video has been scheduled successfully!');
                        } else {
                            alert('Error scheduling video: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error scheduling video:', error);
                        alert('Error scheduling video. Please try again.');
                    });
            });
        }
    });
    </script>

    <!-- Add a "Generate Video" button at the appropriate location -->
    <div class="container mt-4 text-center">
        <button type="button" class="btn btn-primary btn-lg" id="generateVideoBtn" disabled>
            <i class="bi bi-gear-wide-connected"></i> Generate Music-Responsive Video
        </button>
    </div>
    
    <!-- FullCalendar Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    
    <!-- Scheduling Calendar Component -->
    <script src="/static/js/scheduler.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the scheduling calendar when the schedule tab is shown
            const scheduleTab = document.getElementById('schedule-tab');
            if (scheduleTab) {
                scheduleTab.addEventListener('shown.bs.tab', function (e) {
                    // Initialize the calendar if it doesn't exist yet
                    if (!window.schedulerCalendar) {
                        window.schedulerCalendar = new SchedulerCalendar('schedulingCalendar', {
                            onScheduleSave: function(scheduleData) {
                                // Send the schedule data to the API
                                fetch('/api/scheduler/publish', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(scheduleData)
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'success') {
                                        alert('Your content has been scheduled successfully!');
                                        // Reload the calendar events
                                        window.schedulerCalendar.loadSchedules();
                                    } else {
                                        alert('Error scheduling content: ' + data.message);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error scheduling content:', error);
                                    alert('Error scheduling content. Please try again.');
                                });
                            }
                        });
                    }
                });
            }
        });
    </script>

    <!-- Analytics Dashboard JavaScript -->
    <script>
    // ... existing code ...
    </script>

    <!-- Analytics dashboard initialization -->
    <script>
    // ... existing code ...
    </script>

    <!-- Load analytics data -->
    <script>
    // ... existing code ...
    </script>

    <!-- Update dashboard metrics -->
    <script>
    // ... existing code ...
    </script>

    <!-- Load generated videos -->
    <script>
    // ... existing code ...
    </script>

    <!-- Initialize platform views chart -->
    <script>
    // ... existing code ...
    </script>

    <!-- Update top tracks table -->
    <script>
    // ... existing code ...
    </script>

    <!-- Update affiliate stats -->
    <script>
    // ... existing code ...
    </script>

    <!-- Helper: Format numbers with commas -->
    <script>
    // ... existing code ...
    </script>

    <!-- Helper: Get platform badge class -->
    <script>
    // ... existing code ...
    </script>

    <!-- Helper: Get platform icon -->
    <script>
    // ... existing code ...
    </script>

    <!-- Helper: Get platform color -->
    <script>
    // ... existing code ...
    </script>

    <!-- Preview video in modal -->
    <script>
    // ... existing code ...
    </script>

    <!-- Edit video metadata -->
    <script>
    // ... existing code ...
    </script>

    <!-- Republish video -->
    <script>
    // ... existing code ...
    </script>
</body>
</html>